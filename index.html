<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financiero Mansión Plast C.A</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#2563eb',
                        'primary-dark': '#1d4ed8',
                        'secondary': '#64748b',
                        'accent': '#059669',
                        'danger': '#dc2626',
                        'warning': '#d97706',
                        'success': '#16a34a',
                        'dark': '#1e293b',
                        'dark-secondary': '#334155',
                        'purple': '#7c3aed',
                        'purple-dark': '#6d28d9',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-soft': 'bounceSoft 0.6s ease-out',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSoft: {
                            '0%': { transform: 'scale(0.95)' },
                            '50%': { transform: 'scale(1.02)' },
                            '100%': { transform: 'scale(1)' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        },
                    },
                }
            }
        }
    </script>
    <script>
        // Función para formatear fecha para inputs (YYYY-MM-DD)
        function formatDateForInput(date) {
            if (!date) return '';
            const d = new Date(date);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${d.getFullYear()}-${month}-${day}`;
        }
        
        // Función para obtener la tasa de cambio actual
        function getCurrentExchangeRate() {
            const storedRate = localStorage.getItem('currentExchangeRate');
            return storedRate ? parseFloat(storedRate) : 36.50;
        }
        
        // Función para alternar la visibilidad del campo de tipo de entrada
        function toggleIncomeTypeField() {
            const medium = document.getElementById('incomeMedium').value;
            const typeField = document.getElementById('incomeTypeField');
            const bankField = document.getElementById('incomeBankField');
            if (medium === 'digital') {
                typeField.classList.remove('hidden');
                // Mostrar campos de banco si es transferencia o pago móvil
                toggleIncomeBankField();
            } else {
                typeField.classList.add('hidden');
                bankField.classList.add('hidden');
            }
        }
        
        // Función para alternar la visibilidad del campo de tipo de salida
        function toggleExpenseTypeField() {
            const medium = document.getElementById('expenseMedium').value;
            const typeField = document.getElementById('expenseTypeField');
            const bankField = document.getElementById('expenseBankField');
            if (medium === 'digital') {
                typeField.classList.remove('hidden');
                // Mostrar campos de banco si es transferencia o pago móvil
                toggleExpenseBankField();
            } else {
                typeField.classList.add('hidden');
                bankField.classList.add('hidden');
            }
        }
        
        // Función para alternar campo de banco en entrada
        function toggleIncomeBankField() {
            const type = document.getElementById('incomeType').value;
            const bankField = document.getElementById('incomeBankField');
            if (type === 'transferencia' || type === 'pago_movil') {
                bankField.classList.remove('hidden');
            } else {
                bankField.classList.add('hidden');
            }
        }
        
        // Función para alternar campo de banco en salida
        function toggleExpenseBankField() {
            const type = document.getElementById('expenseType').value;
            const bankField = document.getElementById('expenseBankField');
            if (type === 'transferencia' || type === 'pago_movil') {
                bankField.classList.remove('hidden');
            } else {
                bankField.classList.add('hidden');
            }
        }
        
        // Función para cambiar entre pestañas de moneda en reportes
        function switchCurrencyTab(currency) {
            // Remover clase active de todas las pestañas
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Agregar clase active a la pestaña seleccionada
            document.getElementById(`tab-${currency}`).classList.add('active');
            
            // Actualizar los datos mostrados según la moneda seleccionada
            generateReport(currency);
        }
        
        // Función global para validar y permitir pagos
        function validateAndEnablePayment() {
            return true; // Siempre permitir todos los métodos de pago
        }
        
        // Corrigiendo el problema con el procesamiento de pagos en VES y efectivo
        document.addEventListener('DOMContentLoaded', function() {
            // Asegurar que todos los tipos de pago funcionen correctamente
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
            if (confirmPaymentBtn) {
                // Remover cualquier bloqueo al botón
                confirmPaymentBtn.disabled = false;
            }
            
            // Evento para cambios en la moneda y método de pago
            const paymentCurrencySelect = document.getElementById('paymentCurrency');
            const paymentMethodSelect = document.getElementById('paymentMethod');
            
            if (paymentCurrencySelect && paymentMethodSelect) {
                const enablePaymentButton = function() {
                    // Siempre habilitar el botón independientemente del método o moneda
                    if (confirmPaymentBtn) {
                        confirmPaymentBtn.disabled = false;
                        confirmPaymentBtn.style.opacity = '1';
                        confirmPaymentBtn.style.cursor = 'pointer';
                    }
                };
                
                paymentCurrencySelect.addEventListener('change', enablePaymentButton);
                paymentMethodSelect.addEventListener('change', enablePaymentButton);
                
                // Habilitar inmediatamente al cargar
                enablePaymentButton();
            }
            
            // Hacer lo mismo para el pago completo
            const fullPaymentForm = document.getElementById('fullPaymentForm');
            if (fullPaymentForm) {
                fullPaymentForm.addEventListener('submit', function(e) {
                    // Permitir todos los métodos de pago sin restricciones
                    return true;
                });
            }
            
            // Inicializar la pestaña "Todos" en reportes
            const tabAllButton = document.getElementById('tab-all');
            if (tabAllButton) {
                tabAllButton.classList.add('active');
            }
        });
        
        // Función para generar reportes separados por moneda
        function generateReport(currencyFilter) {
            // Si no se proporciona un filtro de moneda, usar 'all'
            currencyFilter = currencyFilter || 'all';
            
            // Calcular datos reales desde las transacciones existentes
            const exchangeRate = getCurrentExchangeRate();
            
            // Obtener datos reales de transacciones
            const usdData = calculateReportData('USD');
            const vesData = calculateReportData('VES');
            
            // Formatear valores para mostrar en la interfaz
            const formatUSD = (value) => `$${value.toFixed(2)}`;
            const formatVES = (value) => `Bs. ${value.toFixed(2)}`;
            
            // Actualizar los campos según el filtro seleccionado
            if (currencyFilter === 'all' || currencyFilter === 'usd') {
                document.getElementById('incomeUSD').textContent = formatUSD(usdData.income);
                document.getElementById('expensesUSD').textContent = formatUSD(usdData.expenses);
                document.getElementById('balanceUSD').textContent = formatUSD(usdData.balance);
                document.getElementById('usdPaymentCount').textContent = usdData.paymentCount;
                document.getElementById('entriesUSD').textContent = formatUSD(usdData.entries);
                document.getElementById('expensesUSD2').textContent = formatUSD(usdData.exits);
                document.getElementById('receivableUSD').textContent = formatUSD(usdData.receivable);
                document.getElementById('payableUSD').textContent = formatUSD(usdData.payable);
            }
            
            if (currencyFilter === 'all' || currencyFilter === 'ves') {
                document.getElementById('incomeVES').textContent = formatVES(vesData.income);
                document.getElementById('expensesVES').textContent = formatVES(vesData.expenses);
                document.getElementById('balanceVES').textContent = formatVES(vesData.balance);
                document.getElementById('vesPaymentCount').textContent = vesData.paymentCount;
                document.getElementById('entriesVES').textContent = formatVES(vesData.entries);
                document.getElementById('expensesVES2').textContent = formatVES(vesData.exits);
                document.getElementById('receivableVES').textContent = formatVES(vesData.receivable);
                document.getElementById('payableVES').textContent = formatVES(vesData.payable);
            }
            
            // Actualizar los totales
            if (currencyFilter === 'all') {
                // Convertir VES a USD para el total general
                const vesInUSD = vesData.income / exchangeRate;
                const vesExpensesInUSD = vesData.expenses / exchangeRate;
                
                const totalIncome = usdData.income + vesInUSD;
                const totalExpenses = usdData.expenses + vesExpensesInUSD;
                const totalBalance = totalIncome - totalExpenses;
                
                document.getElementById('totalIncome').textContent = formatUSD(totalIncome);
                document.getElementById('totalExpenses').textContent = formatUSD(totalExpenses);
                document.getElementById('balance').textContent = formatUSD(totalBalance);
                
                // Pendientes (combinado)
                const totalPendingUSD = usdData.receivable - usdData.payable;
                const totalPendingVES = (vesData.receivable - vesData.payable) / exchangeRate;
                document.getElementById('pendingAmount').textContent = formatUSD(totalPendingUSD + totalPendingVES);
            } else if (currencyFilter === 'usd') {
                document.getElementById('totalIncome').textContent = formatUSD(usdData.income);
                document.getElementById('totalExpenses').textContent = formatUSD(usdData.expenses);
                document.getElementById('balance').textContent = formatUSD(usdData.balance);
                document.getElementById('pendingAmount').textContent = formatUSD(usdData.receivable - usdData.payable);
            } else if (currencyFilter === 'ves') {
                document.getElementById('totalIncome').textContent = formatVES(vesData.income);
                document.getElementById('totalExpenses').textContent = formatVES(vesData.expenses);
                document.getElementById('balance').textContent = formatVES(vesData.balance);
                document.getElementById('pendingAmount').textContent = formatVES(vesData.receivable - vesData.payable);
            }
        }
        
        // Función para calcular datos reales de reportes desde transacciones
        function calculateReportData(currency) {
            if (!transactions) {
                return {
                    income: 0,
                    expenses: 0,
                    balance: 0,
                    entries: 0,
                    exits: 0,
                    receivable: 0,
                    payable: 0,
                    paymentCount: 0
                };
            }
            
            // Filtrar transacciones por moneda
            const currencyTransactions = transactions.filter(t => t.currency === currency);
            const currencyPayments = paymentHistory ? paymentHistory.filter(p => p.currency === currency) : [];
            
            let income = 0;
            let expenses = 0;
            let entries = 0;
            let exits = 0;
            let receivable = 0;
            let payable = 0;
            let paymentCount = currencyPayments.length;
            
            // Calcular desde transacciones
            currencyTransactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount) || 0;
                
                switch(transaction.type) {
                    case 'income':
                        income += amount;
                        entries += amount;
                        break;
                    case 'expense':
                        expenses += amount;
                        exits += amount;
                        break;
                    case 'receivable':
                        if (transaction.status === 'paid') {
                            income += amount;
                        } else {
                            receivable += calculateRemainingAmount(transaction);
                        }
                        break;
                    case 'payable':
                        if (transaction.status === 'paid') {
                            expenses += amount;
                        } else {
                            payable += calculateRemainingAmount(transaction);
                        }
                        break;
                }
            });
            
            // Calcular balance
            const balance = income - expenses;
            
            return {
                income,
                expenses,
                balance,
                entries,
                exits,
                receivable,
                payable,
                paymentCount
            };
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        body { 
            font-family: 'Inter', sans-serif;
            font-size: 16px; /* Aumentar tamaño base */
            transition: all 0.3s ease;
        }
        
        /* Aumentar tamaños de texto generales */
        .text-xs { font-size: 14px; } /* Era 12px */
        .text-sm { font-size: 16px; } /* Era 14px */
        .text-base { font-size: 18px; } /* Era 16px */
        .text-lg { font-size: 20px; } /* Era 18px */
        .text-xl { font-size: 22px; } /* Era 20px */
        .text-2xl { font-size: 26px; } /* Era 24px */
        .text-3xl { font-size: 32px; } /* Era 30px */
        
        /* Ajustar inputs y selects */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Ajustar tablas */
        table {
            font-size: 16px;
        }
        
        /* Ajustar botones */
        button {
            font-size: 16px;
        }
        
        .dark-mode {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #e2e8f0;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode .glass-effect {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .gradient-bg {
            background: var(--gradient-1);
        }
        
        .card-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dark-mode .card-modern {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .card-modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .calculator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode .calculator {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .amount-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            font-size: 1.5rem !important;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .amount-input:focus {
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--color-from), var(--color-to));
            color: white;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
        }
        
        .table-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .table-modern {
            background: rgba(30, 41, 59, 0.8);
        }
        
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: rgba(59, 130, 246, 0.05);
            transform: scale(1.01);
        }
        
        .badge-modern {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tab-button {
            position: relative;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: #3b82f6;
            border-radius: 2px;
        }
        
        .form-modern input, .form-modern select, .form-modern textarea {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .dark-mode .form-modern input, 
        .dark-mode .form-modern select, 
        .dark-mode .form-modern textarea {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }
        
        .form-modern input:focus, 
        .form-modern select:focus, 
        .form-modern textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .currency-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode .currency-display {
            color: #f1f5f9;
        }
        
        .status-pending { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); }
        .status-cancelled { background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .slide-fade-enter {
            animation: slideUp 0.3s ease-out;
        }
        
        .pulse-ring {
            position: relative;
        }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen transition-all duration-300" id="mainBody">
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="fixed top-4 left-4 z-50 p-3 rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-gray-700 hover:bg-white/30 transition-all duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 flex items-center space-x-4">
            <div class="loading-spinner"></div>
            <span class="text-gray-700 font-medium">Procesando...</span>
        </div>
    </div>
    
    <!-- Exchange Rate Update Modal -->
    <div id="exchangeRateUpdateModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="card-modern max-w-md w-full mx-4 animate-bounce-soft">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-5">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path>
                    </svg>
                    Actualizar Tasa de Cambio
                </h3>
                <p class="text-blue-100">Inicie el día con la tasa actualizada</p>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="text-center">
                    <p class="text-gray-600">Buen día, por favor ingrese la tasa de cambio actual para iniciar operaciones.</p>
                    <div class="font-bold text-2xl text-blue-800 mt-2 flex items-center justify-center">
                        <span>Tasa actual:</span>
                        <span id="currentRateDisplay" class="ml-2"></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Última actualización: <span id="lastRateUpdateDate">Nunca</span></p>
                </div>
                
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Nueva Tasa USD → VES</label>
                    <input type="number" id="dailyExchangeRateInput" step="0.01" class="w-full px-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="0.00">
                </div>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-2xl">
                <button onclick="skipExchangeRateUpdate()" class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500 transition-all font-semibold">
                    Omitir
                </button>
                <button onclick="saveDailyExchangeRate()" class="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all font-semibold flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Confirmation Modal -->
    <div id="paymentConfirmationModal" class="fixed inset-0 modal-overlay flex items-start justify-center pt-0 sm:pt-4 pb-0 sm:pb-20 z-50 hidden overflow-y-auto">
        <div class="card-modern max-w-lg w-full h-full sm:h-auto mx-auto my-0 sm:my-4 animate-bounce-soft relative sm:rounded-2xl">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-4 sm:px-6 py-3 sm:py-5 sticky top-0 z-10 flex items-center justify-between">
                <div>
                    <h3 class="text-lg sm:text-xl font-bold text-white flex items-center">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                        </svg>
                        Confirmar Abono de Pago
                    </h3>
                    <p class="text-blue-100 text-xs sm:text-sm">Revise los detalles antes de procesar el abono</p>
                </div>
                <button onclick="closePaymentConfirmationModal()" class="text-white/70 hover:text-white p-2 -mr-2 sm:hidden">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            
            <div class="p-4 sm:p-6 space-y-4 sm:space-y-5 overflow-y-auto max-h-[calc(100vh-180px)] sm:max-h-[60vh]">
                <!-- Transaction Info -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        📄 Información de la Factura
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Número de Factura:</span>
                            <div class="font-semibold text-gray-800" id="confirmInvoiceNumber"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">Proveedor:</span>
                            <div class="font-semibold text-gray-800" id="confirmProvider"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">Monto Original:</span>
                            <div class="font-semibold text-gray-800" id="confirmOriginalAmount"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">Monto Pendiente:</span>
                            <div class="font-semibold text-gray-800" id="confirmRemainingAmount"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Details -->
                <div class="bg-blue-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        💳 Detalles del Abono
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-700">Monto a Abonar:</span>
                            <div class="font-bold text-xl text-blue-800" id="confirmPaymentAmount"></div>
                        </div>
                        <div class="flex justify-between items-center" id="confirmConversionRow">
                            <span class="text-blue-700">Equivalente:</span>
                            <div class="font-semibold text-blue-700" id="confirmConversionAmount"></div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-700">Método de Pago:</span>
                            <div class="font-semibold text-blue-800" id="confirmPaymentMethod"></div>
                        </div>
                        <div class="flex justify-between items-center hidden" id="confirmReferenceRow">
                            <span class="text-blue-700">Referencia:</span>
                            <div class="font-semibold text-blue-800" id="confirmReference"></div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-700">Tasa de Cambio:</span>
                            <div class="font-semibold text-blue-800" id="confirmExchangeRate"></div>
                        </div>
                    </div>
                </div>
                
                <!-- After Payment Summary -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                        📊 Después del Abono
                    </h4>
                    <div class="flex justify-between items-center">
                        <span class="text-green-700">Monto Restante:</span>
                        <div class="font-bold text-lg text-green-800" id="confirmNewRemaining"></div>
                    </div>
                    <div class="mt-2 text-sm text-green-600" id="confirmPaymentStatus"></div>
                </div>
                
                <!-- Warning if applicable -->
                <div id="confirmWarning" class="bg-amber-50 border border-amber-200 rounded-xl p-4 hidden">
                    <div class="flex items-center text-amber-800">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span id="confirmWarningText"></span>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 flex justify-between sm:justify-end space-x-2 sm:space-x-3 sticky bottom-0 z-10 border-t border-gray-200">
                <button onclick="closePaymentConfirmationModal()" class="flex-1 sm:flex-initial px-4 py-3 sm:py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-semibold text-sm sm:text-base">
                    Cancelar
                </button>
                <button onclick="confirmPaymentProcessing()" class="flex-1 sm:flex-initial px-4 py-3 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-semibold text-sm sm:text-base" id="confirmPaymentBtn">
                    <span class="flex items-center justify-center space-x-1 sm:space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span>Confirmar Abono</span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="calculator w-80 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Calculadora de Conversión</h3>
                <button onclick="closeCalculator()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
                    <input type="number" id="calcAmount" class="amount-input w-full p-3" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tasa de Cambio</label>
                    <input type="number" id="calcRate" class="amount-input w-full p-3" value="36.5" step="0.01">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="convertToVES()" class="btn-modern bg-blue-500 text-white p-3 rounded-xl font-medium hover:bg-blue-600">
                        USD → VES
                    </button>
                    <button onclick="convertToUSD()" class="btn-modern bg-green-500 text-white p-3 rounded-xl font-medium hover:bg-green-600">
                        VES → USD
                    </button>
                </div>
                <div id="calcResult" class="text-center p-4 bg-gray-100 rounded-xl hidden">
                    <div class="text-2xl font-bold text-gray-800" id="calcResultAmount"></div>
                    <div class="text-sm text-gray-600" id="calcResultText"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-indigo-800 relative overflow-hidden">
        <!-- Animated background elements -->
        <div class="absolute inset-0 overflow-hidden opacity-20">
            <div class="absolute w-96 h-96 bg-white/20 rounded-full top-1/4 -left-20 animate-pulse-soft" style="animation-delay: 0s;"></div>
            <div class="absolute w-96 h-96 bg-white/10 rounded-full bottom-1/4 -right-20 animate-pulse-soft" style="animation-delay: 1s;"></div>
            <div class="absolute w-64 h-64 bg-indigo-500/20 rounded-full top-3/4 left-1/3 animate-pulse-soft" style="animation-delay: 2s;"></div>
        </div>
        <div class="glass-effect rounded-3xl shadow-2xl p-10 w-full max-w-md animate-fade-in border border-white/30 backdrop-blur-lg">
            <div class="text-center mb-10">
                <div class="mx-auto mb-6 transform transition-all duration-700 hover:scale-105">
                    <img src="logo.png" alt="Logo Mansión Plast C.A" class="h-32 mx-auto object-contain max-w-full drop-shadow-lg">
                </div>
                <h1 class="text-3xl font-bold text-white mb-2 animate-pulse-soft drop-shadow-md">Sistema Financiero</h1>
                <h2 class="text-xl font-semibold text-white/90 tracking-wide drop-shadow-sm">Mansión Plast C.A</h2>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div class="relative">
                    <label class="block text-white text-sm font-semibold mb-3">Usuario</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <input type="text" id="username" required
                            class="w-full pl-12 pr-5 py-4 bg-white/10 border border-white/20 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-400/70 focus:border-transparent transition-all text-white placeholder-white/60 shadow-inner"
                            placeholder="Ingrese su usuario">
                    </div>
                </div>
                <div class="relative">
                    <label class="block text-white text-sm font-semibold mb-3">Contraseña</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <input type="password" id="password" required
                            class="w-full pl-12 pr-5 py-4 bg-white/10 border border-white/20 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-400/70 focus:border-transparent transition-all text-white placeholder-white/60 shadow-inner"
                            placeholder="Ingrese su contraseña">
                    </div>
                </div>
                <div id="loginError" class="text-red-200 text-sm text-center hidden bg-red-500/20 p-3 rounded-xl"></div>
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-4 rounded-2xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 font-semibold text-lg btn-modern shadow-lg transform hover:scale-[1.02] active:scale-[0.98] border border-white/10">
                    <span class="flex items-center justify-center space-x-2">
                        <span>Iniciar Sesión</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-40 border-b border-white/20">
            <nav class="container mx-auto px-4 py-2">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 flex items-center justify-center transition-transform duration-300 hover:scale-105">
                            <img src="logo.png" alt="Logo Mansión Plast C.A" class="h-10 object-contain">
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Mansión Plast C.A</h1>
                            <div class="flex items-center space-x-2">
                                <p class="text-sm text-green-600 font-semibold" id="welcomeMessage">Bienvenido</p>
                                <div class="flex items-center space-x-1 bg-green-50 px-3 py-1.5 rounded">
                                    <span class="text-sm text-green-700">💱</span>
                                    <span class="text-sm font-bold text-green-800" id="currentExchangeRate">36.50</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="openCalculator()" class="p-1.5 rounded bg-blue-500/10 text-blue-600 hover:bg-blue-500/20 transition-all" title="Calculadora">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                        <div class="flex items-center space-x-1 bg-white/10 backdrop-blur-md rounded px-3 py-1.5">
                            <div class="w-7 h-7 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-bold" id="userInitial"></span>
                            </div>
                            <span id="userInfo" class="text-sm font-medium text-gray-700"></span>
                        </div>
                        <button id="logoutBtn" class="px-3 py-1.5 bg-red-500/10 text-red-600 rounded hover:bg-red-500/20 transition-all text-sm font-medium">
                            Salir
                        </button>
                    </div>
                </div>
                
                <!-- Navigation Menu -->
                <div class="mt-2 flex flex-wrap gap-1" id="navigationMenu">
                    <button onclick="showPage('list')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="list">
                        <span class="flex items-center space-x-1">
                            <span>📋</span>
                            <span>Transacciones</span>
                        </span>
                    </button>
                    <button onclick="showPage('add')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="add">
                        <span class="flex items-center space-x-1">
                            <span>➕</span>
                            <span>Agregar</span>
                        </span>
                    </button>
                    <button onclick="showPage('income')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="income">
                        <span class="flex items-center space-x-1">
                            <span>📈</span>
                            <span>Entradas</span>
                        </span>
                    </button>
                    <button onclick="showPage('expense')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="expense">
                        <span class="flex items-center space-x-1">
                            <span>📉</span>
                            <span>Salidas</span>
                        </span>
                    </button>
                    <button onclick="showPage('providers')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="providers">
                        <span class="flex items-center space-x-1">
                            <span>🏢</span>
                            <span>Proveedores</span>
                        </span>
                    </button>
                    <button onclick="showPage('search')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="search">
                        <span class="flex items-center space-x-1">
                            <span>🔍</span>
                            <span>Buscar</span>
                        </span>
                    </button>
                    <button onclick="showPage('payment')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="payment">
                        <span class="flex items-center space-x-1">
                            <span>💳</span>
                            <span>Abonar</span>
                        </span>
                    </button>
                    <button onclick="showPage('fullPayment')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="fullPayment">
                        <span class="flex items-center space-x-1">
                            <span>💰</span>
                            <span>Pagar Completo</span>
                        </span>
                    </button>
                    <button onclick="showPage('reports')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all" data-page="reports">
                        <span class="flex items-center space-x-1">
                            <span>📊</span>
                            <span>Reportes</span>
                        </span>
                    </button>
                    <button onclick="showPage('migration')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all master-only hidden" data-page="migration">
                        <span class="flex items-center space-x-1">
                            <span>🔄</span>
                            <span>Migración</span>
                        </span>
                    </button>
                    <button onclick="showPage('users')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all master-only hidden" data-page="users">
                        <span class="flex items-center space-x-1">
                            <span>👥</span>
                            <span>Usuarios</span>
                        </span>
                    </button>
                    <button onclick="showPage('settings')" class="nav-btn px-3 py-2 rounded text-base font-semibold transition-all master-only hidden" data-page="settings">
                        <span class="flex items-center space-x-1">
                            <span>⚙️</span>
                            <span>Configuración</span>
                        </span>
                    </button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-6 min-h-screen">            <!-- Transaction List Page -->
            <div id="listPage" class="page-content">
                <div class="card-modern p-8 animate-fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Lista de Transacciones</h2>
                            <p class="text-gray-600">Gestiona todas las transacciones financieras</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="exportTransactions()" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all text-base font-medium shadow-lg">
                                <span class="flex items-center space-x-2">
                                    <span>📤</span>
                                    <span>Exportar</span>
                                </span>
                            </button>
                            <button onclick="loadTransactions()" class="btn-modern px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all text-base font-medium shadow-lg">
                                <span class="flex items-center space-x-2">
                                    <span>🔄</span>
                                    <span>Actualizar</span>
                                </span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="stats-card" style="--color-from: #3b82f6; --color-to: #1d4ed8;">
                            <div class="relative z-10">
                                <div class="text-base opacity-90 mb-1">Total Transacciones</div>
                                <div class="text-4xl font-bold mb-1" id="totalTransactions">0</div>
                                <div class="text-sm opacity-75">Registradas</div>
                            </div>
                        </div>
                        <div class="stats-card" style="--color-from: #10b981; --color-to: #059669;">
                            <div class="relative z-10">
                                <div class="text-base opacity-90 mb-1">Pagadas</div>
                                <div class="text-4xl font-bold mb-1" id="paidTransactions">0</div>
                                <div class="text-sm opacity-75">Completadas</div>
                            </div>
                        </div>
                        <div class="stats-card" style="--color-from: #f59e0b; --color-to: #d97706;">
                            <div class="relative z-10">
                                <div class="text-sm opacity-90 mb-1">Pendientes</div>
                                <div class="text-3xl font-bold mb-1" id="pendingTransactions">0</div>
                                <div class="text-xs opacity-75">Por procesar</div>
                            </div>
                        </div>
                        <div class="stats-card" style="--color-from: #8b5cf6; --color-to: #7c3aed;">
                            <div class="relative z-10">
                                <div class="text-sm opacity-90 mb-1">Anuladas</div>
                                <div class="text-3xl font-bold mb-1" id="annulledTransactions">0</div>
                                <div class="text-xs opacity-75">Canceladas</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                                <input type="text" id="searchFilter" placeholder="Número de factura..."
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       onkeyup="filterTransactions()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                                <select id="statusFilter" onchange="filterTransactions()"
                                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Todos</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="paid">Pagadas</option>
                                    <option value="annulled">Anuladas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                                <select id="typeFilter" onchange="filterTransactions()"
                                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Todos</option>
                                    <option value="payable">Por Pagar</option>
                                    <option value="receivable">Por Cobrar</option>
                                    <option value="income">💰 Entradas</option>
                                    <option value="expense">💸 Salidas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Moneda</label>
                                <select id="currencyFilter" onchange="filterTransactions()"
                                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Todas</option>
                                    <option value="USD">USD</option>
                                    <option value="VES">VES</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transactions Table -->
                    <div class="table-modern">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Proveedor</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Pendiente</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsList" class="divide-y divide-gray-200">
                                    <!-- Transactions will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Transaction Page -->
            <div id="addPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Agregar Nueva Transacción</h2>
                        <p class="text-gray-600">Registra una nueva transacción en el sistema</p>
                    </div>
                    
                    <form id="addTransactionForm" class="form-modern space-y-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Número de Factura</label>
                                    <input type="text" id="invoiceNumber" required
                                           class="w-full" placeholder="Ej: INV-2024-001">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Tipo de Transacción</label>
                                    <select id="transactionType" required class="w-full">
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="payable">💸 Por Pagar</option>
                                        <option value="receivable">💰 Por Cobrar</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Proveedor</label>
                                    <select id="providerId" required class="w-full">
                                        <option value="">Seleccionar proveedor...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Forma de Pago</label>
                                    <select id="paymentType" required class="w-full">
                                        <option value="cash">💵 Efectivo</option>
                                        <option value="cash_usd">💲 Efectivo USD</option>
                                        <option value="bank">🏦 Transferencia</option>
                                        <option value="mobile">📱 Pago Móvil</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-3">Moneda</label>
                                        <select id="currency" required class="w-full">
                                            <option value="USD">🇺🇸 USD - Dólares</option>
                                            <option value="VES">🇻🇪 VES - Bolívares</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-3">Monto</label>
                                        <input type="number" id="amount" step="0.01" required class="w-full" placeholder="0.00">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Fecha</label>
                                    <input type="date" id="transactionDate" required class="w-full">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Descripción</label>
                                    <textarea id="description" rows="4" required class="w-full"
                                              placeholder="Describe los detalles de la transacción..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200">
                            <button type="submit" 
                                    class="flex-1 btn-modern bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>💾</span>
                                    <span>Guardar Transacción</span>
                                </span>
                            </button>
                            <button type="button" onclick="showPage('list')"
                                    class="sm:w-auto px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Income Page -->
            <div id="incomePage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Registrar Entrada</h2>
                        <p class="text-gray-600">Registra ingresos directos que aumentan el balance general</p>
                    </div>
                    
                    <form id="incomeForm" class="form-modern space-y-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Monto</label>
                                    <input type="number" id="incomeAmount" step="0.01" required class="w-full" placeholder="0.00">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Moneda</label>
                                    <select id="incomeCurrency" required class="w-full">
                                        <option value="USD">🇺🇸 USD - Dólares</option>
                                        <option value="VES">🇻🇪 VES - Bolívares</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Medio de Entrada</label>
                                    <select id="incomeMedium" required class="w-full" onchange="toggleIncomeTypeField()">
                                        <option value="fisico">💵 Físico</option>
                                        <option value="digital">💻 Digital</option>
                                    </select>
                                </div>
                                
                                <div id="incomeTypeField" class="hidden">
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Tipo de Entrada</label>
                                    <select id="incomeType" class="w-full" onchange="toggleIncomeBankField()">
                                        <option value="pago_movil">📱 Pago Móvil</option>
                                        <option value="transferencia">🏦 Transferencia</option>
                                        <option value="punto">💳 Punto de Venta</option>
                                    </select>
                                </div>
                                
                                <div id="incomeBankField" class="hidden">
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Banco</label>
                                    <select id="incomeBank" class="w-full">
                                        <option value="mercantil">🏦 Banco Mercantil</option>
                                        <option value="venezuela">🏦 Banco de Venezuela</option>
                                        <option value="banesco">🏦 Banco Banesco</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Fecha de Transacción</label>
                                    <input type="date" id="incomeDate" required class="w-full">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Descripción</label>
                                    <textarea id="incomeDescription" rows="4" required class="w-full"
                                              placeholder="Describe el origen del ingreso..."></textarea>
                                </div>
                                
                                <div id="incomeReferenceField">
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Número de Referencia</label>
                                    <input type="text" id="incomeReference" class="w-full" placeholder="Ej: ING-2024-001">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Tasa de Cambio</label>
                                    <input type="number" id="incomeExchangeRate" step="0.01" class="w-full" placeholder="36.50" value="36.50">
                                    <p class="text-xs text-gray-500 mt-1">Tasa USD → VES para cálculos de conversión</p>
                                </div>

                            </div>
                        </div>
                        
                        <!-- Preview Section -->
                        <div id="incomePreview" class="hidden p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-2xl border border-blue-200 animate-slide-up">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">👁️</span>
                                Previsualización de Entrada
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Monto:</span>
                                    <div class="font-semibold text-gray-800" id="previewIncomeAmount"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Moneda:</span>
                                    <div class="font-semibold text-gray-800" id="previewIncomeCurrency"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Medio:</span>
                                    <div class="font-semibold text-gray-800" id="previewIncomeMedium"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Tipo:</span>
                                    <div class="font-semibold text-gray-800" id="previewIncomeType"></div>
                                </div>
                                <div id="previewIncomeBankRow" class="hidden">
                                    <span class="text-gray-600">Banco:</span>
                                    <div class="font-semibold text-gray-800" id="previewIncomeBank"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Fecha:</span>
                                    <div class="font-semibold text-gray-800" id="previewIncomeDate"></div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-gray-600">Descripción:</span>
                                <div class="font-semibold text-gray-800" id="previewIncomeDescription"></div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" onclick="showIncomePreview()" 
                                    class="flex-1 btn-modern bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>👁️</span>
                                    <span>Previsualizar</span>
                                </span>
                            </button>
                            <button type="submit" id="confirmIncomeBtn" style="display: none;"
                                    class="flex-1 btn-modern bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>📈</span>
                                    <span>Confirmar Entrada</span>
                                </span>
                            </button>
                            <button type="button" onclick="showPage('list')"
                                    class="sm:w-auto px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Expense Page -->
            <div id="expensePage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Registrar Salida</h2>
                        <p class="text-gray-600">Registra gastos directos que disminuyen el balance general</p>
                    </div>
                    
                    <form id="expenseForm" class="form-modern space-y-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Monto</label>
                                    <input type="number" id="expenseAmount" step="0.01" required class="w-full" placeholder="0.00">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Moneda</label>
                                    <select id="expenseCurrency" required class="w-full">
                                        <option value="USD">🇺🇸 USD - Dólares</option>
                                        <option value="VES">🇻🇪 VES - Bolívares</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Medio de Salida</label>
                                    <select id="expenseMedium" required class="w-full" onchange="toggleExpenseTypeField()">
                                        <option value="fisico">💵 Físico</option>
                                        <option value="digital">💻 Digital</option>
                                    </select>
                                </div>
                                
                                <div id="expenseTypeField" class="hidden">
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Tipo de Salida</label>
                                    <select id="expenseType" class="w-full" onchange="toggleExpenseBankField()">
                                        <option value="pago_movil">📱 Pago Móvil</option>
                                        <option value="transferencia">🏦 Transferencia</option>
                                        <option value="punto">💳 Punto de Venta</option>
                                    </select>
                                </div>
                                
                                <div id="expenseBankField" class="hidden">
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Banco</label>
                                    <select id="expenseBank" class="w-full">
                                        <option value="mercantil">🏦 Banco Mercantil</option>
                                        <option value="venezuela">🏦 Banco de Venezuela</option>
                                        <option value="banesco">🏦 Banco Banesco</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Fecha de Transacción</label>
                                    <input type="date" id="expenseDate" required class="w-full">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Descripción</label>
                                    <textarea id="expenseDescription" rows="4" required class="w-full"
                                              placeholder="Describe el gasto realizado..."></textarea>
                                </div>
                                
                                <div id="expenseReferenceField">
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Número de Referencia</label>
                                    <input type="text" id="expenseReference" class="w-full" placeholder="Ej: GAS-2024-001">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Tasa de Cambio</label>
                                    <input type="number" id="expenseExchangeRate" step="0.01" class="w-full" placeholder="36.50" value="36.50">
                                    <p class="text-xs text-gray-500 mt-1">Tasa USD → VES para cálculos de conversión</p>
                                </div>

                            </div>
                        </div>
                        
                        <!-- Preview Section -->
                        <div id="expensePreview" class="hidden p-6 bg-gradient-to-r from-red-50 to-orange-50 rounded-2xl border border-red-200 animate-slide-up">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">👁️</span>
                                Previsualización de Salida
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Monto:</span>
                                    <div class="font-semibold text-gray-800" id="previewExpenseAmount"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Moneda:</span>
                                    <div class="font-semibold text-gray-800" id="previewExpenseCurrency"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Medio:</span>
                                    <div class="font-semibold text-gray-800" id="previewExpenseMedium"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Tipo:</span>
                                    <div class="font-semibold text-gray-800" id="previewExpenseType"></div>
                                </div>
                                <div id="previewExpenseBankRow" class="hidden">
                                    <span class="text-gray-600">Banco:</span>
                                    <div class="font-semibold text-gray-800" id="previewExpenseBank"></div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Fecha:</span>
                                    <div class="font-semibold text-gray-800" id="previewExpenseDate"></div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-gray-600">Descripción:</span>
                                <div class="font-semibold text-gray-800" id="previewExpenseDescription"></div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" onclick="showExpensePreview()" 
                                    class="flex-1 btn-modern bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>👁️</span>
                                    <span>Previsualizar</span>
                                </span>
                            </button>
                            <button type="submit" id="confirmExpenseBtn" style="display: none;"
                                    class="flex-1 btn-modern bg-gradient-to-r from-red-500 to-red-600 text-white py-4 rounded-xl hover:from-red-600 hover:to-red-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>📉</span>
                                    <span>Confirmar Salida</span>
                                </span>
                            </button>
                            <button type="button" onclick="showPage('list')"
                                    class="sm:w-auto px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Provider Management Page -->
            <div id="providersPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Proveedores</h2>
                            <p class="text-gray-600">Administra la información de todos los proveedores</p>
                        </div>
                        <button onclick="showAddProviderForm()" class="btn-modern px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 font-semibold shadow-lg">
                            <span class="flex items-center space-x-2">
                                <span>➕</span>
                                <span>Nuevo Proveedor</span>
                            </span>
                        </button>
                    </div>
                    
                    <div id="addProviderForm" class="hidden mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 animate-slide-up">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Agregar Nuevo Proveedor</h3>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                            <input type="text" id="newProviderName" placeholder="Nombre del proveedor..."
                                   class="flex-1 px-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <button onclick="addProvider()" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold">
                                Agregar
                            </button>
                            <button onclick="hideAddProviderForm()" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="providersList">
                        <!-- Providers will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Search Page -->
            <div id="searchPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Buscar Facturas</h2>
                        <p class="text-gray-600">Encuentra facturas específicas usando filtros avanzados</p>
                    </div>
                    
                    <div class="mb-8 p-6 bg-gradient-to-r from-gray-50 to-blue-50 rounded-2xl border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-3">Número de Factura</label>
                                <input type="text" id="searchInvoice" placeholder="Ej: INV-2024-001"
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-3">Proveedor</label>
                                <select id="searchProvider"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <option value="">Todos los proveedores...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-3">Estado</label>
                                <select id="searchStatus"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <option value="">Todos los estados...</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="paid">Pagada</option>
                                    <option value="annulled">Anulada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                        <button onclick="searchTransactions()" class="btn-modern flex-1 sm:flex-none px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold shadow-lg">
                            <span class="flex items-center justify-center space-x-2">
                                <span>🔍</span>
                                <span>Buscar</span>
                            </span>
                        </button>
                        <button onclick="clearSearch()" class="btn-modern px-8 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                            <span class="flex items-center justify-center space-x-2">
                                <span>🗑️</span>
                                <span>Limpiar</span>
                            </span>
                        </button>
                    </div>
                    
                    <div id="searchResults" class="hidden">
                        <h3 class="text-xl font-semibold mb-6 text-gray-800">Resultados de Búsqueda</h3>
                        <div class="table-modern">
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Proveedor</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResultsList" class="divide-y divide-gray-200">
                                        <!-- Search results will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View/Edit Transaction Modal -->
            <div id="viewTransactionModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
                <div class="card-modern max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden animate-bounce-soft">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 px-8 py-6 flex justify-between items-center text-white">
                        <div>
                            <h3 class="text-2xl font-bold">Detalle de Factura</h3>
                            <p class="text-blue-100">Información completa de la transacción</p>
                        </div>
                        <button onclick="closeViewTransactionModal()" class="text-white hover:text-gray-300 transition-colors">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-8 overflow-y-auto max-h-[calc(90vh-200px)]" id="viewTransactionContent">
                        <!-- Transaction details will be populated here -->
                    </div>
                    <div class="bg-gray-50 px-8 py-6 flex flex-wrap justify-end space-x-3" id="viewTransactionFooter">
                        <!-- Footer buttons will be populated dynamically -->
                        <button id="editTransactionBtn" onclick="editViewedTransaction()" class="btn-modern px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all">
                            <span class="flex items-center space-x-2">
                                <span>✏️</span>
                                <span>Editar Factura</span>
                            </span>
                        </button>
                        <button id="deleteTransactionBtn" onclick="deleteViewedTransaction()" class="btn-modern px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all master-only hidden">
                            <span class="flex items-center space-x-2">
                                <span>🗑️</span>
                                <span>Eliminar</span>
                            </span>
                        </button>
                        <button onclick="closeViewTransactionModal()" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Transaction Modal -->
            <div id="editTransactionModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
                <div class="card-modern max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden animate-bounce-soft">
                    <div class="bg-gradient-to-r from-green-500 to-blue-600 px-8 py-6 flex justify-between items-center text-white">
                        <div>
                            <h3 class="text-2xl font-bold">Editar Transacción</h3>
                            <p class="text-green-100">Modifica los datos de la transacción</p>
                        </div>
                        <button onclick="closeEditTransactionModal()" class="text-white hover:text-gray-300 transition-colors">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-8 overflow-y-auto max-h-[calc(90vh-200px)]">
                        <form id="editTransactionForm" class="form-modern space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">Número de Factura</label>
                                    <input type="text" id="editInvoiceNumber" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">Tipo</label>
                                    <select id="editTransactionType" required class="w-full">
                                        <option value="payable">Por Pagar</option>
                                        <option value="receivable">Por Cobrar</option>
                                        <option value="income">Entradas</option>
                                        <option value="expense">Salidas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">Proveedor</label>
                                    <select id="editProviderId" required class="w-full">
                                        <!-- Options will be populated -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                    <select id="editCurrency" required class="w-full">
                                        <option value="USD">USD</option>
                                        <option value="VES">VES</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                    <input type="number" id="editAmount" step="0.01" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">Fecha</label>
                                    <input type="date" id="editTransactionDate" required class="w-full">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Descripción</label>
                                <textarea id="editDescription" rows="3" required class="w-full"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-50 px-8 py-6 flex justify-end space-x-3">
                        <button onclick="saveEditedTransaction()" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                            <span class="flex items-center space-x-2">
                                <span>💾</span>
                                <span>Guardar Cambios</span>
                            </span>
                        </button>
                        <button onclick="closeEditTransactionModal()" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>            <!-- Payment Page (Enhanced) -->
            <div id="paymentPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Abonar a Factura</h2>
                        <p class="text-gray-600">Realiza abonos parciales con conversión automática de moneda</p>
                    </div>
                    
                    <form id="paymentForm" class="form-modern space-y-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Seleccionar Factura</label>
                                    <select id="paymentInvoice" required class="w-full">
                                        <option value="">Seleccionar factura pendiente...</option>
                                    </select>
                                </div>
                                
                                <div id="invoiceDetails" class="hidden p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 animate-slide-up">
                                    <!-- Invoice details will be shown here -->
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-3">Moneda del Abono</label>
                                        <select id="paymentCurrency" onchange="updatePaymentCurrency()" class="w-full">
                                            <option value="USD">🇺🇸 USD</option>
                                            <option value="VES">🇻🇪 VES</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-3">Monto a Abonar</label>
                                        <input type="number" id="paymentAmount" step="0.01" required class="w-full amount-input" placeholder="0.00" oninput="updateRealTimeConversion()">
                                        
                                        <!-- Enhanced Real-time conversion display -->
                                        <div id="paymentConversionDisplay" class="mt-3 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl hidden">
                                            <div class="text-sm">
                                                <div class="font-semibold text-blue-800 mb-2 flex items-center">
                                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                                    </svg>
                                                    Cálculo Automático de Conversión
                                                </div>
                                                <div id="paymentConversionText" class="text-blue-700 font-medium"></div>
                                                <div id="paymentValidationWarning" class="mt-2 text-amber-700 text-xs hidden"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Payment calculation summary -->
                                        <div id="paymentCalculationSummary" class="mt-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl hidden">
                                            <div class="text-sm">
                                                <div class="font-semibold text-green-800 mb-2">📊 Resumen del Abono</div>
                                                <div class="space-y-1 text-green-700">
                                                    <div id="paymentSummaryOriginal"></div>
                                                    <div id="paymentSummaryConverted"></div>
                                                    <div id="paymentSummaryRemaining"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Método de Pago</label>
                                    <select id="paymentMethod" required onchange="toggleBankFields(this.value, 'payment')" class="w-full">
                                        <option value="">Seleccionar método...</option>
                                        <option value="cash">💵 Efectivo</option>
                                        <option value="cash_usd">💲 Efectivo USD</option>
                                        <option value="bank">🏦 Transferencia</option>
                                        <option value="mobile">📱 Pago Móvil</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-6">
                                <div id="bankFields" class="hidden space-y-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-2xl border border-green-200 animate-slide-up">
                                    <h4 class="font-semibold text-gray-800 mb-4">Detalles Bancarios</h4>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Banco</label>
                                            <select id="bankId" class="w-full">
                                                <option value="bank1">🏦 Banco de Venezuela</option>
                                                <option value="bank2">🏦 Banco Mercantil</option>
                                                <option value="bank3">🏦 Banco Banesco</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Tasa de Cambio</label>
                                            <div class="flex space-x-2">
                                                <input type="number" id="paymentExchangeRate" step="0.01" value="36.5" class="flex-1">
                                                <button type="button" onclick="updateGlobalExchangeRateFromPayment()" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-sm font-medium">
                                                    Actualizar
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Haga clic en "Actualizar" para aplicar esta tasa globalmente</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Fecha del Pago</label>
                                            <input type="date" id="paymentDate" class="w-full">
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Número de Referencia</label>
                                    <input type="text" id="referenceNumber" class="w-full" placeholder="Número de referencia del pago...">
                                </div>
                                
                                <div id="currencyConversion" class="hidden p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-200 animate-slide-up">
                                    <h4 class="font-semibold text-gray-800 mb-4">💱 Conversión de Moneda</h4>
                                    <div class="grid grid-cols-2 gap-4 text-center">
                                        <div class="p-4 bg-white rounded-xl shadow-sm">
                                            <div class="text-sm text-gray-600 mb-1">USD</div>
                                            <div class="currency-display" id="amountUSD">$0.00</div>
                                        </div>
                                        <div class="p-4 bg-white rounded-xl shadow-sm">
                                            <div class="text-sm text-gray-600 mb-1">VES</div>
                                            <div class="currency-display" id="amountVES">Bs. 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="pendingAmountDisplay" class="hidden p-6 bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl border border-orange-200 animate-slide-up">
                                    <h4 class="font-semibold text-gray-800 mb-4">📊 Resumen del Abono</h4>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Monto Original:</span>
                                            <span class="font-bold" id="originalAmount">$0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Monto a Abonar:</span>
                                            <span class="font-bold text-blue-600" id="payingAmount">$0.00</span>
                                        </div>
                                        <hr class="border-gray-300">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Monto Pendiente:</span>
                                            <span class="font-bold text-red-600" id="remainingAmount">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200">
                            <button type="submit" 
                                    class="flex-1 btn-modern bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>💳</span>
                                    <span>Procesar Abono</span>
                                </span>
                            </button>
                            <button type="button" onclick="showPage('list')"
                                    class="sm:w-auto px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Full Payment Page (Enhanced) -->
            <div id="fullPaymentPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Pago Completo de Factura</h2>
                        <p class="text-gray-600">Cancela completamente una factura con conversión automática</p>
                    </div>
                    
                    <form id="fullPaymentForm" class="form-modern space-y-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Seleccionar Factura</label>
                                    <select id="fullPaymentInvoice" required class="w-full">
                                        <option value="">Seleccionar factura pendiente...</option>
                                    </select>
                                </div>
                                
                                <div id="fullInvoiceDetails" class="hidden p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-2xl border border-green-200 animate-slide-up">
                                    <!-- Invoice details will be shown here -->
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-3">Moneda del Pago</label>
                                        <select id="fullPaymentCurrency" onchange="updateFullPaymentCurrency()" class="w-full">
                                            <option value="USD">🇺🇸 USD</option>
                                            <option value="VES">🇻🇪 VES</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-3">Monto a Pagar</label>
                                        <input type="number" id="fullPaymentAmount" step="0.01" required class="w-full amount-input" placeholder="0.00" oninput="updateRealTimeConversionFull()">
                                        
                                        <!-- Real-time conversion display -->
                                        <div id="fullPaymentConversionDisplay" class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg hidden">
                                            <div class="text-sm text-green-700">
                                                <div class="font-semibold">Conversión Automática:</div>
                                                <div id="fullPaymentConversionText" class="mt-1"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Método de Pago</label>
                                    <select id="fullPaymentMethod" required onchange="toggleBankFields(this.value, 'fullPayment')" class="w-full">
                                        <option value="">Seleccionar método...</option>
                                        <option value="cash">💵 Efectivo</option>
                                        <option value="cash_usd">💲 Efectivo USD</option>
                                        <option value="bank">🏦 Transferencia</option>
                                        <option value="mobile">📱 Pago Móvil</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-6">
                                <div id="fullBankFields" class="hidden space-y-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-2xl border border-green-200 animate-slide-up">
                                    <h4 class="font-semibold text-gray-800 mb-4">Detalles Bancarios</h4>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Banco</label>
                                            <select id="fullBankId" class="w-full">
                                                <option value="bank1">🏦 Banco de Venezuela</option>
                                                <option value="bank2">🏦 Banco Mercantil</option>
                                                <option value="bank3">🏦 Banco Banesco</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Tasa de Cambio</label>
                                            <div class="flex space-x-2">
                                                <input type="number" id="fullExchangeRate" step="0.01" value="36.5" class="flex-1">
                                                <button type="button" onclick="updateGlobalExchangeRateFromFullPayment()" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-sm font-medium">
                                                    Actualizar
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Haga clic en "Actualizar" para aplicar esta tasa globalmente</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Fecha del Pago</label>
                                            <input type="date" id="fullPaymentDate" class="w-full">
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-3">Número de Referencia</label>
                                    <input type="text" id="fullReferenceNumber" class="w-full" placeholder="Número de referencia del pago...">
                                </div>
                                
                                <div id="fullCurrencyConversion" class="hidden p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-200 animate-slide-up">
                                    <h4 class="font-semibold text-gray-800 mb-4">💱 Conversión de Moneda</h4>
                                    <div class="grid grid-cols-2 gap-4 text-center">
                                        <div class="p-4 bg-white rounded-xl shadow-sm">
                                            <div class="text-sm text-gray-600 mb-1">USD</div>
                                            <div class="currency-display" id="fullAmountUSD">$0.00</div>
                                        </div>
                                        <div class="p-4 bg-white rounded-xl shadow-sm">
                                            <div class="text-sm text-gray-600 mb-1">VES</div>
                                            <div class="currency-display" id="fullAmountVES">Bs. 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="fullPaymentSummary" class="hidden p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-200 animate-slide-up">
                                    <h4 class="font-semibold text-gray-800 mb-4">✅ Resumen del Pago Completo</h4>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Monto de la Factura:</span>
                                            <span class="font-bold" id="fullOriginalAmount">$0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Monto a Pagar:</span>
                                            <span class="font-bold text-green-600" id="fullPayingAmount">$0.00</span>
                                        </div>
                                        <hr class="border-gray-300">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Estado Final:</span>
                                            <span class="font-bold text-green-600">✅ CANCELADA</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200">
                            <button type="submit" 
                                    class="flex-1 btn-modern bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 font-semibold text-lg shadow-lg">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>💰</span>
                                    <span>Pagar Completo</span>
                                </span>
                            </button>
                            <button type="button" onclick="showPage('list')"
                                    class="sm:w-auto px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reports Page (Enhanced) -->
            <div id="reportsPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <div class="text-center">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard de Reportes</h2>
                            <p class="text-gray-600">Análisis completo de transacciones por moneda y período</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportReportToPDF('daily')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-sm font-medium">
                                📄 PDF Diario
                            </button>
                            <button onclick="exportReportToPDF('weekly')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-sm font-medium">
                                📄 PDF Semanal
                            </button>
                            <button onclick="exportReportToPDF('monthly')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all text-sm font-medium">
                                📄 PDF Mensual
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stats-card" style="--color-from: #3b82f6; --color-to: #1d4ed8;">
                            <div class="relative z-10">
                                <div class="text-sm opacity-90 mb-1">Ingresos Totales</div>
                                <div class="text-2xl font-bold mb-1" id="totalIncome">$0</div>
                                <div class="text-xs opacity-75">Este período</div>
                            </div>
                        </div>
                        <div class="stats-card" style="--color-from: #ef4444; --color-to: #dc2626;">
                            <div class="relative z-10">
                                <div class="text-sm opacity-90 mb-1">Gastos Totales</div>
                                <div class="text-2xl font-bold mb-1" id="totalExpenses">$0</div>
                                <div class="text-xs opacity-75">Este período</div>
                            </div>
                        </div>
                        <div class="stats-card" style="--color-from: #10b981; --color-to: #059669;">
                            <div class="relative z-10">
                                <div class="text-sm opacity-90 mb-1">Balance</div>
                                <div class="text-2xl font-bold mb-1" id="balance">$0</div>
                                <div class="text-xs opacity-75">Ganancia/Pérdida</div>
                            </div>
                        </div>
                        <div class="stats-card" style="--color-from: #8b5cf6; --color-to: #7c3aed;">
                            <div class="relative z-10">
                                <div class="text-sm opacity-90 mb-1">Pendientes</div>
                                <div class="text-2xl font-bold mb-1" id="pendingAmount">$0</div>
                                <div class="text-xs opacity-75">Por cobrar/pagar</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs for USD/VES -->
                    <div class="mb-8">
                        <div class="flex border-b border-gray-200">
                            <button onclick="switchCurrencyTab('all')" class="tab-button active px-6 py-3 font-semibold" id="tab-all">
                                📊 Todos
                            </button>
                            <button onclick="switchCurrencyTab('usd')" class="tab-button px-6 py-3 font-semibold" id="tab-usd">
                                🇺🇸 USD
                            </button>
                            <button onclick="switchCurrencyTab('ves')" class="tab-button px-6 py-3 font-semibold" id="tab-ves">
                                🇻🇪 VES
                            </button>
                        </div>
                    </div>
                    
                    <!-- Currency Breakdown -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="card-modern p-6">
                            <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                                <span class="mr-2">🇺🇸</span>
                                Balance en Dólares (USD)
                                <div class="ml-auto">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Moneda Original</span>
                                </div>
                            </h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl border-l-4 border-blue-500">
                                    <span class="text-gray-700 font-medium">📈 Ingresos USD:</span>
                                    <span class="font-bold text-blue-600 text-xl" id="incomeUSD">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-red-50 rounded-xl border-l-4 border-red-500">
                                    <span class="text-gray-700 font-medium">📉 Gastos USD:</span>
                                    <span class="font-bold text-red-600 text-xl" id="expensesUSD">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-green-50 rounded-xl border-l-4 border-green-500">
                                    <span class="text-gray-700 font-medium">💰 Balance USD:</span>
                                    <span class="font-bold text-green-600 text-xl" id="balanceUSD">$0.00</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-600">💡 <strong>Incluye todos los pagos realizados en USD:</strong></p>
                                    <ul class="text-xs text-gray-500 mt-1 ml-4">
                                        <li>• Efectivo en dólares</li>
                                        <li>• Transferencias en USD</li>
                                        <li>• Abonos procesados en dólares</li>
                                    </ul>
                                    <div class="mt-2 text-xs">
                                        <span class="font-semibold text-blue-600" id="usdPaymentCount">0</span> pagos registrados
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-modern p-6">
                            <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                                <span class="mr-2">🇻🇪</span>
                                Balance en Bolívares (VES)
                                <div class="ml-auto">
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Moneda Local</span>
                                </div>
                            </h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl border-l-4 border-blue-500">
                                    <span class="text-gray-700 font-medium">📈 Ingresos VES:</span>
                                    <span class="font-bold text-blue-600 text-xl" id="incomeVES">Bs. 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-red-50 rounded-xl border-l-4 border-red-500">
                                    <span class="text-gray-700 font-medium">📉 Gastos VES:</span>
                                    <span class="font-bold text-red-600 text-xl" id="expensesVES">Bs. 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-green-50 rounded-xl border-l-4 border-green-500">
                                    <span class="text-gray-700 font-medium">💰 Balance VES:</span>
                                    <span class="font-bold text-green-600 text-xl" id="balanceVES">Bs. 0,00</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-600">💡 <strong>Incluye todos los pagos realizados en VES:</strong></p>
                                    <ul class="text-xs text-gray-500 mt-1 ml-4">
                                        <li>• Transferencias bancarias en bolívares</li>
                                        <li>• Pago móvil en VES</li>
                                        <li>• Efectivo en bolívares</li>
                                        <li>• Abonos procesados en VES</li>
                                    </ul>
                                    <div class="mt-2 text-xs">
                                        <span class="font-semibold text-green-600" id="vesPaymentCount">0</span> pagos registrados
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Entradas y Salidas por Moneda -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-6 text-gray-800">Detalle por Tipo de Transacción</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <!-- Entradas -->
                            <div class="card-modern p-6">
                                <h4 class="text-lg font-semibold mb-4 text-blue-800 flex items-center">
                                    <span class="mr-2">📈</span>
                                    Entradas
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇺🇸 USD:</span>
                                        <span class="font-bold text-blue-600" id="entriesUSD">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇻🇪 VES:</span>
                                        <span class="font-bold text-blue-600" id="entriesVES">Bs. 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Salidas -->
                            <div class="card-modern p-6">
                                <h4 class="text-lg font-semibold mb-4 text-red-800 flex items-center">
                                    <span class="mr-2">📉</span>
                                    Salidas
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇺🇸 USD:</span>
                                        <span class="font-bold text-red-600" id="expensesUSD2">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇻🇪 VES:</span>
                                        <span class="font-bold text-red-600" id="expensesVES2">Bs. 0,00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Cuentas por Cobrar -->
                            <div class="card-modern p-6">
                                <h4 class="text-lg font-semibold mb-4 text-purple-800 flex items-center">
                                    <span class="mr-2">💼</span>
                                    Cuentas por Cobrar
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇺🇸 USD:</span>
                                        <span class="font-bold text-purple-600" id="receivableUSD">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇻🇪 VES:</span>
                                        <span class="font-bold text-purple-600" id="receivableVES">Bs. 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cuentas por Pagar -->
                            <div class="card-modern p-6">
                                <h4 class="text-lg font-semibold mb-4 text-amber-800 flex items-center">
                                    <span class="mr-2">📝</span>
                                    Cuentas por Pagar
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇺🇸 USD:</span>
                                        <span class="font-bold text-amber-600" id="payableUSD">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                                        <span class="text-gray-700 font-medium">🇻🇪 VES:</span>
                                        <span class="font-bold text-amber-600" id="payableVES">Bs. 0,00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="card-modern p-6">
                            <h3 class="text-xl font-semibold mb-6 text-gray-800">Transacciones por Estado</h3>
                            <div id="statusChart" class="space-y-4">
                                <!-- Chart will be populated here -->
                            </div>
                        </div>
                        
                        <div class="card-modern p-6">
                            <h3 class="text-xl font-semibold mb-6 text-gray-800">Top Proveedores</h3>
                            <div id="providersChart" class="space-y-4">
                                <!-- Chart will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="card-modern p-6 mb-8">
                        <h3 class="text-xl font-semibold mb-6 text-gray-800">Filtros de Reporte</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Fecha Desde</label>
                                <input type="date" id="reportFromDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Fecha Hasta</label>
                                <input type="date" id="reportToDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Tipo</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Todos</option>
                                    <option value="payable">Por Pagar</option>
                                    <option value="receivable">Por Cobrar</option>
                                    <option value="income">Entradas</option>
                                    <option value="expense">Salidas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Moneda</label>
                                <select id="reportCurrency" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Todas</option>
                                    <option value="USD">USD</option>
                                    <option value="VES">VES</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="generateReport()" class="w-full btn-modern px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold shadow-lg">
                                    📊 Generar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Daily Report -->
                    <div id="dailyReport" class="card-modern p-6 hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Reporte Diario de Transacciones</h3>
                            <button onclick="exportDailyReport()" class="btn-modern px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                📄 Exportar PDF
                            </button>
                        </div>
                        <div class="table-modern">
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Proveedor</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Moneda</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Método</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dailyReportList" class="divide-y divide-gray-200">
                                        <!-- Daily report will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            <!-- Users Page -->
            <div id="usersPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Usuarios</h2>
                            <p class="text-gray-600">Administra cuentas y permisos del sistema</p>
                        </div>
                        <button onclick="showAddUserForm()" class="btn-modern px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-300 font-semibold shadow-lg">
                            <span class="flex items-center space-x-2">
                                <span>👤</span>
                                <span>Nuevo Usuario</span>
                            </span>
                        </button>
                    </div>
                    
                    <div id="addUserForm" class="hidden mb-8 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-200 animate-slide-up">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Agregar Nuevo Usuario</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="newUsername" placeholder="Nombre de usuario..."
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <input type="password" id="newPassword" placeholder="Contraseña..."
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <select id="newUserRole" class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                <option value="standard">Estándar</option>
                                <option value="master">Master</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-4 mt-4">
                            <button onclick="addUser()" class="btn-modern px-6 py-3 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all font-semibold">
                                <span class="flex items-center space-x-2">
                                    <span>✅</span>
                                    <span>Agregar Usuario</span>
                                </span>
                            </button>
                            <button onclick="hideAddUserForm()" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                <span class="flex items-center space-x-2">
                                    <span>❌</span>
                                    <span>Cancelar</span>
                                </span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="usersList">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <!-- Data Migration Page -->
            <div id="migrationPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Migración de Datos</h2>
                        <p class="text-gray-600">Importa datos desde sistemas financieros anteriores</p>
                    </div>
                    
                    <!-- Migration Steps -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm" id="step1">1</div>
                                <span class="text-gray-700 font-medium">Cargar Archivo</span>
                            </div>
                            <div class="flex-1 mx-4 h-1 bg-gray-200 rounded" id="progress1">
                                <div class="h-full bg-blue-500 rounded transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm" id="step2">2</div>
                                <span class="text-gray-500 font-medium">Mapear Campos</span>
                            </div>
                            <div class="flex-1 mx-4 h-1 bg-gray-200 rounded" id="progress2">
                                <div class="h-full bg-blue-500 rounded transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm" id="step3">3</div>
                                <span class="text-gray-500 font-medium">Importar</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 1: File Upload -->
                    <div id="migrationStep1" class="migration-step">
                        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">📁</span>
                                Paso 1: Cargar Archivo de Datos
                            </h3>
                            
                            <div class="mb-6">
                                <div class="border-2 border-dashed border-blue-300 rounded-xl p-8 text-center hover:border-blue-400 transition-all cursor-pointer" id="dropZone">
                                    <div class="mb-4">
                                        <svg class="w-16 h-16 text-blue-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Arrastra tu archivo aquí</h4>
                                    <p class="text-gray-500 mb-4">o haz clic para seleccionar un archivo</p>
                                    <p class="text-sm text-gray-400">Formatos soportados: CSV, Excel (.xlsx, .xls), SQLite (.db)</p>
                                    <input type="file" id="migrationFile" accept=".csv,.xlsx,.xls,.db" class="hidden">
                                </div>
                            </div>
                            
                            <div id="fileInfo" class="hidden mb-6 p-4 bg-white rounded-xl border">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                        </svg>
                                        <div>
                                            <h5 class="font-semibold text-gray-800" id="fileName"></h5>
                                            <p class="text-sm text-gray-500" id="fileSize"></p>
                                        </div>
                                    </div>
                                    <button onclick="removeFile()" class="text-red-500 hover:text-red-700">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button onclick="processFile()" id="processFileBtn" disabled class="btn-modern px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    <span class="flex items-center space-x-2">
                                        <span>🔍</span>
                                        <span>Procesar Archivo</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 1.5: Database Table Selection (for .db files) -->
                    <div id="migrationStep1_5" class="migration-step hidden">
                        <div class="p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-200">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">🗄️</span>
                                Paso 1.5: Seleccionar Tabla de la Base de Datos
                            </h3>
                            
                            <div class="mb-6">
                                <p class="text-gray-600 mb-4">Se han encontrado las siguientes tablas en la base de datos:</p>
                                <div id="tableList" class="space-y-3">
                                    <!-- Tables will be listed here -->
                                </div>
                            </div>
                            
                            <div id="tablePreview" class="hidden mb-6">
                                <h4 class="font-semibold text-gray-800 mb-3">Vista previa de la tabla seleccionada:</h4>
                                <div class="bg-white rounded-xl border p-4 max-h-60 overflow-auto">
                                    <div id="tablePreviewContent">
                                        <!-- Table preview will be shown here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button onclick="goToStep(1)" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>←</span>
                                        <span>Volver</span>
                                    </span>
                                </button>
                                <button onclick="selectTable()" id="selectTableBtn" disabled class="btn-modern px-6 py-3 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    <span class="flex items-center space-x-2">
                                        <span>✅</span>
                                        <span>Usar esta Tabla</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Field Mapping -->
                    <div id="migrationStep2" class="migration-step hidden">
                        <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-200">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">🔗</span>
                                Paso 2: Mapear Campos
                            </h3>
                            
                            <div class="mb-6">
                                <p class="text-gray-600 mb-4">Relaciona los campos de tu archivo con los campos del sistema:</p>
                                <div id="fieldMapping" class="space-y-4">
                                    <!-- Mapping fields will be generated here -->
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button onclick="goToStep(1)" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>←</span>
                                        <span>Volver</span>
                                    </span>
                                </button>
                                <button onclick="previewData()" id="previewBtn" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>👁️</span>
                                        <span>Vista Previa</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Preview and Import -->
                    <div id="migrationStep3" class="migration-step hidden">
                        <div class="p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-200">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">✅</span>
                                Paso 3: Vista Previa e Importación
                            </h3>
                            
                            <div class="mb-6">
                                <div id="dataPreview" class="bg-white rounded-xl border p-4 max-h-60 overflow-auto">
                                    <!-- Preview will be shown here -->
                                </div>
                            </div>
                            
                            <div id="importSummary" class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <h4 class="font-semibold text-gray-800 mb-2">Resumen de Importación:</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">Total de registros:</span>
                                        <span class="font-semibold ml-2" id="totalRecords">0</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Registros válidos:</span>
                                        <span class="font-semibold ml-2 text-green-600" id="validRecords">0</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Registros con errores:</span>
                                        <span class="font-semibold ml-2 text-red-600" id="errorRecords">0</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Proveedores nuevos:</span>
                                        <span class="font-semibold ml-2 text-blue-600" id="newProviders">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button onclick="goToStep(2)" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>←</span>
                                        <span>Volver</span>
                                    </span>
                                </button>
                                <button onclick="executeImport()" id="importBtn" class="btn-modern px-6 py-3 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>🚀</span>
                                        <span>Ejecutar Importación</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Migration Complete -->
                    <div id="migrationComplete" class="migration-step hidden">
                        <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-200">
                            <div class="text-center">
                                <div class="mb-4">
                                    <svg class="w-16 h-16 text-green-500 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">¡Migración Completada!</h3>
                                <p class="text-gray-600 mb-6">Los datos se han importado exitosamente al sistema.</p>
                                <div id="migrationResults" class="mb-6">
                                    <!-- Results will be shown here -->
                                </div>
                                <button onclick="finishMigration()" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>✅</span>
                                        <span>Finalizar</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settingsPage" class="page-content hidden">
                <div class="card-modern p-8 animate-fade-in max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Configuración del Sistema</h2>
                        <p class="text-gray-600">Gestiona las configuraciones generales y avanzadas</p>
                    </div>
                    
                    <!-- Exchange Rate Settings -->
                    <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                            <span class="mr-2">💱</span>
                            Configuración de Tasa de Cambio
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Tasa de Cambio Actual (USD → VES)</label>
                                <input type="number" id="exchangeRateInput" step="0.01" class="w-full px-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div class="flex items-end">
                                <button onclick="updateExchangeRate()" class="w-full btn-modern px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all font-semibold">
                                    <span class="flex items-center justify-center space-x-2">
                                        <span>💾</span>
                                        <span>Actualizar Tasa</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup and Restore -->
                    <div class="mb-8 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                            <span class="mr-2">💾</span>
                            Respaldo y Restauración
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Crear Respaldo</h4>
                                <p class="text-gray-600 text-sm mb-4">Descarga una copia de seguridad de todos los datos del sistema.</p>
                                <button onclick="createBackup()" class="w-full btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold">
                                    <span class="flex items-center justify-center space-x-2">
                                        <span>📥</span>
                                        <span>Crear Respaldo</span>
                                    </span>
                                </button>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Restaurar Datos</h4>
                                <p class="text-gray-600 text-sm mb-4">Restaura el sistema desde un archivo de respaldo.</p>
                                <input type="file" id="restoreFile" accept=".json" class="hidden" onchange="restoreFromBackup(this)">
                                <button onclick="document.getElementById('restoreFile').click()" class="w-full btn-modern px-6 py-3 bg-yellow-500 text-white rounded-xl hover:bg-yellow-600 transition-all font-semibold">
                                    <span class="flex items-center justify-center space-x-2">
                                        <span>📤</span>
                                        <span>Seleccionar Archivo</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audit Log -->
                    <div class="mb-8 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                            <span class="mr-2">📋</span>
                            Registro de Auditoría
                        </h3>
                        <div class="space-y-4">
                            <button onclick="viewAuditLog()" class="btn-modern px-6 py-3 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all font-semibold">
                                <span class="flex items-center space-x-2">
                                    <span>👁️</span>
                                    <span>Ver Registro</span>
                                </span>
                            </button>
                            <div id="auditLogContainer" class="hidden mt-4 p-4 bg-white rounded-xl border max-h-60 overflow-y-auto">
                                <div id="auditLogContent"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="p-6 bg-gradient-to-r from-red-50 to-pink-50 rounded-2xl border border-red-200">
                        <h3 class="text-xl font-semibold mb-4 text-red-800 flex items-center">
                            <span class="mr-2">⚠️</span>
                            Zona Peligrosa
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-red-700 mb-3">Resetear Base de Datos</h4>
                                <p class="text-red-600 text-sm mb-4">⚠️ ATENCIÓN: Esta acción eliminará TODOS los datos del sistema de forma permanente. Esta acción NO se puede deshacer.</p>
                                <button onclick="showResetConfirmation()" class="w-full btn-modern px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all font-semibold">
                                    <span class="flex items-center justify-center space-x-2">
                                        <span>🗑️</span>
                                        <span>Resetear Sistema</span>
                                    </span>
                                </button>
                            </div>
                            <div>
                                <h4 class="font-semibold text-red-700 mb-3">Limpiar Cache</h4>
                                <p class="text-red-600 text-sm mb-4">Limpia todos los datos temporales y cache del navegador.</p>
                                <button onclick="clearSystemCache()" class="w-full btn-modern px-6 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-all font-semibold">
                                    <span class="flex items-center justify-center space-x-2">
                                        <span>🧹</span>
                                        <span>Limpiar Cache</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reset Confirmation Modal -->
            <div id="resetConfirmationModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
                <div class="card-modern max-w-md w-full mx-4 animate-bounce-soft">
                    <div class="bg-gradient-to-r from-red-500 to-red-600 px-8 py-6 text-white">
                        <h3 class="text-2xl font-bold mb-2">⚠️ Confirmar Reset</h3>
                        <p class="text-red-100">Esta acción es irreversible</p>
                    </div>
                    <div class="p-8">
                        <div class="mb-6">
                            <p class="text-gray-700 mb-4">Para confirmar el reseteo completo del sistema, ingresa la contraseña master:</p>
                            <p class="text-red-600 text-sm font-semibold mb-4">⚠️ Se eliminarán TODAS las transacciones, proveedores y datos del sistema.</p>
                            <input type="password" id="resetPassword" placeholder="Contraseña master..."
                                   class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all">
                        </div>
                        <div class="flex space-x-4">
                            <button onclick="confirmSystemReset()" class="flex-1 btn-modern bg-red-500 text-white py-3 rounded-xl hover:bg-red-600 transition-all font-semibold">
                                <span class="flex items-center justify-center space-x-2">
                                    <span>🗑️</span>
                                    <span>Confirmar Reset</span>
                                </span>
                            </button>
                            <button onclick="closeResetConfirmation()" class="flex-1 btn-modern bg-gray-500 text-white py-3 rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Log Modal -->
            <div id="auditLogModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
                <div class="card-modern max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden animate-bounce-soft">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 px-8 py-6 flex justify-between items-center text-white">
                        <div>
                            <h3 class="text-2xl font-bold">📋 Registro de Auditoría</h3>
                            <p class="text-purple-100">Historial de acciones del sistema</p>
                        </div>
                        <button onclick="closeAuditLogModal()" class="text-white hover:text-gray-300 transition-colors">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-8 overflow-y-auto max-h-[calc(90vh-200px)]">
                        <div class="table-modern">
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha/Hora</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Usuario</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acción</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditLogTableBody" class="divide-y divide-gray-200">
                                        <!-- Audit log entries will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-8 py-6 flex justify-end space-x-3">
                        <button onclick="exportAuditLog()" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                            <span class="flex items-center space-x-2">
                                <span>📄</span>
                                <span>Exportar</span>
                            </span>
                        </button>
                        <button onclick="closeAuditLogModal()" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <div class="floating-action" onclick="openCalculator()">
            🧮
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentPage = 'list';
        let transactions = [];
        let providers = [];
        let users = [];
        let exchangeRate = 36.5;
        let auditLog = [];
        let paymentHistory = [];
        let currentViewedTransaction = null;
        let isDarkMode = false;
        let lastExchangeRateUpdate = null; // Para rastrear la última actualización de tasa

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Iniciando Sistema Financiero Mansión Plast C.A v2.0');
            
            // Inicializar Supabase
            await initSupabase();
            
            initializeData();
            setupEventListeners();
            setupFileDropZone();
            loadDarkMode();
            checkExchangeRateUpdate(); // Verificar si se necesita actualizar la tasa de cambio
            showLoginScreen();
            
            console.log('✅ Sistema iniciado correctamente');
        });

        // Dark Mode Functions
        function loadDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true') {
                enableDarkMode();
            }
        }

        function toggleDarkMode() {
            if (isDarkMode) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        function enableDarkMode() {
            isDarkMode = true;
            document.body.classList.add('dark-mode');
            document.body.style.background = 'linear-gradient(135deg, #1e293b 0%, #334155 100%)';
            localStorage.setItem('darkMode', 'true');
            
            // Update dark mode toggle icon
            const toggle = document.getElementById('darkModeToggle');
            toggle.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"></path></svg>';
            toggle.style.color = '#e2e8f0';
        }

        function disableDarkMode() {
            isDarkMode = false;
            document.body.classList.remove('dark-mode');
            document.body.style.background = 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)';
            localStorage.setItem('darkMode', 'false');
            
            // Update dark mode toggle icon
            const toggle = document.getElementById('darkModeToggle');
            toggle.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>';
            toggle.style.color = '#374151';
        }

        // Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="text-xl">
                            ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                        </div>
                        <div>${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-300 ml-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Loading System
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // Funciones para actualizar tasa de cambio desde pagos
        function updateGlobalExchangeRateFromPayment() {
            const newRate = parseFloat(document.getElementById('paymentExchangeRate').value);
            if (newRate && newRate > 0) {
                exchangeRate = newRate;
                localStorage.setItem('currentExchangeRate', newRate.toString());
                document.getElementById('currentExchangeRate').textContent = newRate.toFixed(2);
                showNotification(`Tasa de cambio actualizada a ${newRate.toFixed(2)}`, 'success');
                
                // Actualizar todos los campos de tasa en el sistema
                updateAllExchangeRateFields(newRate);
            } else {
                showNotification('Por favor ingrese una tasa válida', 'error');
            }
        }
        
        function updateGlobalExchangeRateFromFullPayment() {
            const newRate = parseFloat(document.getElementById('fullExchangeRate').value);
            if (newRate && newRate > 0) {
                exchangeRate = newRate;
                localStorage.setItem('currentExchangeRate', newRate.toString());
                document.getElementById('currentExchangeRate').textContent = newRate.toFixed(2);
                showNotification(`Tasa de cambio actualizada a ${newRate.toFixed(2)}`, 'success');
                
                // Actualizar todos los campos de tasa en el sistema
                updateAllExchangeRateFields(newRate);
            } else {
                showNotification('Por favor ingrese una tasa válida', 'error');
            }
        }
        
        function updateAllExchangeRateFields(newRate) {
            // Actualizar campos de entrada y salida
            const incomeRateField = document.getElementById('incomeExchangeRate');
            const expenseRateField = document.getElementById('expenseExchangeRate');
            const paymentRateField = document.getElementById('paymentExchangeRate');
            const fullPaymentRateField = document.getElementById('fullExchangeRate');
            
            if (incomeRateField) incomeRateField.value = newRate.toFixed(2);
            if (expenseRateField) expenseRateField.value = newRate.toFixed(2);
            if (paymentRateField) paymentRateField.value = newRate.toFixed(2);
            if (fullPaymentRateField) fullPaymentRateField.value = newRate.toFixed(2);
            
            // Actualizar display actual
            const currentDisplay = document.getElementById('currentRateDisplay');
            if (currentDisplay) currentDisplay.textContent = newRate.toFixed(2);
        }

        // Calculator Functions
        function openCalculator() {
            document.getElementById('calculatorModal').classList.remove('hidden');
        }

        function closeCalculator() {
            document.getElementById('calculatorModal').classList.add('hidden');
        }

        function convertToVES() {
            const amount = parseFloat(document.getElementById('calcAmount').value) || 0;
            const rate = parseFloat(document.getElementById('calcRate').value) || 36.5;
            const result = amount * rate;
            
            document.getElementById('calcResultAmount').textContent = formatNumber(result, 'VES');
            document.getElementById('calcResultText').textContent = `${formatNumber(amount, 'USD')} × ${rate} = ${formatNumber(result, 'VES')}`;
            document.getElementById('calcResult').classList.remove('hidden');
        }

        function convertToUSD() {
            const amount = parseFloat(document.getElementById('calcAmount').value) || 0;
            const rate = parseFloat(document.getElementById('calcRate').value) || 36.5;
            const result = amount / rate;
            
            document.getElementById('calcResultAmount').textContent = formatNumber(result, 'USD');
            document.getElementById('calcResultText').textContent = `${formatNumber(amount, 'VES')} ÷ ${rate} = ${formatNumber(result, 'USD')}`;
            document.getElementById('calcResult').classList.remove('hidden');
        }

        // Audit System
        function logAction(action, details = '') {
            const entry = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                user: currentUser?.username || 'Sistema',
                action: action,
                details: details,
                ip: 'Local'
            };
            
            auditLog.unshift(entry);
            
            // Keep only last 1000 entries
            if (auditLog.length > 1000) {
                auditLog = auditLog.slice(0, 1000);
            }
            
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
        }

        // Configuración de Supabase
        const SUPABASE_URL = 'https://tgbpjuehikxnechwtakk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnYnBqdWVoaWt4bmVjaHd0YWtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1NjY1NzUsImV4cCI6MjA2NzE0MjU3NX0.5ve4Y9RBPwX8ui-wm4HKIL10EOfm-yCdLZopaR_piow';
        
        // Variables globales
        let supabaseClient = null;
        let isOnlineMode = false;
        
        // Inicializar Supabase
        async function initSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    isOnlineMode = true;
                    console.log('✅ Supabase conectado - Modo Online');
                    showConnectionStatus('online');
                    return true;
                }
            } catch (error) {
                console.warn('⚠️ Error conectando Supabase:', error);
            }
            
            console.log('📱 Modo Offline - LocalStorage');
            showConnectionStatus('offline');
            return false;
        }
        
        // Mostrar estado de conexión
        function showConnectionStatus(status) {
            const indicator = document.createElement('div');
            indicator.id = 'connection-indicator';
            indicator.className = `fixed top-4 left-4 px-3 py-2 rounded-lg text-sm font-medium z-50 transition-all duration-300 ${
                status === 'online' 
                    ? 'bg-green-100 text-green-800 border border-green-200' 
                    : 'bg-yellow-100 text-yellow-800 border border-yellow-200'
            }`;
            indicator.innerHTML = status === 'online' 
                ? '🟢 Conectada' 
                : '🟡 Modo Offline';
            
            document.body.appendChild(indicator);
            
            // Reducir visibilidad después de 5 segundos
            setTimeout(() => {
                indicator.style.opacity = '0.6';
                indicator.style.fontSize = '11px';
            }, 5000);
        }

        // Data Initialization
        function initializeData() {
            // Load existing data or create initial data
            users = JSON.parse(localStorage.getItem('users')) || [
                { id: '1', username: 'master', password: 'password', role: 'master' },
                { id: '2', username: 'standard', password: 'password', role: 'standard' }
            ];
            
            providers = JSON.parse(localStorage.getItem('providers')) || [
                { id: '1', name: 'Proveedor Ejemplo 1' },
                { id: '2', name: 'Proveedor Ejemplo 2' },
                { id: '3', name: 'Cliente Ejemplo 1' }
            ];
            
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 36.5;
            auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
            paymentHistory = JSON.parse(localStorage.getItem('paymentHistory')) || [];
            lastExchangeRateUpdate = localStorage.getItem('lastExchangeRateUpdate') || null;
            
            // Save initial data
            saveAllData();
        }        // Save all data to localStorage
        function saveAllData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('providers', JSON.stringify(providers));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('exchangeRate', exchangeRate.toString());
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            localStorage.setItem('paymentHistory', JSON.stringify(paymentHistory));
            if (lastExchangeRateUpdate) {
                localStorage.setItem('lastExchangeRateUpdate', lastExchangeRateUpdate);
            }
        }

        // PDF Export Functions
        function exportReportToPDF(period) {
            const { jsPDF } = window.jspdf;
            // Use landscape for better layout
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            // Document properties
            doc.setProperties({
                title: `Reporte Financiero ${period} - Mansión Plast C.A`,
                subject: 'Reporte Financiero',
                author: 'Sistema Financiero Mansión Plast',
                keywords: 'reporte, finanzas, mansión plast',
                creator: 'Sistema Financiero'
            });
            
            // Get report data
            const reportData = getReportDataByPeriod(period);
            
            // Colors
            const primaryColor = [29, 78, 216]; // Blue-700
            const secondaryColor = [5, 150, 105]; // Emerald-600
            const accentColor = [219, 39, 119]; // Pink-600
            const textColor = [31, 41, 55]; // Gray-800
            const lightGray = [243, 244, 246]; // Gray-100
            
            // Variables for positioning
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let y = margin;
            
            // Header with logo and title
            // Draw a header background
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, pageWidth, 30, 'F');
            
            // Company name and title
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.text('MANSIÓN PLAST C.A', margin, y + 10);
            
            // Report type and date on the right
            doc.setFontSize(14);
            const reportTypeText = `REPORTE ${period.toUpperCase()}`;
            const dateText = `${new Date().toLocaleDateString('es-VE')}`;
            doc.text(reportTypeText, pageWidth - margin - doc.getTextWidth(reportTypeText), y + 8);
            doc.text(dateText, pageWidth - margin - doc.getTextWidth(dateText), y + 15);
            
            // Add tasa de cambio
            const rateText = `TASA USD: ${exchangeRate.toFixed(2)} VES`;
            doc.setFillColor(...accentColor);
            doc.roundedRect(pageWidth - margin - doc.getTextWidth(rateText) - 10, y + 18, doc.getTextWidth(rateText) + 10, 10, 2, 2, 'F');
            doc.text(rateText, pageWidth - margin - doc.getTextWidth(rateText) - 5, y + 25);
            
            // Reset position after header
            y = 40;
            
            // Financial summary box
            doc.setFillColor(...lightGray);
            doc.setDrawColor(...primaryColor);
            doc.roundedRect(margin, y, contentWidth, 40, 3, 3, 'FD');
            
            // Summary title
            doc.setTextColor(...primaryColor);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMEN FINANCIERO', margin + 5, y + 10);
            
            // Summary content
            const colWidth = contentWidth / 4;
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            // Row headers
            y += 20;
            doc.setFont('helvetica', 'bold');
            doc.text('INGRESOS', margin + 5, y);
            doc.text('GASTOS', margin + colWidth * 2 + 5, y);
            
            // Amounts
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`USD: ${formatNumber(reportData.totalIncomeUSD, 'USD')}`, margin + 5, y);
            doc.text(`VES: ${formatNumber(reportData.totalIncomeVES, 'VES')}`, margin + colWidth + 5, y);
            doc.text(`USD: ${formatNumber(reportData.totalExpensesUSD, 'USD')}`, margin + colWidth * 2 + 5, y);
            doc.text(`VES: ${formatNumber(reportData.totalExpensesVES, 'VES')}`, margin + colWidth * 3 + 5, y);
            
            // Reset for transactions table
            y += 20;
            
            // Transactions section title
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('TRANSACCIONES RECIENTES', margin, y);
            
            // Table headers
            y += 10;
            const columnWidths = [25, 20, 50, 30, 25, 30];
            const headers = ['FACTURA', 'TIPO', 'PROVEEDOR', 'MONTO', 'ESTADO', 'FECHA'];
            
            // Draw table header background
            doc.setFillColor(...primaryColor);
            doc.rect(margin, y - 5, contentWidth, 8, 'F');
            
            // Draw headers
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            let xOffset = margin;
            
            headers.forEach((header, index) => {
                doc.text(header, xOffset + 2, y);
                xOffset += columnWidths[index];
            });
            
            // Draw transactions rows
            y += 8;
            doc.setTextColor(...textColor);
            doc.setFontSize(9);
            
            // Alternating row colors
            let isEvenRow = false;
            
            reportData.transactions.slice(0, 20).forEach((transaction, index) => {
                const provider = providers.find(p => p.id === transaction.providerId);
                const rowY = y + (index * 8);
                
                if (rowY > 180) return; // Page limit
                
                // Draw row background
                if (isEvenRow) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(margin, rowY - 5, contentWidth, 8, 'F');
                }
                isEvenRow = !isEvenRow;
                
                // Row content
                xOffset = margin;
                
                // Invoice number with truncation if needed
                const invoiceText = transaction.invoiceNumber.length > 10 ? 
                    transaction.invoiceNumber.substring(0, 8) + '...' : 
                    transaction.invoiceNumber;
                doc.text(invoiceText, xOffset + 2, rowY);
                xOffset += columnWidths[0];
                
                // Transaction type
                const typeText = transaction.type === 'receivable' ? 'Por Cobrar' : 
                                transaction.type === 'payable' ? 'Por Pagar' :
                                transaction.type === 'income' ? 'Entradas' : 
                                transaction.type === 'expense' ? 'Salidas' : transaction.type;
                doc.text(typeText, xOffset + 2, rowY);
                xOffset += columnWidths[1];
                
                // Provider name with truncation if needed
                const providerText = provider?.name ? 
                    (provider.name.length > 22 ? provider.name.substring(0, 20) + '...' : provider.name) : 
                    'N/A';
                doc.text(providerText, xOffset + 2, rowY);
                xOffset += columnWidths[2];
                
                // Amount with currency
                doc.text(formatNumber(transaction.amount, transaction.currency), xOffset + 2, rowY);
                xOffset += columnWidths[3];
                
                // Status with color coding
                const statusText = getStatusDisplayName(transaction.status);
                
                // Different color for status
                if (transaction.status === 'paid') {
                    doc.setTextColor(5, 150, 105); // Green for paid
                } else if (transaction.status === 'annulled') {
                    doc.setTextColor(220, 38, 38); // Red for annulled
                } else {
                    doc.setTextColor(234, 88, 12); // Orange for pending
                }
                
                doc.text(statusText, xOffset + 2, rowY);
                doc.setTextColor(...textColor); // Reset text color
                xOffset += columnWidths[4];
                
                // Date
                doc.text(formatDateLocal(transaction.date), xOffset + 2, rowY);

            });
            
            // Footer with page number and timestamp
            const footerY = doc.internal.pageSize.getHeight() - 10;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generado por: ${currentUser.username} | Fecha: ${new Date().toLocaleString('es-VE')}`, margin, footerY);
            doc.text(`Página 1 de 1`, pageWidth - margin - 20, footerY);
            
            // Save PDF
            const filename = `Reporte_${period.charAt(0).toUpperCase() + period.slice(1)}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            
            showNotification(`Reporte ${period} exportado exitosamente`, 'success');
            logAction('EXPORT_PDF', `Reporte ${period} exportado a PDF`);
        }
        
        function getReportDataByPeriod(period) {
            const now = new Date();
            let startDate = new Date();
            
            switch(period) {
                case 'daily':
                    startDate.setDate(now.getDate() - 1);
                    break;
                case 'weekly':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'monthly':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
            }
            
            const filteredTransactions = transactions.filter(t => {
                const transDate = new Date(t.date);
                return transDate >= startDate && transDate <= now;
            });
            
            const result = {
                totalIncomeUSD: 0,
                totalIncomeVES: 0,
                totalExpensesUSD: 0,
                totalExpensesVES: 0,
                transactions: filteredTransactions
            };
            
            filteredTransactions.forEach(transaction => {
                if (transaction.status === 'paid') {
                    if (transaction.type === 'receivable' || transaction.type === 'income') {
                        if (transaction.currency === 'USD') {
                            result.totalIncomeUSD += transaction.amount;
                        } else {
                            result.totalIncomeVES += transaction.amount;
                        }
                    } else if (transaction.type === 'payable' || transaction.type === 'expense') {
                        if (transaction.currency === 'USD') {
                            result.totalExpensesUSD += transaction.amount;
                        } else {
                            result.totalExpensesVES += transaction.amount;
                        }
                    }
                }
            });
            
            return result;
        }
        
        function getStatusDisplayName(status) {
            const statuses = {
                'pending': 'Pendiente',
                'paid': 'Pagada',
                'annulled': 'Anulada'
            };
            return statuses[status] || status;
        }

        // Enhanced real-time conversion functions with detailed calculations
        function updateRealTimeConversion() {
            const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const currency = document.getElementById('paymentCurrency').value;
            const display = document.getElementById('paymentConversionDisplay');
            const text = document.getElementById('paymentConversionText');
            const warning = document.getElementById('paymentValidationWarning');
            const summary = document.getElementById('paymentCalculationSummary');
            
            if (amount > 0 && currency) {
                let conversionText = '';
                let warningText = '';
                
                // Get current selected transaction for validation
                const transactionId = document.getElementById('paymentInvoice').value;
                if (transactionId) {
                    const transaction = transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        const remainingAmount = calculateRemainingAmount(transaction);
                        
                        // Calculate conversion
                        let paymentInTransactionCurrency = amount;
                        let convertedAmount = amount;
                        
                        if (currency !== transaction.currency) {
                            if (transaction.currency === 'USD' && currency === 'VES') {
                                paymentInTransactionCurrency = amount / exchangeRate;
                                convertedAmount = paymentInTransactionCurrency;
                            } else if (transaction.currency === 'VES' && currency === 'USD') {
                                paymentInTransactionCurrency = amount * exchangeRate;
                                convertedAmount = paymentInTransactionCurrency;
                            }
                        }
                        
                        // Validation warning - Special handling for VES payments
                        if (currency === 'VES') {
                            // For VES payments, never show warning - devaluation makes amounts naturally larger
                            warning.classList.add('hidden');
                        } else if (paymentInTransactionCurrency > remainingAmount) {
                            warningText = `⚠️ El monto excede el saldo pendiente. Máximo permitido: ${formatNumber(currency === transaction.currency ? remainingAmount : (transaction.currency === 'USD' ? remainingAmount * exchangeRate : remainingAmount / exchangeRate), currency)}`;
                            warning.textContent = warningText;
                            warning.classList.remove('hidden');
                        } else {
                            warning.classList.add('hidden');
                        }
                        
                        // Update calculation summary
                        updatePaymentCalculationSummary(transaction, amount, currency, remainingAmount);
                    }
                }
                
                // Conversion display
                if (currency === 'USD') {
                    const vesAmount = amount * exchangeRate;
                    conversionText = `${formatNumber(amount, 'USD')} × ${exchangeRate} = ${formatNumber(vesAmount, 'VES')}`;
                } else {
                    const usdAmount = amount / exchangeRate;
                    conversionText = `${formatNumber(amount, 'VES')} ÷ ${exchangeRate} = ${formatNumber(usdAmount, 'USD')}`;
                }
                
                text.innerHTML = conversionText;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
                summary.classList.add('hidden');
                warning.classList.add('hidden');
            }
        }
        
        function updatePaymentCalculationSummary(transaction, paymentAmount, paymentCurrency, remainingAmount) {
            const summary = document.getElementById('paymentCalculationSummary');
            const originalDiv = document.getElementById('paymentSummaryOriginal');
            const convertedDiv = document.getElementById('paymentSummaryConverted');
            const remainingDiv = document.getElementById('paymentSummaryRemaining');
            
            // Calculate payment in transaction currency
            let paymentInTransactionCurrency = paymentAmount;
            if (paymentCurrency !== transaction.currency) {
                if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                    paymentInTransactionCurrency = paymentAmount / exchangeRate;
                } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                    paymentInTransactionCurrency = paymentAmount * exchangeRate;
                }
            }
            
            const newRemaining = Math.max(0, remainingAmount - paymentInTransactionCurrency);
            
            originalDiv.textContent = `• Abono: ${formatNumber(paymentAmount, paymentCurrency)}`;
            
            if (paymentCurrency !== transaction.currency) {
                convertedDiv.textContent = `• Equivalente: ${formatNumber(paymentInTransactionCurrency, transaction.currency)}`;
                convertedDiv.classList.remove('hidden');
            } else {
                convertedDiv.classList.add('hidden');
            }
            
            remainingDiv.textContent = `• Quedará pendiente: ${formatNumber(newRemaining, transaction.currency)}`;
            
            summary.classList.remove('hidden');
        }
        
        function updateRealTimeConversionFull() {
            const amount = parseFloat(document.getElementById('fullPaymentAmount').value) || 0;
            const currency = document.getElementById('fullPaymentCurrency').value;
            const display = document.getElementById('fullPaymentConversionDisplay');
            const text = document.getElementById('fullPaymentConversionText');
            
            if (amount > 0 && currency) {
                let conversionText = '';
                
                // Get current selected transaction for validation
                const transactionId = document.getElementById('fullPaymentInvoice').value;
                if (transactionId) {
                    const transaction = transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        const remainingAmount = calculateRemainingAmount(transaction);
                        
                        // Calculate conversion
                        let paymentInTransactionCurrency = amount;
                        let convertedAmount = amount;
                        
                        if (currency !== transaction.currency) {
                            if (transaction.currency === 'USD' && currency === 'VES') {
                                paymentInTransactionCurrency = amount / exchangeRate;
                                convertedAmount = paymentInTransactionCurrency;
                            } else if (transaction.currency === 'VES' && currency === 'USD') {
                                paymentInTransactionCurrency = amount * exchangeRate;
                                convertedAmount = paymentInTransactionCurrency;
                            }
                        }
                        
                        // For VES payments, no validation is needed - they can be larger
                        // Only show warnings for USD payments exceeding limits
                        if (currency === 'USD' && paymentInTransactionCurrency > remainingAmount) {
                            conversionText = `
                                <div class="text-amber-600 font-semibold">
                                    ⚠️ El monto en USD excede el saldo pendiente de ${formatNumber(remainingAmount, transaction.currency)}
                                </div>
                                <div>
                                    ${formatNumber(amount, 'USD')} ${currency === 'USD' ? '×' : '÷'} ${exchangeRate} = ${formatNumber(currency === 'USD' ? amount * exchangeRate : amount / exchangeRate, currency === 'USD' ? 'VES' : 'USD')}
                                </div>
                            `;
                        } else {
                            // Normal conversion display
                            if (currency === 'USD') {
                                const vesAmount = amount * exchangeRate;
                                conversionText = `${formatNumber(amount, 'USD')} × ${exchangeRate} = ${formatNumber(vesAmount, 'VES')}`;
                            } else {
                                const usdAmount = amount / exchangeRate;
                                conversionText = `${formatNumber(amount, 'VES')} ÷ ${exchangeRate} = ${formatNumber(usdAmount, 'USD')}`;
                            }
                        }
                    }
                } else {
                    // Basic conversion without transaction context
                    if (currency === 'USD') {
                        const vesAmount = amount * exchangeRate;
                        conversionText = `${formatNumber(amount, 'USD')} × ${exchangeRate} = ${formatNumber(vesAmount, 'VES')}`;
                    } else {
                        const usdAmount = amount / exchangeRate;
                        conversionText = `${formatNumber(amount, 'VES')} ÷ ${exchangeRate} = ${formatNumber(usdAmount, 'USD')}`;
                    }
                }
                
                text.innerHTML = conversionText;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Forms
            document.getElementById('addTransactionForm').addEventListener('submit', addTransaction);
            document.getElementById('incomeForm').addEventListener('submit', addIncomeTransaction);
            document.getElementById('expenseForm').addEventListener('submit', addExpenseTransaction);
            document.getElementById('paymentForm').addEventListener('submit', processPayment);
            document.getElementById('fullPaymentForm').addEventListener('submit', processFullPayment);
            
            // Currency change events
            document.getElementById('paymentAmount').addEventListener('input', updatePaymentCalculations);
            document.getElementById('paymentExchangeRate').addEventListener('input', updatePaymentCalculations);
            document.getElementById('fullPaymentAmount').addEventListener('input', updateFullPaymentCalculations);
            document.getElementById('fullExchangeRate').addEventListener('input', updateFullPaymentCalculations);
            
            // Real-time conversion events
            document.getElementById('paymentCurrency').addEventListener('change', updateRealTimeConversion);
            document.getElementById('fullPaymentCurrency').addEventListener('change', updateRealTimeConversionFull);
            
            // Invoice selection events
            document.getElementById('paymentInvoice').addEventListener('change', onPaymentInvoiceSelect);
            document.getElementById('fullPaymentInvoice').addEventListener('change', onFullPaymentInvoiceSelect);
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('fullPaymentDate').value = today;
        }

        // Login Functions
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                logAction('LOGIN', `Usuario ${username} inició sesión`);
                showMainApp();
                showNotification(`¡Bienvenido, ${user.username}!`, 'success');
                
                // Verificar si necesitamos actualizar la tasa de cambio hoy
                setTimeout(() => {
                    checkExchangeRateUpdate();
                }, 1000); // Pequeño retraso para mostrar primero el mensaje de bienvenida
            } else {
                document.getElementById('loginError').textContent = 'Usuario o contraseña incorrectos';
                document.getElementById('loginError').classList.remove('hidden');
                showNotification('Credenciales incorrectas', 'error');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Set user info with welcome message
            document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role})`;
            document.getElementById('userInitial').textContent = currentUser.username.charAt(0).toUpperCase();
            document.getElementById('welcomeMessage').textContent = `Bienvenido ${currentUser.username}`;
            
            // Update exchange rate display
            updateExchangeRateDisplay();
            
            // Show/hide master-only elements
            const masterElements = document.querySelectorAll('.master-only');
            masterElements.forEach(el => {
                if (currentUser.role === 'master') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            
            // Load initial page
            showPage('list');
        }

        function updateExchangeRateDisplay() {
            document.getElementById('currentExchangeRate').textContent = exchangeRate.toFixed(2);
        }

        function logout() {
            logAction('LOGOUT', `Usuario ${currentUser.username} cerró sesión`);
            currentUser = null;
            showLoginScreen();
            
            // Clear forms
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
            showNotification('Sesión cerrada correctamente', 'info');
        }

        // Navigation Functions
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            const activeBtn = document.querySelector(`.nav-btn[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                activeBtn.classList.add('bg-blue-500', 'text-white');
            }
            
            currentPage = page;
            
            // Load page-specific data
            switch(page) {
                case 'list':
                    loadTransactions();
                    break;
                case 'add':
                    loadProvidersForAddForm();
                    // Reset form when switching to add page (unless in edit mode)
                    const form = document.getElementById('addTransactionForm');
                    if (form && !form.hasAttribute('data-edit-id')) {
                        resetTransactionForm();
                    }
                    break;
                case 'income':
                    loadProvidersForIncomeForm();
                    resetIncomeForm();
                    break;
                case 'expense':
                    loadProvidersForExpenseForm();
                    resetExpenseForm();
                    break;
                case 'providers':
                    loadProviders();
                    break;
                case 'search':
                    loadSearchProviders();
                    break;
                case 'payment':
                    loadPendingInvoicesForPayment();
                    break;
                case 'fullPayment':
                    loadPendingInvoicesForFullPayment();
                    break;
                case 'reports':
                    generateReportsData();
                    break;
                case 'migration':
                    if (currentUser.role === 'master') {
                        resetMigrationForm();
                    }
                    break;
                case 'users':
                    if (currentUser.role === 'master') {
                        loadUsers();
                    }
                    break;
                case 'settings':
                    if (currentUser.role === 'master') {
                        loadSettings();
                        // Update the exchange rate display
                        updateExchangeRateDisplay();
                    }
                    break;
            }
        }

        // Transaction Functions
        function loadTransactions() {
            const tbody = document.getElementById('transactionsList');
            tbody.innerHTML = '';
            
            // Update stats
            updateTransactionStats();
            
            transactions.forEach(transaction => {
                const provider = providers.find(p => p.id === transaction.providerId);
                const row = createTransactionRow(transaction, provider);
                tbody.appendChild(row);
            });
        }

        function createTransactionRow(transaction, provider) {
            const row = document.createElement('tr');
            row.className = 'table-row hover:bg-gray-50 cursor-pointer';
            
            const statusClass = transaction.status === 'paid' ? 'status-paid' : 
                               transaction.status === 'annulled' ? 'status-cancelled' : 'status-pending';
            
            const statusText = transaction.status === 'paid' ? 'Pagada' : 
                              transaction.status === 'annulled' ? 'Anulada' : 'Pendiente';
            
            // Calculate remaining amount
            const remainingAmount = calculateRemainingAmount(transaction);
            const remainingDisplay = remainingAmount > 0 ? formatNumber(remainingAmount, transaction.currency) : 'Cancelado';
            
            // Get payment method information for paid transactions
            let paymentMethodInfo = '';
            if (transaction.status === 'paid' && transaction.paymentDetails) {
                if (transaction.paymentDetails.methodDisplayName) {
                    paymentMethodInfo = `<div class="text-xs text-blue-600 mt-1">💳 ${transaction.paymentDetails.methodDisplayName}</div>`;
                } else if (transaction.paymentDetails.method) {
                    paymentMethodInfo = `<div class="text-xs text-blue-600 mt-1">💳 ${getMethodDisplayName(transaction.paymentDetails.method)}</div>`;
                }
                
                // Add final payment currency if different from transaction currency
                if (transaction.paymentDetails.finalPaymentCurrency && 
                    transaction.paymentDetails.finalPaymentCurrency !== transaction.currency) {
                    paymentMethodInfo += `<div class="text-xs text-green-600">Pagado en ${transaction.paymentDetails.finalPaymentCurrency}</div>`;
                }
            }
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${transaction.invoiceNumber}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${
                        transaction.type === 'payable' ? '💸 Por Pagar' : 
                        transaction.type === 'receivable' ? '💰 Por Cobrar' :
                        transaction.type === 'income' ? '💰 Entradas' : 
                        transaction.type === 'expense' ? '💸 Salidas' : transaction.type
                    }</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${provider ? provider.name : 'N/A'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-semibold text-gray-900">${formatNumber(transaction.amount, transaction.currency)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm ${remainingAmount > 0 ? 'text-red-600 font-semibold' : 'text-green-600'}">${remainingDisplay}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${formatDate(transaction.date)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="badge-modern ${statusClass} text-white">${statusText}</span>
                    ${paymentMethodInfo}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex space-x-2">
                        <button onclick="viewTransaction('${transaction.id}')" class="btn-modern px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-all">
                            👁️ Ver
                        </button>
                        ${transaction.status === 'pending' && currentUser.role === 'master' ? `
                            <button onclick="annulTransaction('${transaction.id}')" class="btn-modern px-3 py-1 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-all">
                                ❌ Anular
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            // Add click handler for row
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    viewTransaction(transaction.id);
                }
            });
            
            return row;
        }

        function updateTransactionStats() {
            const total = transactions.length;
            const paid = transactions.filter(t => t.status === 'paid').length;
            const pending = transactions.filter(t => t.status === 'pending').length;
            const annulled = transactions.filter(t => t.status === 'annulled').length;
            
            document.getElementById('totalTransactions').textContent = total;
            document.getElementById('paidTransactions').textContent = paid;
            document.getElementById('pendingTransactions').textContent = pending;
            document.getElementById('annulledTransactions').textContent = annulled;
        }

        function calculateRemainingAmount(transaction) {
            if (transaction.status === 'paid' || transaction.status === 'annulled') {
                return 0;
            }
            
            // Get all payment history for this transaction
            const payments = paymentHistory.filter(p => p.transactionId === transaction.id);
            const totalPaid = payments.reduce((sum, payment) => {
                // Convert to transaction currency for calculation
                if (payment.currency === transaction.currency) {
                    return sum + payment.amount;
                } else {
                    // Convert using the payment's exchange rate
                    if (transaction.currency === 'USD' && payment.currency === 'VES') {
                        return sum + (payment.amount / payment.exchangeRate);
                    } else if (transaction.currency === 'VES' && payment.currency === 'USD') {
                        return sum + (payment.amount * payment.exchangeRate);
                    }
                }
                return sum;
            }, 0);
            
            return Math.max(0, transaction.amount - totalPaid);
        }

        function addTransaction(e) {
            e.preventDefault();
            showLoading();
            
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const type = document.getElementById('transactionType').value;
            const providerId = document.getElementById('providerId').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const currency = document.getElementById('currency').value;
            const date = document.getElementById('transactionDate').value;
            const description = document.getElementById('description').value;
            const editId = e.target.getAttribute('data-edit-id');
            
            // Check if invoice number already exists (only for new transactions)
            if (!editId && transactions.find(t => t.invoiceNumber === invoiceNumber)) {
                hideLoading();
                showNotification('El número de factura ya existe', 'error');
                return;
            }
            
            // Check if editing and invoice number conflicts with another transaction
            if (editId && transactions.find(t => t.invoiceNumber === invoiceNumber && t.id !== editId)) {
                hideLoading();
                showNotification('El número de factura ya existe en otra transacción', 'error');
                return;
            }
            
            const transaction = {
                id: editId || Date.now().toString(),
                invoiceNumber,
                type,
                providerId,
                amount,
                currency,
                date,
                description,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            if (editId) {
                // Update existing transaction
                const index = transactions.findIndex(t => t.id === editId);
                if (index !== -1) {
                    transactions[index] = transaction;
                    logAction('EDIT_TRANSACTION', `Transacción editada: ${invoiceNumber} - ${formatNumber(amount, currency)}`);
                    showNotification('Transacción actualizada exitosamente', 'success');
                }
            } else {
                // Add new transaction
                transactions.push(transaction);
                logAction('CREATE_TRANSACTION', `Creada transacción ${invoiceNumber} por ${formatNumber(amount, currency)}`);
                showNotification('Transacción agregada exitosamente', 'success');
            }
            
            saveAllData();
            
            // Reset form and clear edit mode
            resetTransactionForm();
            
            hideLoading();
            
            // If it was an edit, reload the transactions list, otherwise stay on current page
            if (editId) {
                loadTransactions(); // Refresh the list
                
                // Auto-actualizar reportes después de editar transacción
                autoRefreshReportsIfNeeded();
                
                showPage('list'); // Go back to list
            } else {
                // Auto-actualizar reportes después de agregar nueva transacción
                autoRefreshReportsIfNeeded();
                
                showPage('list'); // Go to list for new transactions
            }
        }

        function resetTransactionForm() {
            try {
                const form = document.getElementById('addTransactionForm');
                if (!form) {
                    console.error('Formulario no encontrado al resetear');
                    return;
                }
                
                // Reset form fields
                form.reset();
                
                // Reset date to today
                const dateField = document.getElementById('transactionDate');
                if (dateField) {
                    dateField.value = new Date().toISOString().split('T')[0];
                }
                
                // Clear edit mode
                form.removeAttribute('data-edit-id');
                
                // Reset button text to add mode
                const submitButton = document.querySelector('#addTransactionForm button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = `
                        <span class="flex items-center justify-center space-x-2">
                            <span>💾</span>
                            <span>Guardar Transacción</span>
                        </span>
                    `;
                }
                
                // Reset page title
                const pageTitle = document.querySelector('#addPage h2');
                if (pageTitle) {
                    pageTitle.textContent = 'Agregar Nueva Transacción';
                }
                
                const pageSubtitle = document.querySelector('#addPage p');
                if (pageSubtitle) {
                    pageSubtitle.textContent = 'Registra una nueva transacción en el sistema';
                }
                
                // Clear any payment fields if shown
                const paymentFields = document.getElementById('paymentFields');
                if (paymentFields) {
                    paymentFields.classList.add('hidden');
                }
                
                // Limpiar la variable global después de un formulario completo
                currentViewedTransaction = null;
                
                console.log('Formulario reseteado correctamente');
            } catch (error) {
                console.error('Error al resetear formulario:', error);
            }
        }

        // Enhanced Payment Functions
        function loadPendingInvoicesForPayment() {
            const select = document.getElementById('paymentInvoice');
            select.innerHTML = '<option value="">Seleccionar factura pendiente...</option>';
            
            // Update exchange rate fields with current global rate
            document.getElementById('paymentExchangeRate').value = exchangeRate;
            
            const pendingTransactions = transactions.filter(t => t.status === 'pending');
            pendingTransactions.forEach(transaction => {
                const provider = providers.find(p => p.id === transaction.providerId);
                const remainingAmount = calculateRemainingAmount(transaction);
                
                if (remainingAmount > 0) {
                    const option = document.createElement('option');
                    option.value = transaction.id;
                    option.textContent = `${transaction.invoiceNumber} - ${provider?.name || 'N/A'} - ${formatNumber(remainingAmount, transaction.currency)} pendiente`;
                    select.appendChild(option);
                }
            });
        }

        function onPaymentInvoiceSelect() {
            const transactionId = document.getElementById('paymentInvoice').value;
            if (!transactionId) {
                document.getElementById('invoiceDetails').classList.add('hidden');
                document.getElementById('pendingAmountDisplay').classList.add('hidden');
                return;
            }
            
            const transaction = transactions.find(t => t.id === transactionId);
            const provider = providers.find(p => p.id === transaction.providerId);
            const remainingAmount = calculateRemainingAmount(transaction);
            
            // Show invoice details
            document.getElementById('invoiceDetails').innerHTML = `
                <h4 class="font-semibold text-gray-800 mb-3">📄 Detalles de la Factura</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-gray-600">Número:</span>
                        <span class="font-semibold ml-2">${transaction.invoiceNumber}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Proveedor:</span>
                        <span class="font-semibold ml-2">${provider?.name || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Monto Original:</span>
                        <span class="font-semibold ml-2">${formatNumber(transaction.amount, transaction.currency)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Monto Pendiente:</span>
                        <span class="font-semibold ml-2 text-red-600">${formatNumber(remainingAmount, transaction.currency)}</span>
                    </div>
                </div>
            `;
            document.getElementById('invoiceDetails').classList.remove('hidden');
            
            // Set max amount to remaining amount only for non-VES currencies
            const paymentCurrency = document.getElementById('paymentCurrency').value;
            if (paymentCurrency !== 'VES') {
                document.getElementById('paymentAmount').max = remainingAmount;
            } else {
                // Remove max attribute for VES payments
                document.getElementById('paymentAmount').removeAttribute('max');
            }
            updatePaymentCalculations();
        }

        function updatePaymentCurrency() {
            const currency = document.getElementById('paymentCurrency').value;
            
            // Remove or set max attribute based on currency
            const paymentAmountInput = document.getElementById('paymentAmount');
            if (currency === 'VES') {
                // Remove max attribute for VES payments - no limits
                paymentAmountInput.removeAttribute('max');
            } else {
                // For USD, set max to remaining amount if available
                const transactionId = document.getElementById('paymentInvoice').value;
                if (transactionId) {
                    const transaction = transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        const remainingAmount = calculateRemainingAmount(transaction);
                        paymentAmountInput.max = remainingAmount;
                    }
                }
            }
            
            // If VES is selected, show info message about unlimited amounts
            const vesInfoElement = document.getElementById('vesPaymentInfo');
            if (!vesInfoElement) {
                // Create the info message if it doesn't exist
                const infoDiv = document.createElement('div');
                infoDiv.id = 'vesPaymentInfo';
                infoDiv.className = 'mt-4 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200 text-sm';
                
                const parent = document.getElementById('paymentConversionDisplay').parentElement;
                parent.appendChild(infoDiv);
            }
            
            // Update the info message based on currency
            if (vesInfoElement) {
                if (currency === 'VES') {
                    vesInfoElement.innerHTML = `
                        <div class="text-green-700">
                            <p class="font-semibold">✅ Pago en Bolívares</p>
                            <p class="text-xs">Los pagos en VES están permitidos sin límite de monto debido a la devaluación.</p>
                        </div>
                    `;
                    vesInfoElement.classList.remove('hidden');
                } else {
                    vesInfoElement.classList.add('hidden');
                }
            }
            
            updatePaymentCalculations();
            updateRealTimeConversion();
        }

        function updatePaymentCalculations() {
            const transactionId = document.getElementById('paymentInvoice').value;
            if (!transactionId) return;
            
            const transaction = transactions.find(t => t.id === transactionId);
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const paymentCurrency = document.getElementById('paymentCurrency').value;
            const currentRate = exchangeRate; // Use global exchange rate
            const method = document.getElementById('paymentMethod').value;
            
            if (paymentAmount > 0) {
                // Show currency conversion
                let amountUSD, amountVES;
                
                if (paymentCurrency === 'USD') {
                    amountUSD = paymentAmount;
                    amountVES = paymentAmount * currentRate;
                } else {
                    amountVES = paymentAmount;
                    amountUSD = paymentAmount / currentRate;
                }
                
                document.getElementById('amountUSD').textContent = formatNumber(amountUSD, 'USD');
                document.getElementById('amountVES').textContent = formatNumber(amountVES, 'VES');
                document.getElementById('currencyConversion').classList.remove('hidden');
                
                // Calculate remaining amount after payment
                const remainingAmount = calculateRemainingAmount(transaction);
                let paymentInTransactionCurrency = paymentAmount;
                
                if (paymentCurrency !== transaction.currency) {
                    if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                        paymentInTransactionCurrency = paymentAmount / currentRate;
                    } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                        paymentInTransactionCurrency = paymentAmount * currentRate;
                    }
                }
                
                const newRemainingAmount = Math.max(0, remainingAmount - paymentInTransactionCurrency);
                
                // Update payment summary
                document.getElementById('originalAmount').textContent = formatNumber(transaction.amount, transaction.currency);
                document.getElementById('payingAmount').textContent = formatNumber(paymentInTransactionCurrency, transaction.currency);
                document.getElementById('remainingAmount').textContent = formatNumber(newRemainingAmount, transaction.currency);
                document.getElementById('pendingAmountDisplay').classList.remove('hidden');
            } else {
                document.getElementById('currencyConversion').classList.add('hidden');
                document.getElementById('pendingAmountDisplay').classList.add('hidden');
            }
        }

        function toggleBankFields(method, formType) {
            const bankFieldsId = formType === 'payment' ? 'bankFields' : 'fullBankFields';
            const bankFields = document.getElementById(bankFieldsId);
            
            if (method === 'bank' || method === 'mobile') {
                bankFields.classList.remove('hidden');
                // Update exchange rate field with current global rate
                const rateField = formType === 'payment' ? 'paymentExchangeRate' : 'fullExchangeRate';
                document.getElementById(rateField).value = exchangeRate;
            } else {
                bankFields.classList.add('hidden');
            }
        }

        function processPayment(e) {
            e.preventDefault();
            
            // Validate required fields first
            const transactionId = document.getElementById('paymentInvoice').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentCurrency = document.getElementById('paymentCurrency').value;
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('referenceNumber').value;
            
            if (!transactionId || !paymentAmount || !paymentCurrency || !method) {
                showNotification('Por favor complete todos los campos requeridos', 'error');
                return;
            }
            
            // Validate required reference for specific payment methods
            if ((method === 'bank' || method === 'mobile') && !reference) {
                showNotification('La referencia es obligatoria para transferencias y pagos móviles', 'error');
                return;
            }
            
            // Show confirmation modal instead of direct processing
            showPaymentConfirmationModal();
        }
        
        function showPaymentConfirmationModal() {
            const transactionId = document.getElementById('paymentInvoice').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentCurrency = document.getElementById('paymentCurrency').value;
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('referenceNumber').value;
            const currentRate = exchangeRate;
            
            const transaction = transactions.find(t => t.id === transactionId);
            const provider = providers.find(p => p.id === transaction.providerId);
            const remainingAmount = calculateRemainingAmount(transaction);
            
            // Calculate conversions
            let paymentInTransactionCurrency = paymentAmount;
            let conversionText = '';
            
            if (paymentCurrency !== transaction.currency) {
                if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                    paymentInTransactionCurrency = paymentAmount / currentRate;
                    conversionText = `${formatNumber(paymentAmount, 'VES')} ÷ ${currentRate} = ${formatNumber(paymentInTransactionCurrency, 'USD')}`;
                } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                    paymentInTransactionCurrency = paymentAmount * currentRate;
                    conversionText = `${formatNumber(paymentAmount, 'USD')} × ${currentRate} = ${formatNumber(paymentInTransactionCurrency, 'VES')}`;
                }
            }
            
            const newRemaining = Math.max(0, remainingAmount - paymentInTransactionCurrency);
            
            // Populate modal
            document.getElementById('confirmInvoiceNumber').textContent = transaction.invoiceNumber;
            document.getElementById('confirmProvider').textContent = provider?.name || 'N/A';
            document.getElementById('confirmOriginalAmount').textContent = formatNumber(transaction.amount, transaction.currency);
            document.getElementById('confirmRemainingAmount').textContent = formatNumber(remainingAmount, transaction.currency);
            document.getElementById('confirmPaymentAmount').textContent = formatNumber(paymentAmount, paymentCurrency);
            document.getElementById('confirmPaymentMethod').textContent = getMethodDisplayName(method);
            document.getElementById('confirmExchangeRate').textContent = `1 USD = ${currentRate} VES`;
            document.getElementById('confirmNewRemaining').textContent = formatNumber(newRemaining, transaction.currency);
            
            // Show/hide conversion row
            const conversionRow = document.getElementById('confirmConversionRow');
            if (paymentCurrency !== transaction.currency) {
                document.getElementById('confirmConversionAmount').textContent = conversionText;
                conversionRow.classList.remove('hidden');
            } else {
                conversionRow.classList.add('hidden');
            }
            
            // Show/hide reference row
            const referenceRow = document.getElementById('confirmReferenceRow');
            if (reference) {
                document.getElementById('confirmReference').textContent = reference;
                referenceRow.classList.remove('hidden');
            } else {
                referenceRow.classList.add('hidden');
            }
            
            // Payment status
            const statusDiv = document.getElementById('confirmPaymentStatus');
            if (newRemaining === 0) {
                statusDiv.textContent = '✅ La factura quedará completamente pagada';
                statusDiv.className = 'mt-2 text-sm text-green-600';
            } else {
                statusDiv.textContent = '📝 La factura tendrá un saldo pendiente';
                statusDiv.className = 'mt-2 text-sm text-blue-600';
            }
            
            // Validation warnings - Special handling for VES payments
            const warningDiv = document.getElementById('confirmWarning');
            const warningText = document.getElementById('confirmWarningText');
            
            // Only show warning for non-VES payments that exceed the remaining amount
            if (paymentCurrency !== 'VES' && paymentInTransactionCurrency > remainingAmount) {
                warningText.textContent = 'El monto del abono excede el saldo pendiente de la factura';
                warningDiv.classList.remove('hidden');
            } else {
                warningDiv.classList.add('hidden');
            }
            
            // Show modal
            document.getElementById('paymentConfirmationModal').classList.remove('hidden');
        }
        
        function closePaymentConfirmationModal() {
            document.getElementById('paymentConfirmationModal').classList.add('hidden');
        }
        
        function confirmPaymentProcessing() {
            showLoading();
            closePaymentConfirmationModal();
            
            // Now process the actual payment
            processPaymentConfirmed();
        }
        
        function processPaymentConfirmed() {
            const transactionId = document.getElementById('paymentInvoice').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentCurrency = document.getElementById('paymentCurrency').value;
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('referenceNumber').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const currentRate = exchangeRate;
            const bankId = document.getElementById('bankId').value;
            
            const transaction = transactions.find(t => t.id === transactionId);
            const remainingAmount = calculateRemainingAmount(transaction);
            
            // Calculate payment in transaction currency
            let paymentInTransactionCurrency = paymentAmount;
            if (paymentCurrency !== transaction.currency) {
                if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                    paymentInTransactionCurrency = paymentAmount / currentRate;
                } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                    paymentInTransactionCurrency = paymentAmount * currentRate;
                }
            }
            
            // Enhanced payment details with explicit currency information
            let paymentDetailsText = '';
            if (paymentCurrency === 'USD') {
                paymentDetailsText = `💵 PAGO EN USD - ${getMethodDisplayName(method)}`;
                if (transaction.currency === 'VES') {
                    paymentDetailsText += ` (Equiv: ${formatNumber(paymentInTransactionCurrency, 'VES')} @ ${currentRate})`;
                }
            } else {
                paymentDetailsText = `🇻🇪 PAGO EN VES - ${getMethodDisplayName(method)}`;
                if (transaction.currency === 'USD') {
                    paymentDetailsText += ` (Equiv: ${formatNumber(paymentInTransactionCurrency, 'USD')} @ ${currentRate})`;
                }
            }
            
            // Create enhanced payment history entry
            const paymentEntry = {
                id: Date.now().toString(),
                transactionId: transaction.id,
                invoiceNumber: transaction.invoiceNumber,
                amount: paymentAmount,
                currency: paymentCurrency,
                method: method,
                methodDisplayName: getMethodDisplayName(method),
                reference: reference || '',
                date: paymentDate,
                exchangeRate: currentRate,
                bankId: bankId || '',
                paymentType: 'partial_payment',
                paymentDetails: paymentDetailsText,
                originalCurrency: transaction.currency,
                convertedAmount: paymentInTransactionCurrency,
                createdAt: new Date().toISOString(),
                user: currentUser.username
            };
            
            paymentHistory.push(paymentEntry);
            
            // Check if transaction is now fully paid
            const newRemainingAmount = remainingAmount - paymentInTransactionCurrency;
            if (newRemainingAmount <= 0.01) {
                transaction.status = 'paid';
                transaction.paymentDetails = {
                    method: method,
                    methodDisplayName: getMethodDisplayName(method),
                    reference: reference,
                    date: paymentDate,
                    finalPaymentId: paymentEntry.id,
                    finalPaymentCurrency: paymentCurrency,
                    finalPaymentAmount: paymentAmount
                };
            }
            
            saveAllData();
            
            // Enhanced logging with currency information
            const logMessage = paymentCurrency === transaction.currency ? 
                `Abono de ${formatNumber(paymentAmount, paymentCurrency)} a factura ${transaction.invoiceNumber}` :
                `Abono de ${formatNumber(paymentAmount, paymentCurrency)} (${formatNumber(paymentInTransactionCurrency, transaction.currency)}) a factura ${transaction.invoiceNumber}`;
            
            logAction('PROCESS_PAYMENT', logMessage);
            
            // Reset form
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDetails').classList.add('hidden');
            document.getElementById('paymentConversionDisplay').classList.add('hidden');
            document.getElementById('paymentCalculationSummary').classList.add('hidden');
            
            hideLoading();
            
            // Enhanced success notification
            if (newRemainingAmount <= 0.01) {
                showNotification(`✅ ¡Factura ${transaction.invoiceNumber} pagada completamente en ${paymentCurrency}!`, 'success');
            } else {
                showNotification(`✅ Abono procesado en ${paymentCurrency}. Pendiente: ${formatNumber(newRemainingAmount, transaction.currency)}`, 'success');
            }
            
            // Auto-actualizar reportes después del pago
            autoRefreshReportsIfNeeded();
            
            showPage('list');
        }        // Full Payment Functions
        function loadPendingInvoicesForFullPayment() {
            const select = document.getElementById('fullPaymentInvoice');
            select.innerHTML = '<option value="">Seleccionar factura pendiente...</option>';
            
            // Update exchange rate fields with current global rate
            document.getElementById('fullExchangeRate').value = exchangeRate;
            
            const pendingTransactions = transactions.filter(t => t.status === 'pending');
            pendingTransactions.forEach(transaction => {
                const provider = providers.find(p => p.id === transaction.providerId);
                const remainingAmount = calculateRemainingAmount(transaction);
                
                if (remainingAmount > 0) {
                    const option = document.createElement('option');
                    option.value = transaction.id;
                    option.textContent = `${transaction.invoiceNumber} - ${provider?.name || 'N/A'} - ${formatNumber(remainingAmount, transaction.currency)} pendiente`;
                    select.appendChild(option);
                }
            });
        }

        function onFullPaymentInvoiceSelect() {
            const transactionId = document.getElementById('fullPaymentInvoice').value;
            if (!transactionId) {
                document.getElementById('fullInvoiceDetails').classList.add('hidden');
                document.getElementById('fullPaymentSummary').classList.add('hidden');
                return;
            }
            
            const transaction = transactions.find(t => t.id === transactionId);
            const provider = providers.find(p => p.id === transaction.providerId);
            const remainingAmount = calculateRemainingAmount(transaction);
            
            // Show invoice details
            document.getElementById('fullInvoiceDetails').innerHTML = `
                <h4 class="font-semibold text-gray-800 mb-3">📄 Detalles de la Factura</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-gray-600">Número:</span>
                        <span class="font-semibold ml-2">${transaction.invoiceNumber}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Proveedor:</span>
                        <span class="font-semibold ml-2">${provider?.name || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Monto Original:</span>
                        <span class="font-semibold ml-2">${formatNumber(transaction.amount, transaction.currency)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Monto Pendiente:</span>
                        <span class="font-semibold ml-2 text-red-600">${formatNumber(remainingAmount, transaction.currency)}</span>
                    </div>
                </div>
            `;
            document.getElementById('fullInvoiceDetails').classList.remove('hidden');
            
            // Set amount to remaining amount and update display
            document.getElementById('fullPaymentAmount').value = remainingAmount;
            updateFullPaymentCalculations();
        }

        function updateFullPaymentCurrency() {
            const currency = document.getElementById('fullPaymentCurrency').value;
            
            // Remove or set max attribute based on currency
            const fullPaymentAmountInput = document.getElementById('fullPaymentAmount');
            if (currency === 'VES') {
                // Remove max attribute for VES payments - no limits
                fullPaymentAmountInput.removeAttribute('max');
            } else {
                // For USD, set max to remaining amount if available
                const transactionId = document.getElementById('fullPaymentInvoice').value;
                if (transactionId) {
                    const transaction = transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        const remainingAmount = calculateRemainingAmount(transaction);
                        fullPaymentAmountInput.max = remainingAmount;
                    }
                }
            }
            
            // If VES is selected, show info message about unlimited amounts
            const vesInfoElement = document.getElementById('vesFullPaymentInfo');
            if (!vesInfoElement) {
                // Create the info message if it doesn't exist
                const infoDiv = document.createElement('div');
                infoDiv.id = 'vesFullPaymentInfo';
                infoDiv.className = 'mt-4 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200 text-sm';
                
                const parent = document.getElementById('fullPaymentConversionDisplay').parentElement;
                parent.appendChild(infoDiv);
            }
            
            // Update the info message based on currency
            if (vesInfoElement) {
                if (currency === 'VES') {
                    vesInfoElement.innerHTML = `
                        <div class="text-green-700">
                            <p class="font-semibold">✅ Pago en Bolívares</p>
                            <p class="text-xs">Los pagos en VES están permitidos sin límite de monto debido a la devaluación.</p>
                        </div>
                    `;
                    vesInfoElement.classList.remove('hidden');
                } else {
                    vesInfoElement.classList.add('hidden');
                }
            }
            
            updateFullPaymentCalculations();
            updateRealTimeConversionFull();
        }

        function updateFullPaymentCalculations() {
            const transactionId = document.getElementById('fullPaymentInvoice').value;
            if (!transactionId) return;
            
            const transaction = transactions.find(t => t.id === transactionId);
            const paymentAmount = parseFloat(document.getElementById('fullPaymentAmount').value) || 0;
            const paymentCurrency = document.getElementById('fullPaymentCurrency').value;
            const currentRate = exchangeRate; // Use global exchange rate
            
            if (paymentAmount > 0) {
                // Show currency conversion
                let amountUSD, amountVES;
                
                if (paymentCurrency === 'USD') {
                    amountUSD = paymentAmount;
                    amountVES = paymentAmount * currentRate;
                } else {
                    amountVES = paymentAmount;
                    amountUSD = paymentAmount / currentRate;
                }
                
                document.getElementById('fullAmountUSD').textContent = formatNumber(amountUSD, 'USD');
                document.getElementById('fullAmountVES').textContent = formatNumber(amountVES, 'VES');
                document.getElementById('fullCurrencyConversion').classList.remove('hidden');
                
                // Calculate payment in transaction currency
                let paymentInTransactionCurrency = paymentAmount;
                if (paymentCurrency !== transaction.currency) {
                    if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                        paymentInTransactionCurrency = paymentAmount / currentRate;
                    } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                        paymentInTransactionCurrency = paymentAmount * currentRate;
                    }
                }
                
                // Update payment summary
                const remainingAmount = calculateRemainingAmount(transaction);
                document.getElementById('fullOriginalAmount').textContent = formatNumber(remainingAmount, transaction.currency);
                document.getElementById('fullPayingAmount').textContent = formatNumber(paymentInTransactionCurrency, transaction.currency);
                document.getElementById('fullPaymentSummary').classList.remove('hidden');
            } else {
                document.getElementById('fullCurrencyConversion').classList.add('hidden');
                document.getElementById('fullPaymentSummary').classList.add('hidden');
            }
        }

        function processFullPayment(e) {
            e.preventDefault();
            showLoading();
            
            const transactionId = document.getElementById('fullPaymentInvoice').value;
            const paymentAmount = parseFloat(document.getElementById('fullPaymentAmount').value);
            const paymentCurrency = document.getElementById('fullPaymentCurrency').value;
            const method = document.getElementById('fullPaymentMethod').value;
            const reference = document.getElementById('fullReferenceNumber').value;
            const paymentDate = document.getElementById('fullPaymentDate').value;
            const currentRate = exchangeRate; // Use global exchange rate
            const bankId = document.getElementById('fullBankId').value;
            
            // Validate required reference for specific payment methods
            if ((method === 'bank' || method === 'mobile') && !reference) {
                hideLoading();
                showNotification('La referencia es obligatoria para transferencias y pagos móviles', 'error');
                return;
            }
            
            const transaction = transactions.find(t => t.id === transactionId);
            
            // Calculate remaining amount
            const remainingAmount = calculateRemainingAmount(transaction);
            
            // Convert amounts for validation
            let paymentInTransactionCurrency = paymentAmount;
            let originalRemainingInPaymentCurrency = remainingAmount;
            
            // Two-way conversion for accurate validation
            if (paymentCurrency !== transaction.currency) {
                if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                    // Convert VES payment to USD
                    paymentInTransactionCurrency = paymentAmount / currentRate;
                } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                    // Convert USD payment to VES
                    paymentInTransactionCurrency = paymentAmount * currentRate;
                }
                
                // Also convert remaining amount to payment currency
                if (transaction.currency === 'USD' && paymentCurrency === 'VES') {
                    // Convert USD remaining to VES
                    originalRemainingInPaymentCurrency = remainingAmount * currentRate;
                } else if (transaction.currency === 'VES' && paymentCurrency === 'USD') {
                    // Convert VES remaining to USD
                    originalRemainingInPaymentCurrency = remainingAmount / currentRate;
                }
            }
            
            // Validation for full payment: Special handling for VES payments
            if (paymentCurrency === 'VES') {
                // For VES payments, allow any amount - devaluation makes VES amounts naturally larger
                // No validation needed as VES is the local currency and amounts will be higher
            } else if (paymentCurrency === transaction.currency) {
                // Same currency: direct comparison - but skip validation for VES
                if (paymentCurrency !== 'VES' && paymentAmount > remainingAmount) {
                    hideLoading();
                    showNotification(`El monto del pago (${formatNumber(paymentAmount, paymentCurrency)}) no puede ser mayor al monto pendiente (${formatNumber(remainingAmount, transaction.currency)}). Por favor corrija el monto.`, 'error');
                    return;
                }
            } else {
                // Different currencies, and payment is in USD: validate normally
                if (paymentCurrency === 'USD' && paymentInTransactionCurrency > remainingAmount) {
                    hideLoading();
                    const remainingInPaymentCurrency = remainingAmount / currentRate;
                    showNotification(`El monto del pago equivale a ${formatNumber(paymentInTransactionCurrency, transaction.currency)} y no puede ser mayor al monto pendiente de ${formatNumber(remainingAmount, transaction.currency)}. Máximo permitido: ${formatNumber(remainingInPaymentCurrency, paymentCurrency)}`, 'error');
                    return;
                }
            }
            
            // Create payment history entry
            const paymentEntry = {
                id: Date.now().toString(),
                transactionId: transaction.id,
                invoiceNumber: transaction.invoiceNumber,
                amount: paymentAmount,
                currency: paymentCurrency,
                method: method,
                reference: reference,
                date: paymentDate,
                exchangeRate: currentRate,
                bankId: bankId,
                paymentType: 'full_payment',
                paymentDetails: `Pago completo en ${paymentCurrency === 'USD' ? 'Dólares' : 'Bolívares'} - ${getMethodDisplayName(method)}`,
                createdAt: new Date().toISOString(),
                user: currentUser.username
            };
            
            paymentHistory.push(paymentEntry);
            
            // Mark transaction as paid
            transaction.status = 'paid';
            transaction.paymentDetails = {
                method: method,
                reference: reference,
                date: paymentDate,
                finalPaymentId: paymentEntry.id
            };
            
            saveAllData();
            
            logAction('PROCESS_FULL_PAYMENT', `Pago completo de ${formatNumber(paymentAmount, paymentCurrency)} para factura ${transaction.invoiceNumber}`);
            
            document.getElementById('fullPaymentForm').reset();
            document.getElementById('fullPaymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('fullInvoiceDetails').classList.add('hidden');
            document.getElementById('fullCurrencyConversion').classList.add('hidden');
            document.getElementById('fullPaymentSummary').classList.add('hidden');
            
            hideLoading();
            showNotification('¡Factura pagada completamente!', 'success');
            
            // Auto-actualizar reportes después del pago completo
            autoRefreshReportsIfNeeded();
            
            showPage('list');
        }

        // View Transaction Functions
        function viewTransaction(transactionId) {
            currentViewedTransaction = transactions.find(t => t.id === transactionId);
            if (!currentViewedTransaction) return;
            
            const provider = providers.find(p => p.id === currentViewedTransaction.providerId);
            const remainingAmount = calculateRemainingAmount(currentViewedTransaction);
            const transactionPayments = paymentHistory.filter(p => p.transactionId === transactionId);
            
            document.getElementById('viewTransactionContent').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Basic Information -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">📄 Información Básica</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Número de Factura:</span>
                                    <span class="font-semibold">${currentViewedTransaction.invoiceNumber}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tipo:</span>
                                    <span class="font-semibold">${
                                        currentViewedTransaction.type === 'payable' ? '💸 Por Pagar' : 
                                        currentViewedTransaction.type === 'receivable' ? '💰 Por Cobrar' :
                                        currentViewedTransaction.type === 'income' ? '💰 Entradas' : 
                                        currentViewedTransaction.type === 'expense' ? '💸 Salidas' : currentViewedTransaction.type
                                    }</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proveedor:</span>
                                    <span class="font-semibold">${provider?.name || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Fecha:</span>
                                    <span class="font-semibold">${formatDate(currentViewedTransaction.date)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Estado:</span>
                                    <span class="badge-modern ${currentViewedTransaction.status === 'paid' ? 'status-paid' : currentViewedTransaction.status === 'annulled' ? 'status-cancelled' : 'status-pending'} text-white">
                                        ${currentViewedTransaction.status === 'paid' ? '✅ Pagada' : currentViewedTransaction.status === 'annulled' ? '❌ Anulada' : '⏳ Pendiente'}
                                    </span>
                                </div>
                                ${currentViewedTransaction.status === 'annulled' ? `
                                <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <h5 class="text-red-700 font-semibold mb-2">Información de Anulación:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Fecha de Anulación:</span>
                                            <span class="font-medium">${formatDate(currentViewedTransaction.annulledAt || new Date())}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Anulado por:</span>
                                            <span class="font-medium">${currentViewedTransaction.annulledBy || currentUser.username}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Motivo:</span>
                                            <span class="font-medium">${currentViewedTransaction.annulReason === 'error' ? 'Error en Datos' : 
                                                currentViewedTransaction.annulReason === 'duplicate' ? 'Factura Duplicada' : 
                                                currentViewedTransaction.annulReason === 'replacement' ? 'Reemplazo por Otra Factura' : 
                                                currentViewedTransaction.annulReason === 'cancelled' ? 'Operación Cancelada' : 
                                                currentViewedTransaction.annulReason || 'Otro'}</span>
                                        </div>
                                        ${currentViewedTransaction.replacementInvoiceNumber ? `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Factura de Reemplazo:</span>
                                            <span class="font-medium">${currentViewedTransaction.replacementInvoiceNumber}</span>
                                        </div>
                                        ` : ''}
                                        <div class="mt-2">
                                            <span class="text-gray-600 block mb-1">Descripción:</span>
                                            <p class="bg-white p-2 rounded border border-red-100 text-sm">${currentViewedTransaction.annulDescription || 'Sin descripción'}</p>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">💰 Información Financiera</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Monto Original:</span>
                                    <span class="font-bold text-lg">${formatNumber(currentViewedTransaction.amount, currentViewedTransaction.currency)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Monto Pendiente:</span>
                                    <span class="font-bold text-lg ${remainingAmount > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${remainingAmount > 0 ? formatNumber(remainingAmount, currentViewedTransaction.currency) : 'Cancelado'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Moneda:</span>
                                    <span class="font-semibold">${currentViewedTransaction.currency === 'USD' ? '🇺🇸 USD' : '🇻🇪 VES'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment History -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">📊 Historial de Pagos</h4>
                            ${transactionPayments.length > 0 ? `
                                <div class="space-y-3 max-h-64 overflow-y-auto">
                                    ${transactionPayments.map(payment => `
                                        <div class="p-4 bg-gray-50 rounded-xl border">
                                            <div class="flex justify-between items-start mb-2">
                                                <span class="text-sm font-semibold">${payment.paymentType === 'full_payment' ? '💰 Pago Completo' : '💳 Abono'}</span>
                                                <span class="text-sm text-gray-500">${formatDate(payment.date)}</span>
                                            </div>
                                            <div class="text-lg font-bold text-green-600">${formatNumber(payment.amount, payment.currency)}</div>
                                            <div class="text-sm text-gray-600 mt-1">
                                                ${payment.paymentDetails || getMethodDisplayName(payment.method)}
                                                ${payment.reference ? ` | Ref: ${payment.reference}` : ''}
                                            </div>
                                            <div class="text-sm font-semibold mt-1 ${payment.currency === 'USD' ? 'text-green-700' : 'text-blue-700'}">
                                                💱 Pagado en ${payment.currency === 'USD' ? 'Dólares (USD)' : 'Bolívares (VES)'}
                                            </div>
                                            ${payment.exchangeRate && payment.exchangeRate !== 1 ? `
                                                <div class="text-xs text-gray-500 mt-1">Tasa de cambio: ${payment.exchangeRate}</div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-8 text-gray-500">
                                    <div class="text-4xl mb-2">💳</div>
                                    <p>No hay pagos registrados</p>
                                </div>
                            `}
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">📝 Descripción</h4>
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <p class="text-gray-700">${currentViewedTransaction.description || 'Sin descripción'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update modal footer with dynamic buttons
            const modalFooter = document.getElementById('viewTransactionFooter');
            let footerButtons = '';
            
            // Add payment button if transaction is pending
            if (currentViewedTransaction.status === 'pending') {
                footerButtons += `
                    <button onclick="goToPayment('${currentViewedTransaction.id}')" class="btn-modern px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                        <span class="flex items-center space-x-2">
                            <span>💳</span>
                            <span>Abonar</span>
                        </span>
                    </button>
                `;
            }
            
            // Add edit button
            footerButtons += `
                <button id="editTransactionBtn" onclick="editViewedTransaction()" class="btn-modern px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all">
                    <span class="flex items-center space-x-2">
                        <span>✏️</span>
                        <span>Editar Factura</span>
                    </span>
                </button>
            `;
            
            // Add master-only buttons
            if (currentUser.role === 'master') {
                footerButtons += `
                    <button id="deleteTransactionBtn" onclick="deleteViewedTransaction()" class="btn-modern px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all">
                        <span class="flex items-center space-x-2">
                            <span>🗑️</span>
                            <span>Eliminar</span>
                        </span>
                    </button>
                `;
                
                if (currentViewedTransaction.status === 'pending') {
                    footerButtons += `
                        <button onclick="annulTransaction('${currentViewedTransaction.id}')" class="btn-modern px-6 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-all">
                            <span class="flex items-center space-x-2">
                                <span>🚫</span>
                                <span>Anular</span>
                            </span>
                        </button>
                    `;
                }
            }
            
            // Add close button
            footerButtons += `
                <button onclick="closeViewTransactionModal()" class="btn-modern px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all">
                    Cerrar
                </button>
            `;
            
            modalFooter.innerHTML = footerButtons;
            
            document.getElementById('viewTransactionModal').classList.remove('hidden');
        }

        function closeViewTransactionModal() {
            document.getElementById('viewTransactionModal').classList.add('hidden');
            // La variable currentViewedTransaction se limpiará después de usarla en editViewedTransaction
            // para evitar problemas al editar
        }

        function editViewedTransaction() {
            try {
                console.log('Iniciando edición de transacción...');
                
                // Verificar si tenemos una transacción para editar
                if (!currentViewedTransaction) {
                    console.error('No hay transacción seleccionada para editar');
                    showNotification('Error: No hay transacción seleccionada para editar', 'error');
                    return;
                }
                
                console.log('Datos de transacción a editar:', JSON.stringify(currentViewedTransaction));
                
                // Guardar una copia de la transacción actual antes de cerrar el modal
                const transactionToEdit = Object.assign({}, currentViewedTransaction);
                
                // Cerrar el modal primero
                closeViewTransactionModal();
                
                // Luego cambiar a la página de agregar
                showPage('add');
                
                // Esperar a que la página se cargue completamente
                setTimeout(() => {
                    try {
                        console.log('Llenando formulario con datos de transacción...');
                        
                        // Verificar si los elementos del formulario existen
                        const invoiceNumberEl = document.getElementById('invoiceNumber');
                        const transactionTypeEl = document.getElementById('transactionType');
                        const providerIdEl = document.getElementById('providerId');
                        const amountEl = document.getElementById('amount');
                        const currencyEl = document.getElementById('currency');
                        const transactionDateEl = document.getElementById('transactionDate');
                        const descriptionEl = document.getElementById('description');
                        
                        if (!invoiceNumberEl || !transactionTypeEl || !providerIdEl || 
                            !amountEl || !currencyEl || !transactionDateEl || !descriptionEl) {
                            console.error('No se encontraron todos los elementos del formulario');
                            showNotification('Error: Elementos del formulario no encontrados', 'error');
                            return;
                        }
                        
                        // Llenar el formulario con los datos de la transacción
                        invoiceNumberEl.value = transactionToEdit.invoiceNumber || '';
                        transactionTypeEl.value = transactionToEdit.type || '';
                        providerIdEl.value = transactionToEdit.providerId || '';
                        amountEl.value = transactionToEdit.amount || '';
                        currencyEl.value = transactionToEdit.currency || 'USD';
                        transactionDateEl.value = transactionToEdit.date || '';
                        descriptionEl.value = transactionToEdit.description || '';
                        
                        console.log('Campos básicos llenados correctamente');
                        
                        // Actualizar detalles de pago si existen
                        if (transactionToEdit.paymentDetails && transactionToEdit.paymentDetails.type) {
                            const paymentTypeEl = document.getElementById('paymentType');
                            if (paymentTypeEl) {
                                paymentTypeEl.value = transactionToEdit.paymentDetails.type;
                                
                                // Referencia de pago si existe
                                if (transactionToEdit.paymentDetails.reference) {
                                    // Esperar a que los campos de pago se muestren
                                    setTimeout(() => {
                                        const referenceInput = document.getElementById('referenceInput');
                                        if (referenceInput) {
                                            referenceInput.value = transactionToEdit.paymentDetails.reference;
                                        }
                                    }, 100);
                                }
                                
                                // Mostrar campos de pago correspondientes
                                if (typeof togglePaymentFields === 'function') {
                                    togglePaymentFields(transactionToEdit.paymentDetails.type);
                                }
                            }
                        }
                        
                        // Cambiar formulario a modo edición
                        const form = document.getElementById('addTransactionForm');
                        if (form) {
                            form.setAttribute('data-edit-id', transactionToEdit.id);
                            
                            // Actualizar texto del botón
                            const submitButton = document.querySelector('#addTransactionForm button[type="submit"]');
                            if (submitButton) {
                                submitButton.innerHTML = `
                                    <span class="flex items-center justify-center space-x-2">
                                        <span>💾</span>
                                        <span>Actualizar Transacción</span>
                                    </span>
                                `;
                            }
                            
                            // Actualizar título de la página
                            const pageTitle = document.querySelector('#addPage h2');
                            if (pageTitle) {
                                pageTitle.textContent = 'Editar Transacción';
                            }
                            
                            const pageSubtitle = document.querySelector('#addPage p');
                            if (pageSubtitle) {
                                pageSubtitle.textContent = 'Modifica los datos de la transacción existente';
                            }
                        }
                        
                        // Cargar proveedores para el dropdown
                        console.log('Cargando proveedores para el formulario...');
                        loadProvidersForAddForm();
                        
                        console.log('Formulario de edición llenado completamente');
                        showNotification('Transacción lista para editar', 'success');
                        
                    } catch (error) {
                        console.error('Error al llenar formulario para edición:', error);
                        showNotification('Error al cargar los datos para edición: ' + error.message, 'error');
                    }
                }, 300); // Aumentar el tiempo de espera a 300ms
                
            } catch (error) {
                console.error('Error general en editViewedTransaction:', error);
                showNotification('Error general al editar: ' + error.message, 'error');
            }
        }

        function goToPayment(transactionId) {
            showPage('payment');
            document.getElementById('paymentInvoice').value = transactionId;
            document.getElementById('paymentInvoice').dispatchEvent(new Event('change'));
            closeViewTransactionModal();
        }

        function closeEditTransactionModal() {
            document.getElementById('editTransactionModal').classList.add('hidden');
        }

        function saveEditedTransaction() {
            if (!currentViewedTransaction) return;
            
            showLoading();
            
            const invoiceNumber = document.getElementById('editInvoiceNumber').value;
            const type = document.getElementById('editTransactionType').value;
            const providerId = document.getElementById('editProviderId').value;
            const currency = document.getElementById('editCurrency').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const date = document.getElementById('editTransactionDate').value;
            const description = document.getElementById('editDescription').value;
            
            // Check if invoice number already exists (excluding current transaction)
            const existingTransaction = transactions.find(t => t.invoiceNumber === invoiceNumber && t.id !== currentViewedTransaction.id);
            if (existingTransaction) {
                hideLoading();
                showNotification('El número de factura ya existe', 'error');
                return;
            }
            
            // Update transaction
            const transaction = transactions.find(t => t.id === currentViewedTransaction.id);
            transaction.invoiceNumber = invoiceNumber;
            transaction.type = type;
            transaction.providerId = providerId;
            transaction.currency = currency;
            transaction.amount = amount;
            transaction.date = date;
            transaction.description = description;
            transaction.updatedAt = new Date().toISOString();
            
            saveAllData();
            
            logAction('EDIT_TRANSACTION', `Editada transacción ${invoiceNumber}`);
            
            hideLoading();
            closeEditTransactionModal();
            showNotification('Transacción actualizada exitosamente', 'success');
            loadTransactions(); // Refresh list
        }

        function deleteViewedTransaction() {
            if (!currentViewedTransaction || currentUser.role !== 'master') return;
            
            if (confirm(`¿Está seguro de eliminar la transacción ${currentViewedTransaction.invoiceNumber}?\n\nEsta acción no se puede deshacer.`)) {
                showLoading();
                
                // Remove transaction
                transactions = transactions.filter(t => t.id !== currentViewedTransaction.id);
                
                // Remove related payment history
                paymentHistory = paymentHistory.filter(p => p.transactionId !== currentViewedTransaction.id);
                
                saveAllData();
                
                logAction('DELETE_TRANSACTION', `Eliminada transacción ${currentViewedTransaction.invoiceNumber}`);
                
                hideLoading();
                closeViewTransactionModal();
                showNotification('Transacción eliminada exitosamente', 'success');
                loadTransactions(); // Refresh list
                
                // Auto-actualizar reportes después de eliminar transacción
                autoRefreshReportsIfNeeded();
            }
        }

        function annulTransaction(transactionId) {
            if (currentUser.role !== 'master') return;
            
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Show modal to get annulation details
            showAnnulTransactionModal(transaction);
        }
        
        function showAnnulTransactionModal(transaction) {
            // Create modal if it doesn't exist
            if (!document.getElementById('annulTransactionModal')) {
                const modal = document.createElement('div');
                modal.id = 'annulTransactionModal';
                modal.className = 'modal-container hidden';
                modal.innerHTML = `
                    <div class="modal-content max-w-2xl animate-scale-up">
                        <div class="bg-white rounded-xl overflow-hidden shadow-xl">
                            <div class="bg-gradient-to-r from-red-500 to-red-600 px-8 py-6">
                                <h3 class="text-2xl font-bold text-white">Anular Transacción</h3>
                                <p class="text-red-100">Por favor especifique los detalles de anulación</p>
                            </div>
                            
                            <div class="p-8 space-y-6">
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Factura a Anular</label>
                                            <div id="annulInvoiceNumber" class="px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 font-semibold"></div>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Monto</label>
                                            <div id="annulInvoiceAmount" class="px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 font-semibold"></div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">Motivo de Anulación</label>
                                        <select id="annulReason" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                            <option value="error">Error en Datos</option>
                                            <option value="duplicate">Factura Duplicada</option>
                                            <option value="replacement">Reemplazo por Otra Factura</option>
                                            <option value="cancelled">Operación Cancelada</option>
                                            <option value="other">Otro Motivo</option>
                                        </select>
                                    </div>
                                    
                                    <div id="replacementInvoiceContainer" class="hidden">
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">Factura de Reemplazo</label>
                                        <select id="replacementInvoice" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                            <option value="">Seleccionar factura de reemplazo...</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">Descripción</label>
                                        <textarea id="annulDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" 
                                            placeholder="Describa el motivo de anulación..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 px-8 py-6 flex justify-end space-x-3">
                                <button onclick="confirmAnnulTransaction()" class="px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all font-semibold">
                                    <span class="flex items-center space-x-2">
                                        <span>🗑️</span>
                                        <span>Anular Transacción</span>
                                    </span>
                                </button>
                                <button onclick="closeAnnulTransactionModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-semibold">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add event listener for annul reason change
                document.getElementById('annulReason').addEventListener('change', function() {
                    const replacementContainer = document.getElementById('replacementInvoiceContainer');
                    if (this.value === 'replacement') {
                        replacementContainer.classList.remove('hidden');
                        loadAvailableInvoicesForReplacement();
                    } else {
                        replacementContainer.classList.add('hidden');
                    }
                });
            }
            
            // Populate modal with transaction details
            document.getElementById('annulInvoiceNumber').textContent = transaction.invoiceNumber;
            document.getElementById('annulInvoiceAmount').textContent = formatNumber(transaction.amount, transaction.currency);
            
            // Store transaction ID in modal
            document.getElementById('annulTransactionModal').setAttribute('data-transaction-id', transaction.id);
            
            // Show modal
            document.getElementById('annulTransactionModal').classList.remove('hidden');
        }
        
        function loadAvailableInvoicesForReplacement() {
            const select = document.getElementById('replacementInvoice');
            select.innerHTML = '<option value="">Seleccionar factura de reemplazo...</option>';
            
            const currentTransactionId = document.getElementById('annulTransactionModal').getAttribute('data-transaction-id');
            const currentTransaction = transactions.find(t => t.id === currentTransactionId);
            
            if (!currentTransaction) return;
            
            // Filter invoices that could be valid replacements
            const eligibleTransactions = transactions.filter(t => 
                t.id !== currentTransactionId && // Not the same transaction
                t.status !== 'annulled' && // Not already annulled
                t.type === currentTransaction.type && // Same type (payable/receivable)
                t.providerId === currentTransaction.providerId // Same provider
            );
            
            eligibleTransactions.forEach(transaction => {
                const option = document.createElement('option');
                option.value = transaction.id;
                option.textContent = `${transaction.invoiceNumber} - ${formatNumber(transaction.amount, transaction.currency)}`;
                select.appendChild(option);
            });
        }
        
        function closeAnnulTransactionModal() {
            document.getElementById('annulTransactionModal').classList.add('hidden');
            document.getElementById('annulDescription').value = '';
            document.getElementById('annulReason').value = 'error';
            document.getElementById('replacementInvoiceContainer').classList.add('hidden');
        }
        
        function confirmAnnulTransaction() {
            const transactionId = document.getElementById('annulTransactionModal').getAttribute('data-transaction-id');
            const transaction = transactions.find(t => t.id === transactionId);
            
            if (!transaction) {
                closeAnnulTransactionModal();
                return;
            }
            
            const reason = document.getElementById('annulReason').value;
            const description = document.getElementById('annulDescription').value;
            let replacementId = null;
            
            if (reason === 'replacement') {
                replacementId = document.getElementById('replacementInvoice').value;
                if (!replacementId) {
                    showNotification('Debe seleccionar una factura de reemplazo', 'error');
                    return;
                }
            }
            
            if (!description) {
                showNotification('Debe proporcionar una descripción para la anulación', 'error');
                return;
            }
            
            showLoading();
            
            // Update transaction status
            transaction.status = 'annulled';
            transaction.annulledAt = new Date().toISOString();
            transaction.annulledBy = currentUser.username;
            transaction.annulReason = reason;
            transaction.annulDescription = description;
            
            if (replacementId) {
                const replacementTransaction = transactions.find(t => t.id === replacementId);
                transaction.replacementInvoiceId = replacementId;
                transaction.replacementInvoiceNumber = replacementTransaction?.invoiceNumber || '';
            }
            
            saveAllData();
            
            const actionDescription = replacementId ? 
                `Anulada transacción ${transaction.invoiceNumber} por reemplazo con ${transaction.replacementInvoiceNumber}` : 
                `Anulada transacción ${transaction.invoiceNumber} por motivo: ${reason}`;
            
            logAction('ANNUL_TRANSACTION', actionDescription);
            
            hideLoading();
            closeAnnulTransactionModal();
            showNotification('Transacción anulada exitosamente', 'success');
            loadTransactions(); // Refresh list
            
            // Auto-actualizar reportes después de anular transacción
            autoRefreshReportsIfNeeded();
        }

        // Provider Functions
        function loadProviders() {
            const container = document.getElementById('providersList');
            container.innerHTML = '';
            
            providers.forEach(provider => {
                const providerCard = createProviderCard(provider);
                container.appendChild(providerCard);
            });
        }

        function createProviderCard(provider) {
            const card = document.createElement('div');
            card.className = 'card-modern p-6 animate-fade-in';
            
            // Count transactions for this provider
            const transactionCount = transactions.filter(t => t.providerId === provider.id).length;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                        ${provider.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editProvider('${provider.id}')" class="btn-modern p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        ${currentUser.role === 'master' ? `
                            <button onclick="deleteProvider('${provider.id}')" class="btn-modern p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-800 mb-2">${provider.name}</h3>
                <div class="text-sm text-gray-600 mb-4">
                    <div class="flex items-center space-x-2">
                        <span>📊</span>
                        <span>${transactionCount} transacciones registradas</span>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="showProviderTransactions('${provider.id}')" class="w-full btn-modern px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all text-sm">
                        Ver Transacciones
                    </button>
                </div>
            `;
            
            return card;
        }

        function showAddProviderForm() {
            document.getElementById('addProviderForm').classList.remove('hidden');
            document.getElementById('newProviderName').focus();
        }

        function hideAddProviderForm() {
            document.getElementById('addProviderForm').classList.add('hidden');
            document.getElementById('newProviderName').value = '';
        }

        function addProvider() {
            const name = document.getElementById('newProviderName').value.trim();
            
            if (!name) {
                showNotification('Por favor ingrese el nombre del proveedor', 'error');
                return;
            }
            
            // Check if provider already exists
            if (providers.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                showNotification('El proveedor ya existe', 'error');
                return;
            }
            
            const provider = {
                id: Date.now().toString(),
                name: name,
                createdAt: new Date().toISOString()
            };
            
            providers.push(provider);
            saveAllData();
            
            logAction('CREATE_PROVIDER', `Creado proveedor: ${name}`);
            
            hideAddProviderForm();
            showNotification('Proveedor agregado exitosamente', 'success');
            loadProviders();
        }

        function editProvider(providerId) {
            const provider = providers.find(p => p.id === providerId);
            if (!provider) return;
            
            const newName = prompt('Ingrese el nuevo nombre del proveedor:', provider.name);
            if (newName && newName.trim() && newName.trim() !== provider.name) {
                // Check if new name already exists
                if (providers.find(p => p.name.toLowerCase() === newName.trim().toLowerCase() && p.id !== providerId)) {
                    showNotification('El nombre del proveedor ya existe', 'error');
                    return;
                }
                
                provider.name = newName.trim();
                provider.updatedAt = new Date().toISOString();
                saveAllData();
                
                logAction('EDIT_PROVIDER', `Editado proveedor: ${provider.name}`);
                
                showNotification('Proveedor actualizado exitosamente', 'success');
                loadProviders();
            }
        }

        function deleteProvider(providerId) {
            if (currentUser.role !== 'master') return;
            
            const provider = providers.find(p => p.id === providerId);
            if (!provider) return;
            
            // Check if provider has transactions
            const hasTransactions = transactions.some(t => t.providerId === providerId);
            if (hasTransactions) {
                showNotification('No se puede eliminar un proveedor que tiene transacciones asociadas', 'error');
                return;
            }
            
            if (confirm(`¿Está seguro de eliminar el proveedor "${provider.name}"?`)) {
                providers = providers.filter(p => p.id !== providerId);
                saveAllData();
                
                logAction('DELETE_PROVIDER', `Eliminado proveedor: ${provider.name}`);
                
                showNotification('Proveedor eliminado exitosamente', 'success');
                loadProviders();
            }
        }

        function showProviderTransactions(providerId) {
            const provider = providers.find(p => p.id === providerId);
            if (!provider) return;
            
            // Filter transactions and switch to list view
            document.getElementById('searchFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('currencyFilter').value = '';
            
            showPage('list');
            
            // Apply provider filter
            setTimeout(() => {
                filterTransactions(providerId);
                showNotification(`Mostrando transacciones de: ${provider.name}`, 'info');
            }, 100);
        }

        function loadProvidersForDropdown() {
            loadProvidersForAddForm(); // Usar la función unificada
        }

        function loadProvidersForEditDropdown() {
            const select = document.getElementById('editProviderId');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
                
                providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.id;
                    option.textContent = provider.name;
                    select.appendChild(option);
                });
            }
        }
        
        function loadProvidersForAddForm() {
            const select = document.getElementById('providerId');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
                
                providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.id;
                    option.textContent = provider.name;
                    select.appendChild(option);
                });
            }
        }        // Search Functions
        function loadSearchProviders() {
            const select = document.getElementById('searchProvider');
            select.innerHTML = '<option value="">Todos los proveedores...</option>';
            
            providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = provider.name;
                select.appendChild(option);
            });
        }

        function searchTransactions() {
            const invoiceNumber = document.getElementById('searchInvoice').value.toLowerCase();
            const providerId = document.getElementById('searchProvider').value;
            const status = document.getElementById('searchStatus').value;
            
            let filteredTransactions = transactions;
            
            if (invoiceNumber) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.invoiceNumber.toLowerCase().includes(invoiceNumber)
                );
            }
            
            if (providerId) {
                filteredTransactions = filteredTransactions.filter(t => t.providerId === providerId);
            }
            
            if (status) {
                filteredTransactions = filteredTransactions.filter(t => t.status === status);
            }
            
            displaySearchResults(filteredTransactions);
        }

        function displaySearchResults(results) {
            const tbody = document.getElementById('searchResultsList');
            tbody.innerHTML = '';
            
            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-2">🔍</div>
                            <p>No se encontraron resultados</p>
                        </td>
                    </tr>
                `;
            } else {
                results.forEach(transaction => {
                    const provider = providers.find(p => p.id === transaction.providerId);
                    const row = createSearchResultRow(transaction, provider);
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('searchResults').classList.remove('hidden');
        }

        function createSearchResultRow(transaction, provider) {
            const row = document.createElement('tr');
            row.className = 'table-row hover:bg-gray-50';
            
            const statusClass = transaction.status === 'paid' ? 'status-paid' : 
                               transaction.status === 'annulled' ? 'status-cancelled' : 'status-pending';
            
            const statusText = transaction.status === 'paid' ? 'Pagada' : 
                              transaction.status === 'annulled' ? 'Anulada' : 'Pendiente';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${transaction.invoiceNumber}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${provider ? provider.name : 'N/A'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-semibold text-gray-900">${formatNumber(transaction.amount, transaction.currency)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="badge-modern ${statusClass} text-white">${statusText}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex space-x-2">
                        <button onclick="viewTransaction('${transaction.id}')" class="btn-modern px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-all">
                            👁️ Ver
                        </button>
                        ${transaction.status === 'pending' ? `
                            <button onclick="goToPayment('${transaction.id}')" class="btn-modern px-3 py-1 bg-green-500 text-white text-xs rounded-lg hover:bg-green-600 transition-all">
                                💳 Abonar
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            return row;
        }

        function clearSearch() {
            document.getElementById('searchInvoice').value = '';
            document.getElementById('searchProvider').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchResults').classList.add('hidden');
        }

        function goToPayment(transactionId) {
            showPage('payment');
            
            // Set the invoice in the payment form
            setTimeout(() => {
                document.getElementById('paymentInvoice').value = transactionId;
                onPaymentInvoiceSelect();
            }, 100);
        }

        // Filter Functions
        function filterTransactions(specificProviderId = null) {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const currencyFilter = document.getElementById('currencyFilter').value;
            
            let filteredTransactions = transactions;
            
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.invoiceNumber.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.status === statusFilter);
            }
            
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            if (currencyFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.currency === currencyFilter);
            }
            
            if (specificProviderId) {
                filteredTransactions = filteredTransactions.filter(t => t.providerId === specificProviderId);
            }
            
            // Update display
            const tbody = document.getElementById('transactionsList');
            tbody.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                const provider = providers.find(p => p.id === transaction.providerId);
                const row = createTransactionRow(transaction, provider);
                tbody.appendChild(row);
            });
        }

        // Auto-refresh reportes cuando se modifiquen los datos
        function autoRefreshReportsIfNeeded() {
            if (currentPage === 'reports') {
                setTimeout(() => {
                    generateReportsData();
                }, 100); // Pequeño delay para asegurar que los datos se hayan guardado
            }
        }

        // Enhanced Reports Functions
        function generateReportsData() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const typeFilter = document.getElementById('reportType').value;
            const currencyFilter = document.getElementById('reportCurrency').value;
            
            let filteredTransactions = transactions;
            
            // Apply filters
            if (fromDate) {
                filteredTransactions = filteredTransactions.filter(t => t.date >= fromDate);
            }
            
            if (toDate) {
                filteredTransactions = filteredTransactions.filter(t => t.date <= toDate);
            }
            
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            if (currencyFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.currency === currencyFilter);
            }
            
            // Calculate totals by currency
            const totalsUSD = calculateTotalsByCurrency(filteredTransactions, 'USD');
            const totalsVES = calculateTotalsByCurrency(filteredTransactions, 'VES');
            
            // Update displays
            updateCurrencyDisplays(totalsUSD, totalsVES);
            updateGeneralStats(filteredTransactions);
            updateCharts(filteredTransactions);
        }

        function calculateTotalsByCurrency(transactions, currency) {
            let income = 0;
            let expenses = 0;
            
            // Filtrar transacciones válidas (no anuladas)
            const validTransactions = transactions.filter(t => t.status !== 'annulled');
            
            // Calcular totales basándose en PAGOS REALIZADOS en la moneda especificada
            const paymentsInCurrency = paymentHistory.filter(p => p.currency === currency);
            
            for (const payment of paymentsInCurrency) {
                const transaction = validTransactions.find(t => t.id === payment.transactionId);
                if (transaction) {
                    if (transaction.type === 'receivable' || transaction.type === 'income') {
                        // Ingresos: pagos recibidos en esta moneda
                        income += payment.amount;
                    } else if (transaction.type === 'payable' || transaction.type === 'expense') {
                        // Gastos: pagos realizados en esta moneda
                        expenses += payment.amount;
                    }
                }
            }
            
            // ADICIONAR: Transacciones que están marcadas como pagadas pero NO tienen historial de pagos
            // (transacciones pagadas antes de implementar el sistema de historial)
            const paidTransactionsWithoutHistory = validTransactions.filter(t => {
                return t.status === 'paid' && 
                       t.currency === currency && 
                       !paymentHistory.some(p => p.transactionId === t.id);
            });
            
            for (const transaction of paidTransactionsWithoutHistory) {
                if (transaction.type === 'receivable' || transaction.type === 'income') {
                    income += transaction.amount;
                } else if (transaction.type === 'payable' || transaction.type === 'expense') {
                    expenses += transaction.amount;
                }
            }
            
            const balance = income - expenses;
            
            return { income, expenses, balance };
        }

        function updateCurrencyDisplays(totalsUSD, totalsVES) {
            document.getElementById('incomeUSD').textContent = formatNumber(totalsUSD.income, 'USD');
            document.getElementById('expensesUSD').textContent = formatNumber(totalsUSD.expenses, 'USD');
            document.getElementById('balanceUSD').textContent = formatNumber(totalsUSD.balance, 'USD');
            
            document.getElementById('incomeVES').textContent = formatNumber(totalsVES.income, 'VES');
            document.getElementById('expensesVES').textContent = formatNumber(totalsVES.expenses, 'VES');
            document.getElementById('balanceVES').textContent = formatNumber(totalsVES.balance, 'VES');
            
            // Actualizar contadores de pagos
            const usdPayments = paymentHistory.filter(p => p.currency === 'USD').length;
            const vesPayments = paymentHistory.filter(p => p.currency === 'VES').length;
            
            document.getElementById('usdPaymentCount').textContent = usdPayments;
            document.getElementById('vesPaymentCount').textContent = vesPayments;
        }

        function updateGeneralStats(filteredTransactions) {
            // Calcular ingresos: receivable + income pagadas, convertidas a USD
            const income = filteredTransactions
                .filter(t => (t.type === 'receivable' || t.type === 'income') && t.status === 'paid')
                .reduce((sum, t) => sum + (t.currency === 'USD' ? t.amount : t.amount / getCurrentExchangeRate()), 0);
            
            // Calcular gastos: payable + expense pagadas, convertidas a USD
            const expenses = filteredTransactions
                .filter(t => (t.type === 'payable' || t.type === 'expense') && t.status === 'paid')
                .reduce((sum, t) => sum + (t.currency === 'USD' ? t.amount : t.amount / getCurrentExchangeRate()), 0);
            
            // Calcular pendientes: solo payable y receivable (income/expense se marcan como paid automáticamente)
            const pending = filteredTransactions
                .filter(t => (t.type === 'payable' || t.type === 'receivable') && t.status === 'pending')
                .reduce((sum, t) => sum + (t.currency === 'USD' ? t.amount : t.amount / getCurrentExchangeRate()), 0);
            
            const balance = income - expenses;
            
            document.getElementById('totalIncome').textContent = formatNumber(income, 'USD');
            document.getElementById('totalExpenses').textContent = formatNumber(expenses, 'USD');
            document.getElementById('balance').textContent = formatNumber(balance, 'USD');
            document.getElementById('pendingAmount').textContent = formatNumber(pending, 'USD');
        }

        function updateCharts(filteredTransactions) {
            updateStatusChart(filteredTransactions);
            updateProvidersChart(filteredTransactions);
        }

        function updateStatusChart(filteredTransactions) {
            const statusCounts = {
                pending: filteredTransactions.filter(t => t.status === 'pending').length,
                paid: filteredTransactions.filter(t => t.status === 'paid').length,
                annulled: filteredTransactions.filter(t => t.status === 'annulled').length
            };
            
            const total = Object.values(statusCounts).reduce((sum, count) => sum + count, 0);
            
            const container = document.getElementById('statusChart');
            container.innerHTML = '';
            
            if (total === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No hay datos para mostrar</p>';
                return;
            }
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                const color = status === 'paid' ? 'bg-green-500' : 
                             status === 'pending' ? 'bg-yellow-500' : 'bg-red-500';
                const label = status === 'paid' ? 'Pagadas' : 
                             status === 'pending' ? 'Pendientes' : 'Anuladas';
                
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 ${color} rounded-full"></div>
                        <span class="text-gray-700">${label}</span>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${count}</div>
                        <div class="text-sm text-gray-500">${percentage}%</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateProvidersChart(filteredTransactions) {
            const providerCounts = {};
            
            filteredTransactions.forEach(transaction => {
                const provider = providers.find(p => p.id === transaction.providerId);
                const providerName = provider ? provider.name : 'Sin Proveedor';
                providerCounts[providerName] = (providerCounts[providerName] || 0) + 1;
            });
            
            // Sort by count and take top 5
            const topProviders = Object.entries(providerCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const container = document.getElementById('providersChart');
            container.innerHTML = '';
            
            if (topProviders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No hay datos para mostrar</p>';
                return;
            }
            
            const maxCount = Math.max(...topProviders.map(([,count]) => count));
            
            topProviders.forEach(([providerName, count], index) => {
                const percentage = ((count / maxCount) * 100);
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
                
                const item = document.createElement('div');
                item.className = 'space-y-2';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-700 text-sm truncate">${providerName}</span>
                        <span class="font-semibold">${count}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${colors[index]} h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function generateReport() {
            generateReportsData();
            generateDailyReport();
        }

        function generateDailyReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            // Use payment history for more accurate daily reports
            let reportData = paymentHistory;
            
            if (fromDate) {
                reportData = reportData.filter(p => p.date >= fromDate);
            }
            
            if (toDate) {
                reportData = reportData.filter(p => p.date <= toDate);
            }
            
            const tbody = document.getElementById('dailyReportList');
            tbody.innerHTML = '';
            
            if (reportData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-2">📊</div>
                            <p>No hay datos para el período seleccionado</p>
                        </td>
                    </tr>
                `;
            } else {
                reportData.forEach(payment => {
                    const transaction = transactions.find(t => t.id === payment.transactionId);
                    const provider = providers.find(p => p.id === transaction?.providerId);
                    
                    const row = document.createElement('tr');
                    row.className = 'table-row hover:bg-gray-50';
                    
                    const methodText = payment.method === 'cash' ? '💵 Efectivo' : 
                                     payment.method === 'mobile' ? '📱 Pago Móvil' : '🏦 Transferencia';
                    
                    const typeText = transaction?.type === 'payable' ? '💸 Por Pagar' : '💰 Por Cobrar';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(payment.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${payment.invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${typeText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${provider?.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${formatNumber(payment.amount, payment.currency)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.currency === 'USD' ? '🇺🇸 USD' : '🇻🇪 VES'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${methodText}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('dailyReport').classList.remove('hidden');
        }

        function exportTransactions() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `transacciones_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Transacciones exportadas exitosamente', 'success');
        }

        function exportDailyReport() {
            // Convert to CSV format
            const headers = ['Fecha', 'Factura', 'Tipo', 'Proveedor', 'Monto', 'Moneda', 'Método'];
            let csvContent = headers.join(',') + '\n';
            
            const reportData = Array.from(document.getElementById('dailyReportList').children);
            reportData.forEach(row => {
                const cells = Array.from(row.children).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cells.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte_diario_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
            
            showNotification('Reporte exportado exitosamente', 'success');
        }

        // User Management Functions
        function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            users.forEach(user => {
                const userCard = createUserCard(user);
                container.appendChild(userCard);
            });
        }

        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'card-modern p-6 animate-fade-in';
            
            const roleColor = user.role === 'master' ? 'from-purple-500 to-indigo-600' : 'from-blue-500 to-blue-600';
            const roleIcon = user.role === 'master' ? '👑' : '👤';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 bg-gradient-to-br ${roleColor} rounded-xl flex items-center justify-center text-white text-xl">
                        ${roleIcon}
                    </div>
                    <div class="flex space-x-2">
                        ${user.role === 'master' ? `
                            <button onclick="editMasterPassword('${user.id}')" class="btn-modern p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all" title="Cambiar contraseña">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                            </button>
                        ` : ''}
                        ${currentUser.id !== user.id ? `
                            <button onclick="editUser('${user.id}')" class="btn-modern p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteUser('${user.id}')" class="btn-modern p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                <h3 class="text-xl font-semibold text-gray-800 mb-2">${user.username}</h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Rol:</span>
                        <span class="badge-modern ${user.role === 'master' ? 'bg-purple-500' : 'bg-blue-500'} text-white">
                            ${user.role === 'master' ? '👑 Master' : '👤 Estándar'}
                        </span>
                    </div>
                    ${currentUser.id === user.id ? `
                        <div class="mt-3 p-2 bg-green-100 rounded-lg">
                            <div class="text-sm text-green-700 font-medium">✅ Usuario Activo</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        function showAddUserForm() {
            document.getElementById('addUserForm').classList.remove('hidden');
            document.getElementById('newUsername').focus();
        }

        function hideAddUserForm() {
            document.getElementById('addUserForm').classList.add('hidden');
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserRole').value = 'standard';
        }

        function editMasterPassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || user.role !== 'master') return;
            
            const newPassword = prompt(`Cambiar contraseña para usuario Master "${user.username}":\n\nIngrese la nueva contraseña:`);
            
            if (newPassword === null) return; // User cancelled
            
            if (newPassword.length < 4) {
                showNotification('La contraseña debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            // Update password
            user.password = newPassword;
            saveAllData();
            
            logAction('CHANGE_MASTER_PASSWORD', `Contraseña del usuario master "${user.username}" actualizada`);
            showNotification('Contraseña del usuario master actualizada exitosamente', 'success');
            
            // If current user changed their own password, logout for security
            if (currentUser.id === userId) {
                showNotification('Sesión cerrada por seguridad. Inicie sesión con la nueva contraseña.', 'info');
                setTimeout(() => {
                    logout();
                }, 2000);
            }
        }

        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !password) {
                showNotification('Por favor complete todos los campos', 'error');
                return;
            }
            
            // Check if username already exists
            if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
                showNotification('El nombre de usuario ya existe', 'error');
                return;
            }
            
            const user = {
                id: Date.now().toString(),
                username: username,
                password: password,
                role: role,
                createdAt: new Date().toISOString()
            };
            
            users.push(user);
            saveAllData();
            
            logAction('CREATE_USER', `Creado usuario: ${username} (${role})`);
            
            hideAddUserForm();
            showNotification('Usuario agregado exitosamente', 'success');
            loadUsers();
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || user.id === currentUser.id) return;
            
            const newPassword = prompt('Ingrese la nueva contraseña (deje en blanco para mantener la actual):');
            if (newPassword !== null) {
                if (newPassword.trim()) {
                    user.password = newPassword.trim();
                    user.updatedAt = new Date().toISOString();
                    saveAllData();
                    
                    logAction('EDIT_USER', `Editado usuario: ${user.username}`);
                    
                    showNotification('Usuario actualizado exitosamente', 'success');
                    loadUsers();
                }
            }
        }

        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || user.id === currentUser.id) return;
            
            if (confirm(`¿Está seguro de eliminar el usuario "${user.username}"?`)) {
                users = users.filter(u => u.id !== userId);
                saveAllData();
                
                logAction('DELETE_USER', `Eliminado usuario: ${user.username}`);
                
                showNotification('Usuario eliminado exitosamente', 'success');
                loadUsers();
            }
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('exchangeRateInput').value = exchangeRate;
        }

        function updateExchangeRate() {
            const newRate = parseFloat(document.getElementById('exchangeRateInput').value);
            
            if (!newRate || newRate <= 0) {
                showNotification('Por favor ingrese una tasa válida', 'error');
                return;
            }
            
            exchangeRate = newRate;
            lastExchangeRateUpdate = new Date().toISOString();
            saveAllData();
            
            // Update display in header
            updateExchangeRateDisplay();
            
            // Update all calculation fields
            document.getElementById('paymentExchangeRate').value = newRate;
            document.getElementById('fullExchangeRate').value = newRate;
            
            logAction('UPDATE_EXCHANGE_RATE', `Tasa actualizada a: ${newRate}`);
            
            showNotification('Tasa de cambio actualizada exitosamente', 'success');
        }
        
        // Función para actualizar la tasa de cambio diaria desde el modal
        function saveDailyExchangeRate() {
            const newRate = parseFloat(document.getElementById('dailyExchangeRateInput').value);
            
            if (!newRate || newRate <= 0) {
                showNotification('Por favor ingrese una tasa válida', 'error');
                return;
            }
            
            exchangeRate = newRate;
            lastExchangeRateUpdate = new Date().toISOString();
            saveAllData();
            
            // Update display in header
            updateExchangeRateDisplay();
            
            // Update all calculation fields
            document.getElementById('paymentExchangeRate').value = newRate;
            document.getElementById('fullExchangeRate').value = newRate;
            
            logAction('UPDATE_DAILY_EXCHANGE_RATE', `Tasa diaria actualizada a: ${newRate}`);
            
            showNotification('Tasa de cambio diaria actualizada exitosamente', 'success');
            closeExchangeRateUpdateModal();
        }
        
        // Función para cerrar el modal sin actualizar la tasa
        function skipExchangeRateUpdate() {
            lastExchangeRateUpdate = new Date().toISOString();
            saveAllData();
            closeExchangeRateUpdateModal();
            showNotification('Continuando con la tasa anterior: ' + exchangeRate.toFixed(2), 'info');
        }
        
        // Función para cerrar el modal de actualización de tasa
        function closeExchangeRateUpdateModal() {
            document.getElementById('exchangeRateUpdateModal').classList.add('hidden');
        }
        
        // Función para verificar si la tasa necesita ser actualizada hoy
        function checkExchangeRateUpdate() {
            // Solo mostrar después de login exitoso
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Si hay una fecha de última actualización
            if (lastExchangeRateUpdate) {
                const lastUpdateDate = lastExchangeRateUpdate.split('T')[0];
                
                // Si la última actualización no fue hoy, mostrar el modal
                if (lastUpdateDate !== today) {
                    showExchangeRateUpdateModal();
                }
            } else {
                // Si nunca se ha actualizado, mostrar el modal
                showExchangeRateUpdateModal();
            }
        }
        
        // Función para mostrar el modal de actualización de tasa
        function showExchangeRateUpdateModal() {
            // Configurar datos en el modal
            document.getElementById('currentRateDisplay').textContent = exchangeRate.toFixed(2) + ' VES';
            
            // Mostrar la última fecha de actualización
            if (lastExchangeRateUpdate) {
                const date = new Date(lastExchangeRateUpdate);
                document.getElementById('lastRateUpdateDate').textContent = date.toLocaleDateString();
            } else {
                document.getElementById('lastRateUpdateDate').textContent = 'Nunca';
            }
            
            // Pre-llenar el input con la tasa actual
            document.getElementById('dailyExchangeRateInput').value = exchangeRate.toFixed(2);
            
            // Mostrar el modal
            document.getElementById('exchangeRateUpdateModal').classList.remove('hidden');
        }

        function getMethodDisplayName(method) {
            const methods = {
                'cash': '💵 Efectivo',
                'cash_usd': '💲 Efectivo USD',
                'bank': '🏦 Transferencia',
                'mobile': '📱 Pago Móvil'
            };
            return methods[method] || method;
        }

        function createBackup() {
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                data: {
                    transactions: transactions,
                    providers: providers,
                    users: users.map(u => ({ ...u, password: '***' })), // Hide passwords in backup
                    exchangeRate: exchangeRate,
                    paymentHistory: paymentHistory,
                    auditLog: auditLog
                }
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup_mansion_plast_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            logAction('CREATE_BACKUP', 'Respaldo de datos creado');
            showNotification('Respaldo creado exitosamente', 'success');
        }

        function restoreFromBackup(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (confirm('¿Está seguro de restaurar los datos? Se perderán todos los datos actuales.')) {
                        if (backupData.data) {
                            transactions = backupData.data.transactions || [];
                            providers = backupData.data.providers || [];
                            // Don't restore users with hidden passwords
                            exchangeRate = backupData.data.exchangeRate || 36.5;
                            paymentHistory = backupData.data.paymentHistory || [];
                            auditLog = backupData.data.auditLog || [];
                            
                            saveAllData();
                            
                            logAction('RESTORE_BACKUP', 'Datos restaurados desde respaldo');
                            showNotification('Datos restaurados exitosamente', 'success');
                            
                            // Refresh current page
                            showPage(currentPage);
                        }
                    }
                } catch (error) {
                    showNotification('Error al leer el archivo de respaldo', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            fileInput.value = '';
        }

        // Reset Database Functions
        function showResetConfirmation() {
            document.getElementById('resetConfirmationModal').classList.remove('hidden');
            document.getElementById('resetPassword').focus();
        }

        function closeResetConfirmation() {
            document.getElementById('resetConfirmationModal').classList.add('hidden');
            document.getElementById('resetPassword').value = '';
        }

        function confirmSystemReset() {
            const password = document.getElementById('resetPassword').value;
            
            if (password !== 'password') { // Use actual master password
                showNotification('Contraseña incorrecta', 'error');
                return;
            }
            
            if (confirm('⚠️ ÚLTIMA CONFIRMACIÓN ⚠️\n\n¿Está COMPLETAMENTE SEGURO de resetear el sistema?\n\nSe eliminarán TODOS los datos:\n- Transacciones\n- Proveedores\n- Historial de pagos\n- Registro de auditoría\n\nEsta acción es IRREVERSIBLE.')) {
                showLoading();
                
                // Reset all data to initial state
                transactions = [];
                providers = [
                    { id: '1', name: 'Proveedor Ejemplo 1', createdAt: new Date().toISOString() },
                    { id: '2', name: 'Proveedor Ejemplo 2', createdAt: new Date().toISOString() },
                    { id: '3', name: 'Cliente Ejemplo 1', createdAt: new Date().toISOString() }
                ];
                paymentHistory = [];
                auditLog = [];
                exchangeRate = 36.5;
                
                // Keep users but reset audit log
                auditLog = [{
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    user: currentUser.username,
                    action: 'SYSTEM_RESET',
                    details: 'Sistema reseteado completamente',
                    ip: 'Local'
                }];
                
                saveAllData();
                
                hideLoading();
                closeResetConfirmation();
                showNotification('¡Sistema reseteado exitosamente!', 'success');
                
                // Redirect to main page
                showPage('list');
            }
        }

        function clearSystemCache() {
            if (confirm('¿Está seguro de limpiar el cache del sistema?')) {
                // Clear browser cache
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                logAction('CLEAR_CACHE', 'Cache del sistema limpiado');
                showNotification('Cache limpiado exitosamente', 'success');
            }
        }

        // Audit Log Functions
        function viewAuditLog() {
            document.getElementById('auditLogModal').classList.remove('hidden');
            loadAuditLogTable();
        }

        function closeAuditLogModal() {
            document.getElementById('auditLogModal').classList.add('hidden');
        }

        function loadAuditLogTable() {
            const tbody = document.getElementById('auditLogTableBody');
            tbody.innerHTML = '';
            
            if (auditLog.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-2">📋</div>
                            <p>No hay registros de auditoría</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            auditLog.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'table-row hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTime(entry.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.user}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${entry.action}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${entry.details}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function exportAuditLog() {
            const headers = ['Fecha/Hora', 'Usuario', 'Acción', 'Detalles'];
            let csvContent = headers.join(',') + '\n';
            
            auditLog.forEach(entry => {
                const row = [
                    `"${formatDateTime(entry.timestamp)}"`,
                    `"${entry.user}"`,
                    `"${entry.action}"`,
                    `"${entry.details}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `auditoria_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
            
            showNotification('Registro de auditoría exportado exitosamente', 'success');
        }

        // Income Transaction Functions
        function loadProvidersForIncomeForm() {
            // No longer needed - providers removed from income form
        }

        function resetIncomeForm() {
            document.getElementById('incomeForm').reset();
            document.getElementById('incomeDate').value = formatDateForInput(new Date());
        }

        function addIncomeTransaction(e) {
            e.preventDefault();
            showLoading();
            
            const reference = document.getElementById('incomeReference').value;
            const providerId = '1'; // Default provider ID
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const currency = document.getElementById('incomeCurrency').value;
            const date = document.getElementById('incomeDate').value;
            const medium = document.getElementById('incomeMedium').value;
            const type = document.getElementById('incomeType').value;
            const description = document.getElementById('incomeDescription').value;
            
            // Determinar el tipo de pago basado en el medio y tipo
            let paymentType = 'cash'; // valor por defecto
            if (medium === 'digital') {
                if (type === 'pago_movil') paymentType = 'mobile';
                else if (type === 'transferencia') paymentType = 'bank';
                else if (type === 'punto') paymentType = 'card';
            } else {
                paymentType = currency === 'USD' ? 'cash_usd' : 'cash';
            }
            
            if (!reference || !amount || !currency || !date || !description) {
                hideLoading();
                showNotification('Por favor complete todos los campos obligatorios', 'error');
                return;
            }
            
            const transaction = {
                id: generateId(),
                invoiceNumber: reference,
                type: 'income',
                providerId: providerId,
                amount: amount,
                currency: currency,
                date: date,
                paymentType: paymentType,
                description: description,
                status: 'paid', // Income transactions are automatically marked as paid
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            // Add transaction
            transactions.push(transaction);
            
            // Create immediate payment history entry
            const payment = {
                id: generateId(),
                transactionId: transaction.id,
                amount: amount,
                currency: currency,
                paymentMethod: paymentType,
                exchangeRate: getCurrentExchangeRate(),
                paymentDate: date,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            paymentHistory.push(payment);
            
            saveAllData();
            logAction('ADD_INCOME', `Entrada registrada: ${reference} por ${formatNumber(amount, currency)}`);
            
            hideLoading();
            showNotification('Entrada registrada exitosamente', 'success');
            
            // Reset form and redirect
            resetIncomeForm();
            
            // Use setTimeout to prevent hanging
            setTimeout(() => {
                showPage('list');
            }, 100);
        }

        // Expense Transaction Functions
        function loadProvidersForExpenseForm() {
            // No longer needed - providers removed from expense form
        }

        function resetExpenseForm() {
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = formatDateForInput(new Date());
        }

        function addExpenseTransaction(e) {
            e.preventDefault();
            showLoading();
            
            const reference = document.getElementById('expenseReference').value;
            const providerId = '1'; // Default provider ID
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const currency = document.getElementById('expenseCurrency').value;
            const date = document.getElementById('expenseDate').value;
            const medium = document.getElementById('expenseMedium').value;
            const type = document.getElementById('expenseType').value;
            const description = document.getElementById('expenseDescription').value;
            
            // Determinar el tipo de pago basado en el medio y tipo
            let paymentType = 'cash'; // valor por defecto
            if (medium === 'digital') {
                if (type === 'pago_movil') paymentType = 'mobile';
                else if (type === 'transferencia') paymentType = 'bank';
                else if (type === 'punto') paymentType = 'card';
            } else {
                paymentType = currency === 'USD' ? 'cash_usd' : 'cash';
            }
            
            if (!reference || !amount || !currency || !date || !description) {
                hideLoading();
                showNotification('Por favor complete todos los campos obligatorios', 'error');
                return;
            }
            
            const transaction = {
                id: generateId(),
                invoiceNumber: reference,
                type: 'expense',
                providerId: providerId,
                amount: amount,
                currency: currency,
                date: date,
                paymentType: paymentType,
                description: description,
                status: 'paid', // Expense transactions are automatically marked as paid
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            // Add transaction
            transactions.push(transaction);
            
            // Create immediate payment history entry
            const payment = {
                id: generateId(),
                transactionId: transaction.id,
                amount: amount,
                currency: currency,
                paymentMethod: paymentType,
                exchangeRate: getCurrentExchangeRate(),
                paymentDate: date,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            paymentHistory.push(payment);
            
            saveAllData();
            logAction('ADD_EXPENSE', `Salida registrada: ${reference} por ${formatNumber(amount, currency)}`);
            
            hideLoading();
            showNotification('Salida registrada exitosamente', 'success');
            
            // Reset form and redirect
            resetExpenseForm();
            
            // Use setTimeout to prevent hanging
            setTimeout(() => {
                showPage('list');
            }, 100);
        }

        // Preview Functions
        function showIncomePreview() {
            const amount = document.getElementById('incomeAmount').value;
            const currency = document.getElementById('incomeCurrency').value;
            const medium = document.getElementById('incomeMedium').value;
            const type = document.getElementById('incomeType').value;
            const bank = document.getElementById('incomeBank').value;
            const date = document.getElementById('incomeDate').value;
            const description = document.getElementById('incomeDescription').value;
            const reference = document.getElementById('incomeReference').value;
            const providerId = '1'; // Default provider ID
            
            if (!amount || !currency || !date || !description || !reference) {
                showNotification('Por favor complete todos los campos obligatorios antes de previsualizar', 'warning');
                return;
            }
            
            // Mostrar valores en la previsualización
            document.getElementById('previewIncomeAmount').textContent = formatNumber(parseFloat(amount), currency);
            document.getElementById('previewIncomeCurrency').textContent = currency === 'USD' ? '🇺🇸 USD' : '🇻🇪 VES';
            document.getElementById('previewIncomeMedium').textContent = medium === 'fisico' ? '💵 Físico' : '💻 Digital';
            
            if (medium === 'digital') {
                let typeText = '';
                if (type === 'pago_movil') typeText = '📱 Pago Móvil';
                else if (type === 'transferencia') typeText = '🏦 Transferencia';
                else if (type === 'punto') typeText = '💳 Punto de Venta';
                document.getElementById('previewIncomeType').textContent = typeText;
                
                if (type === 'transferencia' || type === 'pago_movil') {
                    const bankRow = document.getElementById('previewIncomeBankRow');
                    bankRow.classList.remove('hidden');
                    let bankText = '';
                    if (bank === 'mercantil') bankText = '🏦 Banco Mercantil';
                    else if (bank === 'venezuela') bankText = '🏦 Banco de Venezuela';
                    else if (bank === 'banesco') bankText = '🏦 Banco Banesco';
                    document.getElementById('previewIncomeBank').textContent = bankText;
                }
            } else {
                document.getElementById('previewIncomeType').textContent = 'N/A';
                document.getElementById('previewIncomeBankRow').classList.add('hidden');
            }
            
            document.getElementById('previewIncomeDate').textContent = new Date(date).toLocaleDateString('es-ES');
            document.getElementById('previewIncomeDescription').textContent = description;
            
            // Mostrar previsualización y botón de confirmar
            document.getElementById('incomePreview').classList.remove('hidden');
            document.getElementById('confirmIncomeBtn').style.display = 'block';
        }
        
        function showExpensePreview() {
            const amount = document.getElementById('expenseAmount').value;
            const currency = document.getElementById('expenseCurrency').value;
            const medium = document.getElementById('expenseMedium').value;
            const type = document.getElementById('expenseType').value;
            const bank = document.getElementById('expenseBank').value;
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;
            const reference = document.getElementById('expenseReference').value;
            const providerId = '1'; // Default provider ID
            
            if (!amount || !currency || !date || !description || !reference) {
                showNotification('Por favor complete todos los campos obligatorios antes de previsualizar', 'warning');
                return;
            }
            
            // Mostrar valores en la previsualización
            document.getElementById('previewExpenseAmount').textContent = formatNumber(parseFloat(amount), currency);
            document.getElementById('previewExpenseCurrency').textContent = currency === 'USD' ? '🇺🇸 USD' : '🇻🇪 VES';
            document.getElementById('previewExpenseMedium').textContent = medium === 'fisico' ? '💵 Físico' : '💻 Digital';
            
            if (medium === 'digital') {
                let typeText = '';
                if (type === 'pago_movil') typeText = '📱 Pago Móvil';
                else if (type === 'transferencia') typeText = '🏦 Transferencia';
                else if (type === 'punto') typeText = '💳 Punto de Venta';
                document.getElementById('previewExpenseType').textContent = typeText;
                
                if (type === 'transferencia' || type === 'pago_movil') {
                    const bankRow = document.getElementById('previewExpenseBankRow');
                    bankRow.classList.remove('hidden');
                    let bankText = '';
                    if (bank === 'mercantil') bankText = '🏦 Banco Mercantil';
                    else if (bank === 'venezuela') bankText = '🏦 Banco de Venezuela';
                    else if (bank === 'banesco') bankText = '🏦 Banco Banesco';
                    document.getElementById('previewExpenseBank').textContent = bankText;
                }
            } else {
                document.getElementById('previewExpenseType').textContent = 'N/A';
                document.getElementById('previewExpenseBankRow').classList.add('hidden');
            }
            
            document.getElementById('previewExpenseDate').textContent = new Date(date).toLocaleDateString('es-ES');
            document.getElementById('previewExpenseDescription').textContent = description;
            
            // Mostrar previsualización y botón de confirmar
            document.getElementById('expensePreview').classList.remove('hidden');
            document.getElementById('confirmExpenseBtn').style.display = 'block';
        }

        // Utility Functions
        function formatNumber(amount, currency) {
            const number = parseFloat(amount) || 0;
            
            if (currency === 'USD') {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(number);
            } else if (currency === 'VES') {
                return new Intl.NumberFormat('es-VE', {
                    style: 'currency',
                    currency: 'VES',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(number).replace('VES', 'Bs.');
            }
            
            return number.toFixed(2);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('es-VE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).format(date);
            } catch (error) {
                return dateString;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            
            try {
                const date = new Date(dateTimeString);
                return new Intl.DateTimeFormat('es-VE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(date);
            } catch (error) {
                return dateTimeString;
            }
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function validateAmount(amount) {
            const num = parseFloat(amount);
            return !isNaN(num) && num > 0;
        }

        function validateRequired(value) {
            return value && value.trim().length > 0;
        }

        function sanitizeInput(input) {
            return input ? input.trim().replace(/[<>]/g, '') : '';
        }

        // Enhanced Search and Filter Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Apply debounced filtering
        const debouncedFilter = debounce(filterTransactions, 300);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K for quick search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                showPage('search');
                setTimeout(() => {
                    document.getElementById('searchInvoice').focus();
                }, 100);
            }
            
            // Ctrl/Cmd + N for new transaction
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showPage('add');
            }
            
            // Ctrl/Cmd + R for reports
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                showPage('reports');
            }
            
            // ESC to close modals
            if (e.key === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
                
                // Close calculator
                document.getElementById('calculatorModal').classList.add('hidden');
            }
        });

        // Enhanced Error Handling
        window.addEventListener('error', function(e) {
            console.error('Application Error:', e.error);
            showNotification('Ha ocurrido un error inesperado. Por favor, recargue la página.', 'error');
            logAction('ERROR', `Error: ${e.error.message}`);
        });

        // Backup reminder
        function checkBackupReminder() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            const today = new Date().toISOString().split('T')[0];
            
            if (!lastBackup || lastBackup !== today) {
                const daysSinceLastBackup = lastBackup ? 
                    Math.floor((new Date(today) - new Date(lastBackup)) / (1000 * 60 * 60 * 24)) : 0;
                
                if (daysSinceLastBackup >= 7) {
                    setTimeout(() => {
                        showNotification('Recordatorio: Es recomendable crear un respaldo de los datos semanalmente', 'warning', 10000);
                    }, 5000);
                }
            }
        }

        // Performance optimization
        function optimizePerformance() {
            // Lazy load images if any
            const images = document.querySelectorAll('img[data-src]');
            if (images.length > 0 && 'IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            observer.unobserve(img);
                        }
                    });
                });
                
                images.forEach(img => imageObserver.observe(img));
            }
            
            // Virtualization for large datasets (if needed in future)
            // This would be implemented when transaction counts exceed 1000
        }

        // Auto-save functionality
        let autoSaveInterval;
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                saveAllData();
                // Silently save - no notification needed
            }, 30000); // Auto-save every 30 seconds
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
        }

        // Data validation and integrity checks
        function validateDataIntegrity() {
            let issuesFound = 0;
            
            // Check for orphaned transactions (transactions without valid providers)
            transactions.forEach(transaction => {
                if (!providers.find(p => p.id === transaction.providerId)) {
                    console.warn(`Orphaned transaction found: ${transaction.invoiceNumber}`);
                    issuesFound++;
                }
            });
            
            // Check for duplicate invoice numbers
            const invoiceNumbers = transactions.map(t => t.invoiceNumber);
            const duplicates = invoiceNumbers.filter((num, index) => invoiceNumbers.indexOf(num) !== index);
            if (duplicates.length > 0) {
                console.warn('Duplicate invoice numbers found:', duplicates);
                issuesFound++;
            }
            
            // Check payment history integrity
            paymentHistory.forEach(payment => {
                if (!transactions.find(t => t.id === payment.transactionId)) {
                    console.warn(`Orphaned payment found: ${payment.id}`);
                    issuesFound++;
                }
            });
            
            if (issuesFound > 0) {
                logAction('DATA_INTEGRITY_ISSUES', `${issuesFound} issues found during integrity check`);
            }
            
            return issuesFound === 0;
        }

        // Migration System Variables
        let migrationData = null;
        let migrationFile = null;
        let migrationHeaders = [];
        let fieldMapping = {};
        let processedData = [];
        let databaseInstance = null;
        let selectedTable = null;
        let databaseTables = [];
        
        // Migration Functions
        function resetMigrationForm() {
            migrationData = null;
            migrationFile = null;
            migrationHeaders = [];
            fieldMapping = {};
            processedData = [];
            databaseInstance = null;
            selectedTable = null;
            databaseTables = [];
            
            // Reset UI
            document.getElementById('migrationStep1').classList.remove('hidden');
            document.getElementById('migrationStep1_5').classList.add('hidden');
            document.getElementById('migrationStep2').classList.add('hidden');
            document.getElementById('migrationStep3').classList.add('hidden');
            document.getElementById('migrationComplete').classList.add('hidden');
            
            // Reset file input
            document.getElementById('migrationFile').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('processFileBtn').disabled = true;
            
            // Reset database UI
            document.getElementById('tablePreview').classList.add('hidden');
            document.getElementById('selectTableBtn').disabled = true;
            
            // Reset progress
            updateMigrationProgress(1);
        }
        
        function updateMigrationProgress(step) {
            // Reset all steps
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                const progressEl = document.getElementById(`progress${i}`);
                
                if (i < step) {
                    stepEl.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-sm';
                    if (progressEl) progressEl.querySelector('div').style.width = '100%';
                } else if (i === step) {
                    stepEl.className = 'w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm';
                    if (progressEl) progressEl.querySelector('div').style.width = '0%';
                } else {
                    stepEl.className = 'w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm';
                    if (progressEl) progressEl.querySelector('div').style.width = '0%';
                }
            }
        }
        
        function goToStep(step) {
            document.querySelectorAll('.migration-step').forEach(el => el.classList.add('hidden'));
            
            if (step === 1.5) {
                document.getElementById('migrationStep1_5').classList.remove('hidden');
                updateMigrationProgress(1);
            } else {
                document.getElementById(`migrationStep${step}`).classList.remove('hidden');
                updateMigrationProgress(step);
            }
        }
        
        // File handling
        function setupFileDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('migrationFile');
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }
        
        function handleFileSelect(file) {
            const validTypes = [
                'text/csv',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel',
                'application/x-sqlite3',
                'application/vnd.sqlite3'
            ];
            
            if (!validTypes.includes(file.type) && !file.name.match(/\.(csv|xlsx|xls|db)$/i)) {
                showNotification('Formato de archivo no válido. Use CSV, Excel o SQLite (.db).', 'error');
                return;
            }
            
            migrationFile = file;
            
            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('processFileBtn').disabled = false;
        }
        
        function removeFile() {
            migrationFile = null;
            document.getElementById('migrationFile').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('processFileBtn').disabled = true;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function processFile() {
            if (!migrationFile) return;
            
            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                
                if (migrationFile.name.toLowerCase().endsWith('.csv')) {
                    parseCSV(data);
                } else if (migrationFile.name.toLowerCase().endsWith('.db')) {
                    parseDatabase(data);
                } else {
                    parseExcel(data);
                }
            };
            
            if (migrationFile.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(migrationFile);
            } else {
                reader.readAsArrayBuffer(migrationFile);
            }
        }
        
        function parseCSV(data) {
            try {
                const lines = data.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('El archivo debe tener al menos una fila de encabezados y una fila de datos');
                }
                
                migrationHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                migrationData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    migrationHeaders.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    migrationData.push(row);
                }
                
                hideLoading();
                setupFieldMapping();
                goToStep(2);
                
            } catch (error) {
                hideLoading();
                showNotification('Error al procesar archivo CSV: ' + error.message, 'error');
            }
        }
        
        function parseExcel(data) {
            // For Excel files, we'll implement a simple parser or use a library
            // For now, show a message that Excel support is coming
            hideLoading();
            showNotification('Soporte para Excel estará disponible pronto. Use CSV por ahora.', 'warning');
        }
        
        async function parseDatabase(data) {
            try {
                // Initialize SQL.js
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${file}`
                });
                
                // Create database instance
                const uint8Array = new Uint8Array(data);
                databaseInstance = new SQL.Database(uint8Array);
                
                // Get all tables
                const tables = databaseInstance.exec("SELECT name FROM sqlite_master WHERE type='table'");
                
                if (!tables || tables.length === 0 || !tables[0].values) {
                    throw new Error('No se encontraron tablas en la base de datos');
                }
                
                databaseTables = tables[0].values.map(row => row[0]).filter(name => name !== 'sqlite_sequence');
                
                if (databaseTables.length === 0) {
                    throw new Error('No se encontraron tablas válidas en la base de datos');
                }
                
                hideLoading();
                showDatabaseTables();
                goToStep(1.5);
                
            } catch (error) {
                hideLoading();
                showNotification('Error al procesar base de datos: ' + error.message, 'error');
                console.error('Database parsing error:', error);
            }
        }
        
        function showDatabaseTables() {
            const tableList = document.getElementById('tableList');
            tableList.innerHTML = '';
            
            databaseTables.forEach(tableName => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 cursor-pointer';
                div.onclick = () => selectDatabaseTable(tableName);
                
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="selectedTable" value="${tableName}" class="text-blue-600">
                        <div>
                            <h5 class="font-semibold text-gray-800">${tableName}</h5>
                            <p class="text-sm text-gray-600" id="tableInfo_${tableName}">Cargando información...</p>
                        </div>
                    </div>
                    <button onclick="previewTable('${tableName}'); event.stopPropagation();" class="text-blue-600 hover:text-blue-800 text-sm">
                        Vista previa
                    </button>
                `;
                
                tableList.appendChild(div);
                
                // Get table info
                try {
                    const result = databaseInstance.exec(`SELECT COUNT(*) as count FROM ${tableName}`);
                    const count = result[0].values[0][0];
                    document.getElementById(`tableInfo_${tableName}`).textContent = `${count} registros`;
                } catch (error) {
                    document.getElementById(`tableInfo_${tableName}`).textContent = 'Error al obtener información';
                }
            });
        }
        
        function selectDatabaseTable(tableName) {
            selectedTable = tableName;
            
            // Update radio button
            document.querySelectorAll('input[name="selectedTable"]').forEach(radio => {
                radio.checked = radio.value === tableName;
            });
            
            document.getElementById('selectTableBtn').disabled = false;
            previewTable(tableName);
        }
        
        function previewTable(tableName) {
            try {
                const result = databaseInstance.exec(`SELECT * FROM ${tableName} LIMIT 5`);
                
                if (!result || result.length === 0) {
                    document.getElementById('tablePreviewContent').innerHTML = '<p class="text-gray-500">No hay datos en esta tabla</p>';
                    document.getElementById('tablePreview').classList.remove('hidden');
                    return;
                }
                
                const data = result[0];
                const table = document.createElement('table');
                table.className = 'w-full text-sm border-collapse';
                
                // Headers
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-gray-100';
                
                data.columns.forEach(column => {
                    const th = document.createElement('th');
                    th.className = 'px-3 py-2 text-left border font-semibold';
                    th.textContent = column;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Body
                const tbody = document.createElement('tbody');
                data.values.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.className = 'px-3 py-2 border';
                        td.textContent = cell || '';
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                document.getElementById('tablePreviewContent').innerHTML = '';
                document.getElementById('tablePreviewContent').appendChild(table);
                document.getElementById('tablePreview').classList.remove('hidden');
                
            } catch (error) {
                document.getElementById('tablePreviewContent').innerHTML = '<p class="text-red-500">Error al mostrar vista previa: ' + error.message + '</p>';
                document.getElementById('tablePreview').classList.remove('hidden');
            }
        }
        
        function selectTable() {
            if (!selectedTable || !databaseInstance) {
                showNotification('Debe seleccionar una tabla', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                // Get all data from selected table
                const result = databaseInstance.exec(`SELECT * FROM ${selectedTable}`);
                
                if (!result || result.length === 0) {
                    throw new Error('No hay datos en la tabla seleccionada');
                }
                
                const data = result[0];
                migrationHeaders = data.columns;
                migrationData = [];
                
                data.values.forEach(row => {
                    const rowObj = {};
                    data.columns.forEach((column, index) => {
                        rowObj[column] = row[index];
                    });
                    migrationData.push(rowObj);
                });
                
                hideLoading();
                setupFieldMapping();
                goToStep(2);
                
            } catch (error) {
                hideLoading();
                showNotification('Error al procesar tabla: ' + error.message, 'error');
            }
        }
        
        function setupFieldMapping() {
            const systemFields = {
                'invoiceNumber': 'Número de Factura',
                'type': 'Tipo (payable/receivable/income/expense)',
                'providerName': 'Nombre del Proveedor',
                'amount': 'Monto',
                'currency': 'Moneda (USD/VES)',
                'date': 'Fecha',
                'description': 'Descripción',
                'status': 'Estado (pending/paid/annulled)'
            };
            
            const mappingContainer = document.getElementById('fieldMapping');
            mappingContainer.innerHTML = '';
            
            Object.entries(systemFields).forEach(([field, label]) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 gap-4 items-center';
                
                div.innerHTML = `
                    <div class="text-gray-700 font-medium">${label}</div>
                    <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            data-field="${field}" onchange="updateFieldMapping()">
                        <option value="">-- No mapear --</option>
                        ${migrationHeaders.map(header => 
                            `<option value="${header}">${header}</option>`
                        ).join('')}
                    </select>
                `;
                
                mappingContainer.appendChild(div);
            });
            
            // Auto-map common fields
            autoMapFields();
        }
        
        function autoMapFields() {
            const commonMappings = {
                'invoiceNumber': ['factura', 'invoice', 'numero', 'number'],
                'type': ['tipo', 'type'],
                'providerName': ['proveedor', 'provider', 'supplier', 'cliente', 'client'],
                'amount': ['monto', 'amount', 'valor', 'value', 'importe'],
                'currency': ['moneda', 'currency'],
                'date': ['fecha', 'date'],
                'description': ['descripcion', 'description', 'concepto', 'detalle'],
                'status': ['estado', 'status']
            };
            
            Object.entries(commonMappings).forEach(([field, keywords]) => {
                const select = document.querySelector(`select[data-field="${field}"]`);
                const header = migrationHeaders.find(h => 
                    keywords.some(keyword => 
                        h.toLowerCase().includes(keyword.toLowerCase())
                    )
                );
                if (header && select) {
                    select.value = header;
                }
            });
            
            updateFieldMapping();
        }
        
        function updateFieldMapping() {
            fieldMapping = {};
            document.querySelectorAll('[data-field]').forEach(select => {
                if (select.value) {
                    fieldMapping[select.dataset.field] = select.value;
                }
            });
        }
        
        function previewData() {
            if (!migrationData || Object.keys(fieldMapping).length === 0) {
                showNotification('Debe mapear al menos un campo para continuar', 'warning');
                return;
            }
            
            processedData = [];
            const errors = [];
            const newProviders = new Set();
            
            migrationData.forEach((row, index) => {
                try {
                    const processedRow = {
                        original: row,
                        mapped: {},
                        errors: [],
                        valid: true
                    };
                    
                    // Map fields
                    Object.entries(fieldMapping).forEach(([systemField, sourceField]) => {
                        let value = row[sourceField];
                        
                        // Process specific fields
                        switch (systemField) {
                            case 'type':
                                const lowerValue = value.toLowerCase();
                                if (lowerValue.includes('pagar') || lowerValue.includes('payable')) {
                                    value = 'payable';
                                } else if (lowerValue.includes('cobrar') || lowerValue.includes('receivable')) {
                                    value = 'receivable';
                                } else if (lowerValue.includes('entrada') || lowerValue.includes('income') || lowerValue.includes('ingreso')) {
                                    value = 'income';
                                } else if (lowerValue.includes('salida') || lowerValue.includes('expense') || lowerValue.includes('gasto')) {
                                    value = 'expense';
                                } else {
                                    value = 'payable'; // Default
                                }
                                break;
                            case 'amount':
                                value = parseFloat(value.toString().replace(/[,$]/g, ''));
                                if (isNaN(value)) {
                                    processedRow.errors.push('Monto inválido');
                                    processedRow.valid = false;
                                }
                                break;
                            case 'currency':
                                value = value.toUpperCase();
                                if (!['USD', 'VES'].includes(value)) {
                                    value = 'USD'; // Default
                                }
                                break;
                            case 'date':
                                // Try to parse date
                                const date = new Date(value);
                                if (isNaN(date.getTime())) {
                                    processedRow.errors.push('Fecha inválida');
                                    processedRow.valid = false;
                                } else {
                                    value = date.toISOString().split('T')[0];
                                }
                                break;
                            case 'providerName':
                                if (value && value.trim()) {
                                    newProviders.add(value.trim());
                                }
                                break;
                        }
                        
                        processedRow.mapped[systemField] = value;
                    });
                    
                    // Validate required fields
                    if (!processedRow.mapped.invoiceNumber) {
                        processedRow.errors.push('Número de factura requerido');
                        processedRow.valid = false;
                    }
                    
                    if (!processedRow.mapped.providerName) {
                        processedRow.errors.push('Proveedor requerido');
                        processedRow.valid = false;
                    }
                    
                    processedData.push(processedRow);
                    
                } catch (error) {
                    errors.push(`Fila ${index + 1}: ${error.message}`);
                }
            });
            
            // Update summary
            const validRecords = processedData.filter(r => r.valid).length;
            const errorRecords = processedData.length - validRecords;
            
            document.getElementById('totalRecords').textContent = processedData.length;
            document.getElementById('validRecords').textContent = validRecords;
            document.getElementById('errorRecords').textContent = errorRecords;
            document.getElementById('newProviders').textContent = newProviders.size;
            
            // Show preview
            showDataPreview();
            goToStep(3);
        }
        
        function showDataPreview() {
            const previewContainer = document.getElementById('dataPreview');
            const previewData = processedData.slice(0, 10); // Show first 10 rows
            
            if (previewData.length === 0) {
                previewContainer.innerHTML = '<p class="text-gray-500">No hay datos para mostrar</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'w-full text-sm';
            
            // Headers
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.className = 'bg-gray-100';
            
            Object.keys(fieldMapping).forEach(field => {
                const th = document.createElement('th');
                th.className = 'px-2 py-1 text-left border';
                th.textContent = field;
                headerRow.appendChild(th);
            });
            
            const statusTh = document.createElement('th');
            statusTh.className = 'px-2 py-1 text-left border';
            statusTh.textContent = 'Estado';
            headerRow.appendChild(statusTh);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Body
            const tbody = document.createElement('tbody');
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = row.valid ? '' : 'bg-red-50';
                
                Object.keys(fieldMapping).forEach(field => {
                    const td = document.createElement('td');
                    td.className = 'px-2 py-1 border';
                    td.textContent = row.mapped[field] || '';
                    tr.appendChild(td);
                });
                
                const statusTd = document.createElement('td');
                statusTd.className = 'px-2 py-1 border';
                statusTd.innerHTML = row.valid 
                    ? '<span class="text-green-600">✓ Válido</span>'
                    : `<span class="text-red-600">✗ ${row.errors.join(', ')}</span>`;
                tr.appendChild(statusTd);
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            previewContainer.innerHTML = '';
            previewContainer.appendChild(table);
        }
        
        function executeImport() {
            if (!processedData || processedData.length === 0) {
                showNotification('No hay datos para importar', 'warning');
                return;
            }
            
            const validRows = processedData.filter(r => r.valid);
            if (validRows.length === 0) {
                showNotification('No hay registros válidos para importar', 'error');
                return;
            }
            
            showLoading();
            
            setTimeout(() => { // Simulate processing time
                try {
                    // Create backup before import
                    const backup = {
                        transactions: [...transactions],
                        providers: [...providers],
                        paymentHistory: [...paymentHistory],
                        timestamp: new Date().toISOString()
                    };
                    
                    // Import providers first
                    const newProviders = new Set();
                    validRows.forEach(row => {
                        const providerName = row.mapped.providerName;
                        if (providerName && !providers.find(p => p.name.toLowerCase() === providerName.toLowerCase())) {
                            const newProvider = {
                                id: generateId(),
                                name: providerName
                            };
                            providers.push(newProvider);
                            newProviders.add(providerName);
                        }
                    });
                    
                    // Import transactions
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    validRows.forEach(row => {
                        const invoiceNumber = row.mapped.invoiceNumber;
                        
                        // Check for duplicate invoice numbers
                        if (transactions.find(t => t.invoiceNumber === invoiceNumber)) {
                            skippedCount++;
                            return;
                        }
                        
                        const provider = providers.find(p => 
                            p.name.toLowerCase() === row.mapped.providerName.toLowerCase()
                        );
                        
                        if (!provider) {
                            skippedCount++;
                            return;
                        }
                        
                        const transaction = {
                            id: generateId(),
                            invoiceNumber: invoiceNumber,
                            type: row.mapped.type || 'payable',
                            providerId: provider.id,
                            amount: row.mapped.amount || 0,
                            currency: row.mapped.currency || 'USD',
                            date: row.mapped.date || new Date().toISOString().split('T')[0],
                            description: row.mapped.description || '',
                            status: row.mapped.status || 'pending',
                            createdAt: new Date().toISOString(),
                            importedFrom: migrationFile.name
                        };
                        
                        transactions.push(transaction);
                        importedCount++;
                    });
                    
                    // Save data
                    saveAllData();
                    
                    // Log action
                    logAction('DATA_MIGRATION', `Imported ${importedCount} transactions, ${newProviders.size} new providers from ${migrationFile.name}`);
                    
                    hideLoading();
                    
                    // Show results
                    const resultsHtml = `
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${importedCount}</div>
                                <div class="text-sm text-green-700">Transacciones Importadas</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">${newProviders.size}</div>
                                <div class="text-sm text-blue-700">Nuevos Proveedores</div>
                            </div>
                            ${skippedCount > 0 ? `
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <div class="text-2xl font-bold text-yellow-600">${skippedCount}</div>
                                <div class="text-sm text-yellow-700">Registros Omitidos</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    document.getElementById('migrationResults').innerHTML = resultsHtml;
                    document.getElementById('migrationComplete').classList.remove('hidden');
                    document.getElementById('migrationStep3').classList.add('hidden');
                    
                    showNotification(`Migración completada: ${importedCount} transacciones importadas`, 'success');
                    
                } catch (error) {
                    hideLoading();
                    showNotification('Error durante la importación: ' + error.message, 'error');
                }
            }, 1000);
        }
        
        function finishMigration() {
            resetMigrationForm();
            showPage('list');
            loadTransactions();
        }

        // Export functions for different formats
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]).join(',');
            const csvContent = [
                headers,
                ...data.map(row => Object.values(row).map(value => `"${value}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Initialize enhanced features
        function initializeEnhancedFeatures() {
            // Start auto-save
            startAutoSave();
            
            // Check data integrity
            validateDataIntegrity();
            
            // Optimize performance
            optimizePerformance();
            
            // Set up backup reminder
            if (currentUser && currentUser.role === 'master') {
                checkBackupReminder();
            }
            
            // Initialize keyboard shortcuts help
            showNotification('💡 Atajos de teclado: Ctrl+K (Buscar), Ctrl+N (Nueva transacción), Ctrl+R (Reportes)', 'info', 8000);
        }

        // Enhanced initialization
        function enhancedInitialization() {
            // Update the original initialization
            setTimeout(() => {
                if (currentUser) {
                    initializeEnhancedFeatures();
                }
            }, 1000);
        }

        // Update the original showMainApp function to include enhanced features
        const originalShowMainApp = showMainApp;
        showMainApp = function() {
            originalShowMainApp();
            enhancedInitialization();
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', function(e) {
            stopAutoSave();
            saveAllData();
        });

        // Print functionality
        function printCurrentPage() {
            const currentPageElement = document.querySelector('.page-content:not(.hidden)');
            if (!currentPageElement) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mansión Plast C.A - ${currentPage}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .no-print { display: none; }
                        @media print {
                            body { margin: 0; }
                            .card-modern { box-shadow: none; border: 1px solid #ddd; }
                        }
                    </style>
                </head> 
                <body>
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1>Mansión Plast C.A</h1>
                        <h2>Sistema Financiero</h2>
                        <p>Fecha: ${formatDate(new Date().toISOString().split('T')[0])}</p>
                    </div>
                    ${currentPageElement.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Accessibility improvements
        function improveAccessibility() {
            // Add ARIA labels and roles where needed
            document.querySelectorAll('button').forEach(button => {
                if (!button.getAttribute('aria-label') && !button.textContent.trim()) {
                    const svg = button.querySelector('svg');
                    if (svg) {
                        button.setAttribute('aria-label', 'Botón de acción');
                    }
                }
            });
            
            // Add keyboard navigation for tables
            document.querySelectorAll('table tr').forEach((row, index) => {
                row.setAttribute('tabindex', index === 0 ? '0' : '-1');
                row.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        const firstButton = row.querySelector('button');
                        if (firstButton) {
                            firstButton.click();
                        }
                    }
                });
            });
        }

        // Call accessibility improvements after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(improveAccessibility, 1000);
        });

        // Advanced features flag
        const ADVANCED_FEATURES = {
            AUTO_BACKUP: true,
            ENHANCED_VALIDATION: true,
            PERFORMANCE_MONITORING: true,
            ACCESSIBILITY_MODE: true
        };

        // Feature toggle system
        function toggleFeature(featureName, enabled) {
            ADVANCED_FEATURES[featureName] = enabled;
            localStorage.setItem('advancedFeatures', JSON.stringify(ADVANCED_FEATURES));
            
            logAction('TOGGLE_FEATURE', `${featureName}: ${enabled ? 'enabled' : 'disabled'}`);
            showNotification(`Característica ${featureName} ${enabled ? 'activada' : 'desactivada'}`, 'info');
        }

        // Load advanced features settings
        function loadAdvancedFeatures() {
            const saved = localStorage.getItem('advancedFeatures');
            if (saved) {
                Object.assign(ADVANCED_FEATURES, JSON.parse(saved));
            }
         }
        function formatDateLocal(dateStr) {
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
        } 
            
        // Final initialization call
        loadAdvancedFeatures();

        // Console welcome message for developers
        console.log(`
        🏢 Sistema Financiero Mansión Plast C.A
        📅 Versión: 2.0 Enhanced
        🚀 Funcionalidades implementadas:
           ✅ Sistema de abonos mejorado con conversión automática
           ✅ Reportes separados por moneda (USD/VES)
           ✅ Visualización y edición de facturas
           ✅ Función master para reseteo de base de datos
           ✅ Sistema de notificaciones moderno
           ✅ Modo oscuro
           ✅ Calculadora integrada
           ✅ Historial de cambios y auditoría
           ✅ Respaldo automático
           ✅ Interfaz mejorada con efectos glassmorphism
           ✅ Atajos de teclado
           ✅ Validaciones mejoradas
           ✅ Sistema de logs completo
        
        💡 Desarrollado por Dham 2025
        `);
    </script>
</body>
</html>
